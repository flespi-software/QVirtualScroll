!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.function.name"),require("@babel/runtime-corejs2/regenerator"),require("core-js/modules/es6.array.find-index"),require("core-js/modules/web.dom.iterable"),require("core-js/modules/es6.array.iterator"),require("core-js/modules/es6.object.keys"),require("core-js/modules/es6.regexp.to-string"),require("core-js/modules/es6.object.to-string"),require("core-js/modules/es6.regexp.match"),require("regenerator-runtime/runtime"),require("core-js/library/fn/array/is-array"),require("core-js/library/fn/array/from"),require("core-js/library/fn/is-iterable"),require("core-js/library/fn/promise"),require("lodash/get")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.function.name","@babel/runtime-corejs2/regenerator","core-js/modules/es6.array.find-index","core-js/modules/web.dom.iterable","core-js/modules/es6.array.iterator","core-js/modules/es6.object.keys","core-js/modules/es6.regexp.to-string","core-js/modules/es6.object.to-string","core-js/modules/es6.regexp.match","regenerator-runtime/runtime","core-js/library/fn/array/is-array","core-js/library/fn/array/from","core-js/library/fn/is-iterable","core-js/library/fn/promise","lodash/get"],t):t((e=e||self).devicesMessages={},null,e._regeneratorRuntime,null,null,null,null,null,null,null,null,e.isArray$1,e.from,e.isIterable$1,e.promise$1,e._get)}(this,function(e,t,k,r,n,s,a,o,i,c,u,l,f,m,p,h){"use strict";k=k&&k.hasOwnProperty("default")?k.default:k,l=l&&l.hasOwnProperty("default")?l.default:l,f=f&&f.hasOwnProperty("default")?f.default:f,m=m&&m.hasOwnProperty("default")?m.default:m,p=p&&p.hasOwnProperty("default")?p.default:p,h=h&&h.hasOwnProperty("default")?h.default:h;var d=l;var g=function(e){if(d(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}},v=f,y=m;var w=function(e){if(y(Object(e))||"[object Arguments]"===Object.prototype.toString.call(e))return v(e)};var b=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var _=function(e){return g(e)||w(e)||b()},x=p;function S(e,t,r,n,s,a,o){try{var i=e[a](o),c=i.value}catch(e){return void r(e)}i.done?t(c):x.resolve(c).then(n,s)}var D=function(i){return function(){var e=this,o=arguments;return new x(function(t,r){var n=i.apply(e,o);function s(e){S(n,t,r,s,a,"next",e)}function a(e){S(n,t,r,s,a,"throw",e)}s(void 0)})}};function j(e){var x=e.Vue,S=e.LocalStorage,j=e.errorHandler;function c(e){var t={};return e.limit&&(t.count=e.limit),e.filter&&0===e.mode&&(t.filter="".concat(e.filter)),!e.from||e.reverse&&1!==e.mode||e.reverse||(t.from=Math.floor(e.from/1e3)),e.to&&(1===e.mode&&(e.to=Date.now()),t.to=Math.floor(e.to/1e3)),e.reverse&&(t.reverse=e.reverse),t}function M(e){e.errors&&e.errors.forEach(function(e){var t=new Error(e.reason);j&&j(t)})}function t(){return(t=D(k.mark(function e(t){var r,n,s,a,o,i,c,u,l,f,m,p,d,g,v,h,y,w,b;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,s=t.rootState,a=["timestamp","position.latitude","position.longitude","position.altitude","position.speed"],n("reqStart"),s.token&&r.active)return e.prev=4,x.set(r,"isLoading",!0),e.next=8,x.connector.gw.getDevicesTelemetry(r.active);e.next=49;break;case 8:return o=e.sent,M(i=o.data),c=i.result&&i.result[0]&&i.result[0].telemetry,e.next=14,x.connector.gw.getDevices(r.active);case 14:if(u=e.sent,M(l=u.data),f=l.result&&l.result[0],n("setSettings",f),m=[],!((p=S.getItem(r.name))&&p[f.device_type_id]&&p[f.device_type_id].length)){e.next=25;break}p[f.device_type_id].forEach(function(e){if("timestamp"===e.name){var t=(new Date).toString().match(/([-+][0-9]+)\s/)[1];e.addition="".concat(t.slice(0,3),":").concat(t.slice(3))}}),m=p[f.device_type_id],e.next=40;break;case 25:if(f.device_type_id)return e.next=28,x.connector.gw.getProtocolsDeviceTypes("all",f.device_type_id,{fields:"protocol_id"});e.next=40;break;case 28:return d=e.sent,M(g=d.data),v=g.result&&g.result[0]&&g.result[0].protocol_id,e.next=34,x.connector.gw.getProtocols(v,{fields:"message_parameters"});case 34:h=e.sent,M(y=h.data),w=y.result&&y.result[0]&&y.result[0].message_parameters,m=w.reduce(function(e,t){var r=t.name;if("timestamp"!==r)return e.push({name:r,width:150,display:!1}),e;var n=(new Date).toString().match(/([-+][0-9]+)\s/)[1];return e.unshift({name:r,width:190,display:!1,addition:"".concat(n.slice(0,3),":").concat(n.slice(3))}),e},[]),c?(c.position&&delete c.position,b=Object.keys(c),m.length&&b&&m.forEach(function(e){c[e.name]&&(e.display=!0)})):m=a.reduce(function(e,t){var r=e.findIndex(function(e){return e.name===t});return-1===r?e.push({name:t,width:150,display:!0}):e[r].display=!0,e},m);case 40:c?n("setCols",m):x.set(r,"cols",m),x.set(r,"isLoading",!1),e.next=49;break;case 44:e.prev=44,e.t0=e.catch(4),j&&j(e.t0),DEV&&console.log(e.t0),x.set(r,"isLoading",!1);case 49:case"end":return e.stop()}},e,null,[[4,44]])}))).apply(this,arguments)}function r(){return(r=D(k.mark(function e(n){var s,a,o,i,c,u,l;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=n.state,a=n.commit,n.rootState.token&&s.active)return e.prev=2,x.set(s,"isLoading",!0),o={reverse:!0,count:1,fields:"timestamp"},e.next=7,x.connector.gw.getDevicesMessages(s.active,{data:JSON.stringify(o)});e.next=23;break;case 7:i=e.sent,M(c=i.data),u=Date.now(),c.result.length&&(u=Math.round(1e3*c.result[0].timestamp)),void 0,t=u||Date.now(),r=new Date(t).setHours(0,0,0,0),a("setFrom",(l={from:r,to:r+86399999}).from),a("setTo",l.to),x.set(s,"isLoading",!1),e.next=23;break;case 18:e.prev=18,e.t0=e.catch(2),j&&j(e.t0),DEV&&console.log(e.t0),x.set(s,"isLoading",!1);case 23:case"end":return e.stop()}var t,r},e,null,[[2,18]])}))).apply(this,arguments)}function u(e,t){return n.apply(this,arguments)}function n(){return(n=D(k.mark(function e(t,r){var n,s,a,o,i,c;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.state,s=t.commit,a=t.rootState,s("reqStart"),a.token&&n.active)return e.prev=3,x.set(n,"isLoading",!0),o=JSON.parse(JSON.stringify(n.mode)),e.next=8,x.connector.gw.getDevicesMessages(n.active,{data:JSON.stringify(r)});e.next=22;break;case 8:if(i=e.sent,o!==n.mode)return e.abrupt("return",!1);e.next=11;break;case 11:return M(c=i.data),x.set(n,"isLoading",!1),e.abrupt("return",c.result);case 17:e.prev=17,e.t0=e.catch(3),j&&j(e.t0),DEV&&console.log(e.t0),x.set(n,"isLoading",!1);case 22:case"end":return e.stop()}},e,null,[[3,17]])}))).apply(this,arguments)}function l(e){return s.apply(this,arguments)}function s(){return(s=D(k.mark(function e(t){var r,n,s,a;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,n=t.commit,s=t.rootState,e.next=3,u({state:r,commit:n,rootState:s},c(r));case 3:a=e.sent,n("setMessages",a);case 5:case"end":return e.stop()}},e)}))).apply(this,arguments)}function a(){return(a=D(k.mark(function e(t){var r,n,s,a,o,i;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,s=t.rootState,r.isLoading){e.next=11;break}return a=Math.floor(h(r,"messages[0].timestamp",r.to)-1),(o=c(r)).to=a,o.reverse=!0,e.next=8,u({state:r,commit:n,rootState:s},o);case 8:return i=e.sent,n("prependMessages",i),e.abrupt("return",i.length);case 11:case"end":return e.stop()}},e)}))).apply(this,arguments)}function o(){return(o=D(k.mark(function e(t){var r,n,s,a,o,i;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,s=t.rootState,r.isLoading){e.next=10;break}return a=Math.floor(h(r,"messages[".concat(r.messages.length-1,"].timestamp"),r.from)+1),(o=c(r)).from=a,e.next=7,u({state:r,commit:n,rootState:s},o);case 7:return i=e.sent,n("appendMessages",i),e.abrupt("return",i.length);case 10:case"end":return e.stop()}},e)}))).apply(this,arguments)}function i(){return(i=D(k.mark(function e(t,r){var n,s,a,o,i;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.state,s=t.commit,a=t.rootState,o=n.limit,i=n.filter,s("setReverse",!0),s("setLimit",r),s("setFilter",""),e.next=7,l({state:n,commit:s,rootState:a});case 7:s("setReverse",!1),s("setLimit",o),s("setFilter",i);case 10:case"end":return e.stop()}},e)}))).apply(this,arguments)}var f=[],m=0;function p(e,t){return setInterval(function(){f.length&&(1===e.mode&&t("setMessages",_(f)),f=[])},500)}function d(){return(d=D(k.mark(function e(t){var r,n;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,n=t.commit,t.rootState,m=p(r,n),e.next=4,x.connector.subscribeMessagesDevices(r.active,function(e){1===r.mode&&f.push(JSON.parse(e))},{rh:2});case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}function g(){return(g=D(k.mark(function e(t){var r;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,m&&clearInterval(m),e.next=4,x.connector.unsubscribeMessagesDevices(r.active);case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}function v(){return(v=D(k.mark(function e(t){var r,n,s,a,o,i;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,t.rootState.token&&r.active)return e.prev=2,x.set(r,"isLoading",!0),s=r.messages.reduceRight(function(e,t,r){return e||("offline"===t.__connectionStatus&&(e=r),e)},0),a={from:s?Math.floor(r.messages[s-1].timestamp)+1:0,to:Math.floor(r.messages[s+1].timestamp)},e.next=8,x.connector.gw.getDevicesMessages(r.active,{data:JSON.stringify(a)});e.next=20;break;case 8:o=e.sent,M(i=o.data),n("setMissingMessages",{data:i.result,index:s}),x.set(r,"isLoading",!1),e.next=20;break;case 15:e.prev=15,e.t0=e.catch(2),j&&j(e.t0),DEV&&console.log(e.t0),x.set(r,"isLoading",!1);case 20:case"end":return e.stop()}},e,null,[[2,15]])}))).apply(this,arguments)}return{getMessages:u,get:l,getPrevPage:function(e){return a.apply(this,arguments)},getNextPage:function(e){return o.apply(this,arguments)},pollingGet:function(e){return d.apply(this,arguments)},getCols:function(e){return t.apply(this,arguments)},getHistory:function(e,t){return i.apply(this,arguments)},initTime:function(e){return r.apply(this,arguments)},unsubscribePooling:function(e){return g.apply(this,arguments)},getMissedMessages:function(e){return v.apply(this,arguments)}}}function M(e){var l=e.Vue,n=e.LocalStorage,f=e.filterHandler,m=e.newMessagesInterseptor;function s(e){var t=e||Date.now(),r=new Date(t).setHours(0,0,0,0);return{from:r,to:r+864e5}}function r(e,t){1===e.mode?function(e,t){if(t&&t.length){e.reverse&&(t.reverse(),t[t.length-1].delimiter=!0),l.set(e,"from",Math.floor(1e3*(t[t.length-1].timestamp+1))),e.filter&&f&&(t=f(e.filter,t));var r=e.messages;if(e.sortBy)if(1<t.length)r=r.concat(t);else{var n=t[0],s=e.sortBy,a=e.messages.length-1,o=null,i=!0;if(0<a)for(var c=a;0!==c||i;c--)r[c][s]>n[s]?0===(o=c)&&(i=!1):i=!1;o?r.splice(o,0,n):r.push(n)}else r=r.concat(t);if(m&&m(t),e.limit&&r.length>=e.limit+.1*e.limit){var u=r.length-1-(e.limit-1);r=r.slice(u),l.set(e,"selected",e.selected.map(function(e){return e-u}))}l.set(e,"messages",r)}else l.set(e,"from",e.to+1e3)}(e,t):function(e,t){if(t&&t.length){e.reverse&&t.reverse();var r=e.messages;r=r.concat(t),m&&m(t),l.set(e,"messages",r)}else l.set(e,"messages",[])}(e,t)}function a(e){l.set(e,"messages",[]),m&&m([]),i(e)}function t(){return(t=D(k.mark(function e(t){return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a(t),t.filter="",t.mode=null,t.from=0,t.to=0,t.limit=1e3,t.reverse=!1,e.next=9,l.connector.unsubscribeMessagesDevices(t.active);case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}function o(e,t){var r=n.getItem(e.name);(r=r||{})[e.settings.device_type_id]=t,n.set(e.name,r),l.set(e,"cols",t)}function i(e){l.set(e,"selected",[])}return{setOffline:function(e,t){t&&r(e,[{__connectionStatus:"offline",timestamp:Date.now()/1e3}]),e.offline=!0},setReconnected:function(e,t){t&&r(e,[{__connectionStatus:"reconnected",timestamp:Date.now()/1e3}]),e.offline=!1},setMissingMessages:function(e,t){var r,n=t.data,s=t.index;n.forEach(function(e){e.__status="missed"}),(r=e.messages).splice.apply(r,[s+1,0].concat(_(n)))},setMessages:r,prependMessages:function(e,t){if(t&&t.length){t.reverse();var r=e.messages;if(m&&m(t),r.splice.apply(r,[0,0].concat(_(t))),e.limit&&3*e.limit<r.length){var n=3*e.limit,s=r.length-n;r.splice(r.length-s,s)}}},appendMessages:function(e,t){if(t&&t.length){var r=e.messages;if(m&&m(t),r.splice.apply(r,[r.length,0].concat(_(t))),e.limit&&3*e.limit<r.length){var n=3*e.limit;r.splice(0,r.length-n)}}},clearMessages:a,setLimit:function(e,t){l.set(e,"limit",t)},setFilter:function(e,t){e.filter!==t&&(1===e.mode&&(e.filter&&e.messages.push({"x-flespi-filter-prev":e.filter}),t&&e.messages.push({"x-flespi-filter-next":t})),l.set(e,"filter",t))},setMode:function(e,t){switch(t){case 0:var r=e.from?s(e.from):s();e.from=r.from,e.to=r.to,a(e);break;case 1:var n=Date.now()-4e3;e.from=n-1e3,e.to=n}l.set(e,"mode",t)},setFrom:function(e,t){l.set(e,"from",t)},setTo:function(e,t){l.set(e,"to",t)},reqStart:function(){DEV&&console.log("Start Request Devices messages")},setReverse:function(e,t){l.set(e,"reverse",t)},clear:function(e){return t.apply(this,arguments)},setActive:function(e,t){l.set(e,"active",t)},setCols:o,updateCols:o,setSelected:function(e,t){l.set(e,"selected",t)},clearSelected:i,setSortBy:function(e,t){l.set(e,"sortBy",t)},clearSortBy:function(e){l.set(e,"sortBy",null)},setSettings:function(e,t){l.set(e,"settings",t)}}}e.default=function(e){var t=e.Vue,r=e.LocalStorage,n=e.name,s=e.errorHandler,a=e.filterHandler,o=e.newMessagesInterseptor;return{namespaced:!0,state:{name:n,isLoading:!1,active:0,messages:[],filter:"",settings:{},mode:null,from:0,to:0,limit:1e3,reverse:!1,cols:[],offline:!1,selected:[],sortBy:null},actions:j({Vue:t,LocalStorage:r,errorHandler:s}),mutations:M({Vue:t,LocalStorage:r,filterHandler:a,newMessagesInterseptor:o})}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=devicesMessages.js.map
