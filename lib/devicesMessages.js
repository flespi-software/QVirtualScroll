!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.function.name"),require("core-js/library/fn/array/is-array"),require("core-js/library/fn/array/from"),require("core-js/library/fn/is-iterable"),require("@babel/runtime-corejs2/regenerator"),require("core-js/modules/es6.array.find-index"),require("core-js/modules/web.dom.iterable"),require("core-js/modules/es6.array.iterator"),require("core-js/modules/es6.object.keys"),require("core-js/modules/es6.regexp.to-string"),require("core-js/modules/es6.object.to-string"),require("core-js/modules/es6.regexp.match"),require("regenerator-runtime/runtime")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.function.name","core-js/library/fn/array/is-array","core-js/library/fn/array/from","core-js/library/fn/is-iterable","@babel/runtime-corejs2/regenerator","core-js/modules/es6.array.find-index","core-js/modules/web.dom.iterable","core-js/modules/es6.array.iterator","core-js/modules/es6.object.keys","core-js/modules/es6.regexp.to-string","core-js/modules/es6.object.to-string","core-js/modules/es6.regexp.match","regenerator-runtime/runtime"],t):t((e=e||self).devicesMessages={},null,e.isArray$1,e.from,e.isIterable$1,e._regeneratorRuntime)}(this,function(e,t,r,s,n,_){"use strict";r=r&&r.hasOwnProperty("default")?r.default:r,s=s&&s.hasOwnProperty("default")?s.default:s,n=n&&n.hasOwnProperty("default")?n.default:n,_=_&&_.hasOwnProperty("default")?_.default:_;var o=r;var a=function(e){if(o(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}},i=s,c=n;var l=function(e){if(c(Object(e))||"[object Arguments]"===Object.prototype.toString.call(e))return i(e)};var u=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var g=function(e){return a(e)||l(e)||u()};function f(e){var x=e.Vue,M=e.LocalStorage,S=e.errorHandler;function j(e){e.errors&&e.errors.forEach(function(e){var t=new Error(e.reason);S&&S(t)})}function d(s,n){var o,a,i,c,l,u,f,m;return _.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=s.state,a=s.commit,i=s.rootState,a("reqStart"),n&&(c=n.name,l=n.payload,a("clearMessages"),a(c,l)),i.token&&o.active)return e.prev=4,x.set(o,"isLoading",!0),u=JSON.parse(JSON.stringify(o.mode)),e.next=9,_.awrap(x.connector.gw.getDevicesMessages(o.active,{data:JSON.stringify((t=o,r=void 0,r={},t.limit&&(r.count=t.limit),t.filter&&t.sysFilter?1===t.mode?r.filter="".concat(t.sysFilter):r.filter="".concat(t.sysFilter,",").concat(t.filter):t.sysFilter&&!t.filter?r.filter="".concat(t.sysFilter):!t.sysFilter&&t.filter&&0===t.mode&&(r.filter="".concat(t.filter)),!t.from||t.reverse&&1!==t.mode||t.reverse||(r.from=Math.floor(t.from/1e3)),t.to&&(1===t.mode&&(t.to=Date.now()),r.to=Math.floor(t.to/1e3)),t.reverse&&(r.reverse=t.reverse),r))}));e.next=46;break;case 9:if(f=e.sent,u!==o.mode)return e.abrupt("return",!1);e.next=12;break;case 12:if(j(m=f.data),!n){e.next=37;break}if(!m.result.length){e.next=20;break}a("setMessages",m.result),a("postaction"),e.next=35;break;case 20:a("postaction"),e.t0=n.name,e.next="paginationPrev"===e.t0?24:"paginationNext"===e.t0?30:33;break;case 24:return a("datePrev"),a("paginationPrev"),e.next=28,_.awrap(d({state:o,commit:a,rootState:i}));case 28:return a("postaction"),e.abrupt("break",35);case 30:return d({state:o,commit:a,rootState:i},{name:"dateNext"}),a("postaction"),e.abrupt("break",35);case 33:a("setMessages",m.result),a("postaction");case 35:e.next=38;break;case 37:a("setMessages",m.result);case 38:x.set(o,"isLoading",!1),e.next=46;break;case 41:e.prev=41,e.t1=e.catch(4),S&&S(e.t1),DEV&&console.log(e.t1),x.set(o,"isLoading",!1);case 46:case"end":return e.stop()}var t,r},null,null,[[4,41]])}var n=[],o=0;function a(e,t){return setInterval(function(){n.length&&(1===e.mode&&t("setMessages",g(n)),n=[])},500)}return{get:d,pollingGet:function(t){var r,s;return _.async(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,s=t.commit,t.rootState,o=a(r,s),e.next=4,_.awrap(x.connector.subscribeMessagesDevices(r.active,function(e){1===r.mode?n.push(JSON.parse(e)):s("setNewMessagesCount",r.newMessagesCount+1)},{rh:2}));case 4:case"end":return e.stop()}})},getCols:function(t){var r,s,n,o,a,i,c,l,u,f,m,d,g,p,v,y,w,b,h;return _.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,s=t.commit,n=t.rootState,o=["timestamp","position.latitude","position.longitude","position.altitude","position.speed"],s("reqStart"),n.token&&r.active)return e.prev=4,x.set(r,"isLoading",!0),e.next=8,_.awrap(x.connector.gw.getDevicesTelemetry(r.active));e.next=49;break;case 8:return a=e.sent,j(i=a.data),c=i.result&&i.result[0]&&i.result[0].telemetry,e.next=14,_.awrap(x.connector.gw.getDevices(r.active));case 14:if(l=e.sent,j(u=l.data),f=u.result&&u.result[0],s("setSettings",f),m=[],!((d=M.getItem(r.name))&&d[f.device_type_id]&&d[f.device_type_id].length)){e.next=25;break}d[f.device_type_id].forEach(function(e){if("timestamp"===e.name){var t=(new Date).toString().match(/([-\+][0-9]+)\s/)[1];e.addition="".concat(t.slice(0,3),":").concat(t.slice(3))}}),m=d[f.device_type_id],e.next=40;break;case 25:if(f.device_type_id)return e.next=28,_.awrap(x.connector.gw.getProtocolsDeviceTypes("all",f.device_type_id,{fields:"protocol_id"}));e.next=40;break;case 28:return g=e.sent,j(p=g.data),v=p.result&&p.result[0]&&p.result[0].protocol_id,e.next=34,_.awrap(x.connector.gw.getProtocols(v,{fields:"message_parameters"}));case 34:y=e.sent,j(w=y.data),b=w.result&&w.result[0]&&w.result[0].message_parameters,m=b.reduce(function(e,t){var r=t.name;if("timestamp"!==r)return e.push({name:r,width:150,display:!1}),e;var s=(new Date).toString().match(/([-\+][0-9]+)\s/)[1];return e.unshift({name:r,width:190,display:!1,addition:"".concat(s.slice(0,3),":").concat(s.slice(3))}),e},[]),c?(c.position&&delete c.position,h=Object.keys(c),m.length&&h&&m.forEach(function(e){c[e.name]&&(e.display=!0)})):m=o.reduce(function(e,t){var r=e.findIndex(function(e){return e.name===t});return-1===r?e.push({name:t,width:150,display:!0}):e[r].display=!0,e},m);case 40:c?s("setCols",m):x.set(r,"cols",m),x.set(r,"isLoading",!1),e.next=49;break;case 44:e.prev=44,e.t0=e.catch(4),S&&S(e.t0),DEV&&console.log(e.t0),x.set(r,"isLoading",!1);case 49:case"end":return e.stop()}},null,null,[[4,44]])},getHistory:function(t,r){var s,n,o,a,i;return _.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.state,n=t.commit,o=t.rootState,a=s.limit,i=s.filter,n("setReverse",!0),n("setLimit",r),n("setFilter",""),e.next=7,_.awrap(d({state:s,commit:n,rootState:o}));case 7:n("setReverse",!1),n("setLimit",a),n("setFilter",i);case 10:case"end":return e.stop()}})},initTime:function(s){var n,o,a,i,c,l;return _.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=s.state,o=s.commit,s.rootState.token&&n.active)return e.prev=2,x.set(n,"isLoading",!0),a={reverse:!0,count:1,fields:"timestamp"},e.next=7,_.awrap(x.connector.gw.getDevicesMessages(n.active,{data:JSON.stringify(a)}));e.next=21;break;case 7:i=e.sent,j(c=i.data),l=Date.now(),c.result.length&&(l=Math.round(1e3*c.result[0].timestamp)),o("setDate",(void 0,t=l||Date.now(),{from:r=new Date(t).setHours(0,0,0,0),to:r+864e5}).from),x.set(n,"isLoading",!1),e.next=21;break;case 16:e.prev=16,e.t0=e.catch(2),S&&S(e.t0),DEV&&console.log(e.t0),x.set(n,"isLoading",!1);case 21:case"end":return e.stop()}var t,r},null,null,[[2,16]])},unsubscribePooling:function(t){var r;return _.async(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,o&&clearInterval(o),e.next=4,_.awrap(x.connector.unsubscribeMessagesDevices(r.active));case 4:case"end":return e.stop()}})},getMissedMessages:function(t){var r,s,n,o,a,i;return _.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,s=t.commit,t.rootState.token&&r.active)return e.prev=2,x.set(r,"isLoading",!0),n=r.messages.reduceRight(function(e,t,r){return e||("offline"===t.__connectionStatus&&(e=r),e)},0),o={from:n?Math.floor(r.messages[n-1].timestamp)+1:0,to:Math.floor(r.messages[n+1].timestamp)},e.next=8,_.awrap(x.connector.gw.getDevicesMessages(r.active,{data:JSON.stringify(o)}));e.next=20;break;case 8:a=e.sent,j(i=a.data),s("setMissingMessages",{data:i.result,index:n}),x.set(r,"isLoading",!1),e.next=20;break;case 15:e.prev=15,e.t0=e.catch(2),S&&S(e.t0),DEV&&console.log(e.t0),x.set(r,"isLoading",!1);case 20:case"end":return e.stop()}},null,null,[[2,15]])}}}function m(e){var u=e.Vue,s=e.LocalStorage,f=e.filterHandler,m=e.newMessagesInterseptor;function n(e){var t=e||Date.now(),r=new Date(t).setHours(0,0,0,0);return{from:r,to:r+864e5}}function r(e,t){if(t&&t.length){e.reverse&&(t.reverse(),1===e.mode&&(t[t.length-1].delimiter=!0)),1===e.mode&&(u.set(e,"from",Math.floor(1e3*(t[t.length-1].timestamp+1))),e.filter&&f&&(t=f(e.filter,t)));var r=e.messages;if(e.sortBy&&1===e.mode)if(1<t.length)r=r.concat(t);else{var s=t[0],n=e.sortBy,o=e.messages.length-1,a=null,i=!0;if(0<o)for(var c=o;0!==c||i;c--)r[c][n]>s[n]?0===(a=c)&&(i=!1):i=!1;a?r.splice(a,0,s):r.push(s)}else r=r.concat(t);if(m&&m(t),e.limit&&1===e.mode&&r.length>=e.limit+.1*e.limit){var l=r.length-1-(e.limit-1);r=r.slice(l),u.set(e,"selected",e.selected.map(function(e){return e-l}))}u.set(e,"messages",r)}else 1===e.mode&&u.set(e,"from",e.to+1e3),u.set(e,"messages",[])}function o(e){u.set(e,"messages",[]),m&&m([]),l(e)}function a(e,t){u.set(e,"from",t)}function i(e,t){u.set(e,"to",t)}function c(e,t){u.set(e,"reverse",t)}function t(e,t){var r=s.getItem(e.name);(r=r||{})[e.settings.device_type_id]=t,s.set(e.name,r),u.set(e,"cols",t)}function l(e){u.set(e,"selected",[])}return{setOffline:function(e,t){t&&r(e,[{__connectionStatus:"offline",timestamp:Date.now()/1e3}]),e.offline=!0},setReconnected:function(e,t){t&&r(e,[{__connectionStatus:"reconnected",timestamp:Date.now()/1e3}]),e.offline=!1},setMissingMessages:function(e,t){var r,s=t.data,n=t.index;s.forEach(function(e){e.__status="missed"}),(r=e.messages).splice.apply(r,[n+1,0].concat(g(s)))},setMessages:r,clearMessages:o,setLimit:function(e,t){u.set(e,"limit",t)},setFilter:function(e,t){e.filter!==t&&(1===e.mode&&(e.filter&&e.messages.push({"x-flespi-filter-prev":e.filter}),t&&e.messages.push({"x-flespi-filter-next":t})),u.set(e,"filter",t))},setMode:function(e,t){switch(t){case 0:var r=e.from?n(e.from):n();e.from=r.from,e.to=r.to,o(e);break;case 1:var s=Date.now()-4e3;e.from=s-1e3,e.to=s,e.newMessagesCount=0}u.set(e,"mode",t)},setFrom:a,setTo:i,reqStart:function(){DEV&&console.log("Start Request Devices messages")},setReverse:c,dateNext:function(e){var t=n(e.from+864e5);e.from=t.from,e.to=t.to},datePrev:function(e){var t=n(e.from-864e5);e.from=t.from,e.to=t.to},paginationPrev:function(e,t){e.reverse=!0,e.sysFilter+="timestamp>=".concat(n(e.from).from/1e3),t&&(e.from=n(t).from,e.to=t-1e3)},paginationNext:function(e,t){e.sysFilter+="timestamp<=".concat(e.to/1e3),t&&(e.to=n(t).to,e.from=t+1e3)},setDate:function(e,t){var r=n(t);e.from=r.from,e.to=r.to},postaction:function(e){var t=n(e.from);a(e,e.from||t.from),i(e,t.to),e.reverse&&c(e,!1),e.sysFilter=""},clear:function(t){return _.async(function(e){for(;;)switch(e.prev=e.next){case 0:return o(t),t.filter="",t.mode=null,t.from=0,t.to=0,t.limit=1e3,t.reverse=!1,e.next=9,_.awrap(u.connector.unsubscribeMessagesDevices(t.active));case 9:case"end":return e.stop()}})},setActive:function(e,t){e.newMessagesCount=0,u.set(e,"active",t)},setCols:t,updateCols:t,setNewMessagesCount:function(e,t){u.set(e,"newMessagesCount",t)},setSelected:function(e,t){u.set(e,"selected",t)},clearSelected:l,setSortBy:function(e,t){u.set(e,"sortBy",t)},clearSortBy:function(e){u.set(e,"sortBy",null)},setSettings:function(e,t){u.set(e,"settings",t)}}}e.default=function(e){var t=e.Vue,r=e.LocalStorage,s=e.name,n=e.errorHandler,o=e.filterHandler,a=e.newMessagesInterseptor;return{namespaced:!0,state:{name:s,isLoading:!1,active:0,messages:[],filter:"",sysFilter:"",settings:{},mode:null,from:0,to:0,limit:1e3,reverse:!1,cols:[],newMessagesCount:0,offline:!1,selected:[],sortBy:null},actions:f({Vue:t,LocalStorage:r,errorHandler:n}),mutations:m({Vue:t,LocalStorage:r,filterHandler:o,newMessagesInterseptor:a})}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=devicesMessages.js.map
