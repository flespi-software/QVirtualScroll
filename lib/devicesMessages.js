!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es.array.push.js"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es.array.push.js","lodash/get","lodash/set"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).devicesMessages={},null,e._get,e._set)}(this,(function(e,t,s,i){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=o(s),a=o(i);function c(e,t,s){let i={};if(t){const o=t.split("."),a=o.shift(),c=`${o.join(".")}.${s}`,r=e.getItem(a);i=n.default(r,c,i)}else i=e.getItem(s)||i;return i}const r=["timestamp","server.timestamp","ident","position.latitude","position.longitude","position.altitude","position.speed"];function l({Vue:e,LocalStorage:t,errorHandler:s,logger:i}){function o(e){const t={};return e.limit&&(t.count=e.limit),e.filter&&(t.filter=`${e.filter}`),e.from&&(t.from=e.from/1e3),e.to&&(t.to=e.to/1e3),e.reverse&&(t.reverse=e.reverse),t}function a(e,t){t.errors?(e("reqError",t.errors),t.errors.forEach((e=>{const t=new Error(e.reason);s&&s(t)}))):e("reqFullfiled")}function l(){const e=(new Date).toString().match(/([-+][0-9]+)\s/)[1];return r.reduce(((t,s)=>(t[s]={name:s},s.match(/timestamp$/)&&(t[s].addition=`${e.slice(0,3)}:${e.slice(3)}`,t[s].type="",t[s].unit=""),t)),{})}async function m({state:t,commit:i,rootState:o},n){let c=[];if(o.token&&t.active){const o=t.isLoading;try{!o&&e.set(t,"isLoading",!0);const s=await e.connector.gw.getDevicesMessages(t.active,{data:JSON.stringify(n)});i("reqStart",{endpoint:"getDevicesMessages",active:t.active,data:JSON.stringify(n)});const r=s.data;a(i,r),!o&&e.set(t,"isLoading",!1),c=r.result||[]}catch(i){s&&s(i),DEV&&console.log(i),!o&&e.set(t,"isLoading",!1)}}return c}async function g({state:e,commit:t,rootState:s},i){const n={...o(e),from:e.from/1e3,to:i,reverse:!0,count:e.limit/2},a=await m({state:e,commit:t,rootState:s},n),c={from:i+1e-6,to:e.to/1e3,count:e.limit-a.length},r=await m({state:e,commit:t,rootState:s},c);return[...a.reverse(),...r]}async function f({state:t,commit:s,rootState:i},n){if(!t.isLoading){e.set(t,"isLoading",!0),d&&await h({state:t,commit:s,rootState:i});const a=(Date.now()+999e-6)/1e3;let c=0,r=[];const l=o(t);r=n?await g({state:t,commit:s,rootState:i},n):await m({state:t,commit:s,rootState:i},l),c+=r.length;const f=(Date.now()+999e-6)/1e3,u=l.to>=f&&t.limit&&r.length<t.limit&&!d;let v=()=>{};if(u){if(v=await p({state:t,commit:s,rootState:i}),n){const e=(Date.now()+999e-6)/1e3,n=o(t);n.from=a,n.to=e;const l=await m({state:t,commit:s,rootState:i},n);c+=l.length,r.splice(0,0,...l)}}else(l.to<f||t.limit&&r.length>=t.limit)&&d&&await h({state:t,commit:s,rootState:i});s("limiting",{type:"init",count:c}),s("setHistoryMessages",r),(u||t.realtimeEnabled)&&(v(),s("limiting",{type:"rt_init"})),e.set(t,"isLoading",!1)}}let u=[],d=0;async function p({state:t,commit:s,rootState:o}){const n=t.filter?`$filter/payload=${encodeURIComponent(t.filter)}`:void 0;return await e.connector.subscribeMessagesDevices(t.active,(e=>{u.push(JSON.parse(e))}),{rh:2,prefix:n}),t.realtimeEnabled=!0,i.info(`subscribed to messagesDevices ${t.active} ${n||""}`),()=>{d=function(e,t){return setInterval((()=>{u.length&&(t("setRTMessages",[...u]),u=[])}),500)}(0,s)}}async function h({state:t}){d&&(clearInterval(d),u=[],d=0);const s=t.filter?`$filter/payload=${encodeURIComponent(t.filter)}`:void 0;await e.connector.unsubscribeMessagesDevices(t.active,void 0,{prefix:s}),t.realtimeEnabled=!1,i.info(`unsubscribed to messagesDevices ${t.active} ${s||""}`)}return{getMessages:m,get:f,getPrevPage:async function({state:t,commit:s,rootState:i}){if(!t.isLoading){e.set(t,"isLoading",!0);const a=n.default(t,"messages[0].timestamp",t.to)-1e-6,c=o(t);c.to=a,c.reverse=!0,d&&t.messages.length>2*t.limit&&(await h({state:t,commit:s,rootState:i}),s("limiting",{type:"rt_deinit"}));const r=await m({state:t,commit:s,rootState:i},c);return r.length?(s("limiting",{type:"prev",count:r.length}),s("prependMessages",r),e.set(t,"isLoading",!1),r.length):(e.set(t,"isLoading",!1),0)}},getNextPage:async function({state:t,commit:s,rootState:i}){if(!t.isLoading){if(t.realtimeEnabled)return;e.set(t,"isLoading",!0);const a=Date.now(),c=n.default(t,`messages[${t.messages.length-1}].timestamp`,t.from)+1e-6,r=o(t);let l=0;r.from=c;const g=await m({state:t,commit:s,rootState:i},r);l+=g.length;const f=r.to>Math.floor(Date.now()/1e3)&&t.limit&&g.length<t.limit&&!d;let u=()=>{};if(f){u=await p({state:t,commit:s,rootState:i});const e=Date.now(),n=o(t);n.from=a/1e3,n.to=e/1e3;const c=await m({state:t,commit:s,rootState:i},n);l+=c.length,g.splice(g.length,0,...c)}return s("limiting",{type:"next",count:l}),s("appendMessages",g),f&&(u(),s("limiting",{type:"rt_init"})),e.set(t,"isLoading",!1),l}},pollingGet:p,getCols:async function({state:i,commit:o,rootState:n},m){const g=m.etc;if(n.token&&i.active)try{e.set(i,"isLoading",!0);const s=(await e.connector.gw.getDevices(i.active)).data;a(o,s);const n=s.result&&s.result[0];o("setSettings",n);let m=c(t,i.lsNamespace,i.name);const f=m&&m["custom-cols-schemas"]?m["custom-cols-schemas"]:{};m=m&&m[n.device_type_id];const u=m||{activeSchema:"_default",schemas:{_default:{name:"_default",cols:r.map((e=>({name:e,width:150})))}},enum:l()};if(u.schemas={...u.schemas,...f},u.enum||(u.enum=l()),n.device_type_id){const t=await e.connector.gw.getChannelProtocolsDeviceTypes("all",n.device_type_id,{fields:"protocol_id"});o("reqStart",{endpoint:"getChannelProtocolsDeviceTypes",active:n.device_type_id,fields:"protocol_id"});const s=t.data;a(o,s);const i=s.result&&s.result[0]&&s.result[0].protocol_id,c=await e.connector.gw.getChannelProtocols(i,{fields:"message_parameters"});o("reqStart",{endpoint:"getChannelProtocols",active:i,fields:"message_parameters"});const r=c.data;a(o,r);const l=r.result&&r.result[0]&&r.result[0].message_parameters;u.schemas._protocol={name:"_protocol",cols:[]};const m=(new Date).toString().match(/([-+][0-9]+)\s/)[1];l.forEach((e=>{const t=e.name,s={name:t,type:e.type||"",unit:e.unit||"",description:e.info||""},i={name:t,width:150};if(t.match(/timestamp$/)&&(s.addition=`${m.slice(0,3)}:${m.slice(3)}`,s.type="",s.unit="",i.width=190,"timestamp"===t))return u.schemas._protocol.cols.unshift(i),void(u.enum.timestamp=s);u.schemas._protocol.cols.push(i),u.enum[t]=s}))}g&&(n.device_type_id&&u.schemas._protocol.cols.push({name:"etc",width:150,__dest:"etc"}),!m&&u.schemas._default.cols.push({name:"etc",width:150,__dest:"etc"})),u.enum.etc={name:"etc",__dest:"etc"},o("setCols",u),e.set(i,"isLoading",!1)}catch(t){s&&s(t),DEV&&console.log(t),e.set(i,"isLoading",!1)}},getHistory:async function({state:e,commit:t,rootState:s},i){const o=e.limit;t("clearMessages"),t("setReverse",!0),t("setLimit",i),await f({state:e,commit:t,rootState:s}),t("setReverse",!1),t("setLimit",o)},getMessagesByInitTimestamp:g,initTime:async function({state:t,commit:o,rootState:n}){if(n.token&&t.active)try{e.set(t,"isLoading",!0);const s={reverse:!0,count:1,fields:"timestamp"},n=await e.connector.gw.getDevicesMessages(t.active,{data:JSON.stringify(s)});o("reqStart",{endpoint:"getDevicesMessages-initTime",active:t.active,data:JSON.stringify(s)});const c=n.data;a(o,c);let r=Date.now();c.result.length&&(r=Math.round(1e3*c.result[0].timestamp));const l=function(e){const t=e||Date.now(),s=new Date(t).setHours(0,0,0,0);return{from:s,to:s+86399999.999}}(r);o("setFrom",l.from),o("setTo",l.to),l.to<Date.now()&&await async function({state:t}){t.hasNewMessages=!1,await e.connector.subscribeMessagesDevices(t.active,(()=>{t.hasNewMessages=!0,h({state:t})}),{rh:2}),i.info(`newMessagesCheck subscribed to messagesDevice ${t.active}`)}({state:t}),e.set(t,"isLoading",!1)}catch(i){s&&s(i),DEV&&console.log(i),e.set(t,"isLoading",!1)}},unsubscribePooling:h,getMissedMessages:async function({state:t,commit:i,rootState:o}){if(o.token&&t.active)try{e.set(t,"isLoading",!0);const{start:s,end:o,lastMessageIndex:n}=t.offline,c={from:s,to:o};t.filter&&(c.data.filter=t.filter);const r=await e.connector.gw.getDevicesMessages(t.active,{data:JSON.stringify(c)});i("reqStart",{endpoint:"getDevicesMessages",active:t.active,data:JSON.stringify(c)});const l=r.data;a(i,l),i("setMissingMessages",{data:l.result,index:n}),e.set(t,"isLoading",!1)}catch(i){s&&s(i),DEV&&console.log(i),e.set(t,"isLoading",!1)}}}}function m({Vue:e,LocalStorage:t,newMessagesInterseptor:s,logger:i}){let o=0;function n(e){e.length&&e.forEach(((t,s)=>{Object.defineProperty(e[s],"x-flespi-message-key",{value:o++,enumerable:!1})}))}function r(e){e.messages.splice(0,e.messages.length),s&&s([]),g(e),i.info("clearMessages")}function l(e,{type:t,count:s}){if(!e.limit)return!1;const o=e.messages,n=e.pages;switch(t){case"init":e.pages=s?[s]:[];break;case"prev":if(!s)break;if(3===n.length){const t=n[2];e.pages=[s,...n.slice(0,-1)],o.splice(o.length-t,t)}else e.pages=[s,...n];break;case"next":{if(!s)break;const t=n.length;if(3===t){const t=n[0];e.pages=[...n.slice(1,3),s],o.splice(0,t)}else t<3&&n.push(s);break}case"rt_init":n.push(0);break;case"rt_deinit":{const e=n.pop();o.splice(o.length-e,e);break}case"rt":{const t=n.length,i=n[t-1]||0;if(i+s>e.limit)if(t>3){const t=n[0];e.pages=[...n.slice(1,-1),i+s,0],o.splice(0,t)}else e.pages=[...n.slice(0,-1),i+s,0];else e.pages[t-1]=i+s}}i.info(`limiting: ${t} - count: ${s}`)}function m(s,i){!function(e,t,s,i,o){const n=c(e,t,s)||{},{customColsSchema:r,defaultColsSchema:l}=function(e){return{customColsSchema:{...e.schemas,_default:void 0,_protocol:void 0,_unsaved:void 0},defaultColsSchema:{activeSchema:e.activeSchema,schemas:{_default:e.schemas._default,_protocol:e.schemas._protocol,_unsaved:e.schemas._unsaved}}}}(o);if(n[i]=l,n["custom-cols-schemas"]={...r},t){const i=t.split("."),o=i.shift(),c=`${i.join(".")}.${s}`,r=e.getItem(o)||{};a.default(r,c,n),e.set(o,r)}else e.set(s,n)}(t,s.lsNamespace,s.name,s.settings.device_type_id,i),e.set(s,"cols",i)}function g(t){e.set(t,"selected",[])}return{setOffline:function(e){e.offline={start:Date.now()/1e3,lastMessageIndex:e.messages.length-1},i.info("setOffline")},setReconnected:function(e){e.offline.end=Date.now()/1e3,i.info("setReconnected")},clearOfflineState:function(e){e.offline=!1},setMissingMessages:function(e,{data:t,index:s}){e.messages.splice(s+1,0,...t),i.info(`setMissingMessages: ${t.length}`)},setHistoryMessages:function(e,t){e.reverse&&t.reverse(),n(t),s&&s(t),e.messages=t,i.info(`setHistoryMessages: length: ${t.length}, reverse:${e.reverse}`)},setRTMessages:function(e,t){if(t&&t.length){n(t);const o=e.messages;if(e.sortBy){const i=t[0],n=e.sortBy,a=e.messages.length-1;let c=null,r=!0;if(a>0)for(let e=a;0!==e||r;e--)o[e][n]>i[n]?(c=e,0===e&&(r=!1)):r=!1;s&&s(t),c?o.splice(c,0,...t):o.splice(o.length,0,...t)}else s&&s(t),o.splice(o.length,0,...t);l(e,{type:"rt",count:t.length}),i.info(`setRTMessages: length: ${t.length}`)}},prependMessages:function(e,t){if(t&&t.length){t.reverse();const i=e.messages;n(t),s&&s(t),i.splice(0,0,...t)}i.info(`prependMessages: length: ${t.length}`)},appendMessages:function(e,t){if(t&&t.length){const i=e.messages;n(t),s&&s(t),i.splice(i.length,0,...t)}i.info(`appendMessages: length: ${t.length}`)},clearMessages:r,setLimit:function(t,s){e.set(t,"limit",s)},limiting:l,setFilter:function(t,s){t.filter!==s&&e.set(t,"filter",s),i.info(`setFilter: ${s}`)},setFrom:function(t,s){e.set(t,"from",s),i.info(`setFrom: ${s}`)},setTo:function(t,s){e.set(t,"to",s),i.info(`setTo: ${s}`)},reqStart:function(e,t){i.info(`reqStart: ${JSON.stringify(t)}`)},reqFullfiled:function(){i.info("reqFullfiled")},reqError:function(e,t){i.info(`reqError: ${JSON.stringify(t)}`)},setReverse:function(t,s){e.set(t,"reverse",s),i.info(`setReverse: ${s}`)},clear:async function(t){r(t),t.filter="",t.from=0,t.to=0,t.limit=1e3,t.reverse=!1,await e.connector.unsubscribeMessagesDevices(t.active),i.info("clear module"),i.info(`unsubscribeMessagesDevices ${t.active}`)},setActive:function(t,s){e.set(t,"active",s),i.info(`setActive: ${s}`)},setCols:m,updateCols:m,setSelected:function(t,s){e.set(t,"selected",s)},clearSelected:g,setSortBy:function(t,s){e.set(t,"sortBy",s)},clearSortBy:function(t){e.set(t,"sortBy",null)},setSettings:function(t,s){e.set(t,"settings",s),i.info(`setSettings: ${s}`)}}}class g{constructor(e="ModuleLogger"){this.name=`[${e}]`}extendName(e){return new g(`${this.name}[${e}]`)}info(){console.info(...Array.from(arguments).map((e=>`${this.name} ${e}`)))}error(){console.error(...Array.from(arguments).map((e=>`${this.name} ${e}`)))}warn(){console.warn(...Array.from(arguments).map((e=>`${this.name} ${e}`)))}}e.default=function({Vue:e,LocalStorage:t,name:s,errorHandler:i,newMessagesInterseptor:o}){const a=n.default(s,"lsNamespace",void 0);s=n.default(s,"name",s);const c=e.$logger?e.$logger.extendName(s):new g(s);return{namespaced:!0,state:{name:s,lsNamespace:a,isLoading:!1,active:0,messages:[],pages:[],filter:"",settings:{},realtimeEnabled:!1,from:0,to:0,limit:1e3,reverse:!1,cols:void 0,offline:!1,selected:[],sortBy:null,hasNewMessages:null},actions:l({Vue:e,LocalStorage:t,errorHandler:i,logger:c}),mutations:m({Vue:e,LocalStorage:t,newMessagesInterseptor:o,logger:c})}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=devicesMessages.js.map
