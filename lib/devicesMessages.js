!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.function.name"),require("@babel/runtime-corejs2/regenerator"),require("core-js/modules/es7.array.includes"),require("core-js/modules/es6.string.includes"),require("core-js/modules/es6.regexp.to-string"),require("core-js/modules/es6.object.to-string"),require("core-js/modules/es6.regexp.match"),require("regenerator-runtime/runtime"),require("core-js/library/fn/array/is-array"),require("core-js/library/fn/array/from"),require("core-js/library/fn/is-iterable"),require("core-js/library/fn/promise"),require("lodash/get")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.function.name","@babel/runtime-corejs2/regenerator","core-js/modules/es7.array.includes","core-js/modules/es6.string.includes","core-js/modules/es6.regexp.to-string","core-js/modules/es6.object.to-string","core-js/modules/es6.regexp.match","regenerator-runtime/runtime","core-js/library/fn/array/is-array","core-js/library/fn/array/from","core-js/library/fn/is-iterable","core-js/library/fn/promise","lodash/get"],t):t((e=e||self).devicesMessages={},0,e._regeneratorRuntime,0,0,0,0,0,0,e.isArray$1,e.from,e.isIterable$1,e.promise$1,e._get)}(this,function(e,t,S,r,s,n,a,i,o,c,u,l,f,M){"use strict";S=S&&S.hasOwnProperty("default")?S.default:S,c=c&&c.hasOwnProperty("default")?c.default:c,u=u&&u.hasOwnProperty("default")?u.default:u,l=l&&l.hasOwnProperty("default")?l.default:l,f=f&&f.hasOwnProperty("default")?f.default:f,M=M&&M.hasOwnProperty("default")?M.default:M;var p=c;var m=function(e){if(p(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}},g=u,d=l;var h=function(e){if(d(Object(e))||"[object Arguments]"===Object.prototype.toString.call(e))return g(e)};var v=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var L=function(e){return m(e)||h(e)||v()},y=f;function b(e,t,r,s,n,a,i){try{var o=e[a](i),c=o.value}catch(e){return void r(e)}o.done?t(c):y.resolve(c).then(s,n)}var j=function(o){return function(){var e=this,i=arguments;return new y(function(t,r){var s=o.apply(e,i);function n(e){b(s,t,r,n,a,"next",e)}function a(e){b(s,t,r,n,a,"throw",e)}n(void 0)})}};function x(e){var x=e.Vue,w=e.LocalStorage,_=e.errorHandler;function d(e){var t={};return e.limit&&(t.count=e.limit),e.filter&&(t.filter="".concat(e.filter)),e.from&&!e.reverse&&(t.from=Math.floor(e.from/1e3)),e.to&&(t.to=Math.floor(e.to/1e3)),e.reverse&&(t.reverse=e.reverse),t}function k(e){e.errors&&e.errors.forEach(function(e){var t=new Error(e.reason);_&&_(t)})}function r(){return(r=j(S.mark(function e(t,r){var s,n,a,i,o,c,u,l,f,p,m,g,d,h,v,y,b;return S.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.state,n=t.commit,a=t.rootState,i=s.defaultColsNames,o=r.actions,c=r.etc,n("reqStart"),a.token&&s.active)return e.prev=6,x.set(s,"isLoading",!0),e.next=10,x.connector.gw.getDevices(s.active);e.next=47;break;case 10:if(u=e.sent,k(l=u.data),f=l.result&&l.result[0],n("setSettings",f),p=[],!((m=w.getItem(s.name))&&m[f.device_type_id]&&m[f.device_type_id].length)){e.next=22;break}(p=m[f.device_type_id])[0].__dest||p[p.length-1].__dest||(p.unshift({name:"actions",width:50,display:o,__dest:"action"}),p.push({name:"etc",width:150,display:c,__dest:"etc"})),e.next=38;break;case 22:if(f.device_type_id)return e.next=25,x.connector.gw.getProtocolsDeviceTypes("all",f.device_type_id,{fields:"protocol_id"});e.next=36;break;case 25:return g=e.sent,k(d=g.data),h=d.result&&d.result[0]&&d.result[0].protocol_id,e.next=31,x.connector.gw.getProtocols(h,{fields:"message_parameters"});case 31:v=e.sent,k(y=v.data),b=y.result&&y.result[0]&&y.result[0].message_parameters,p=b.reduce(function(e,t){var r=t.name;if("timestamp"!==r)return e.push({name:r,width:150,display:i.includes(r)}),e;var s=(new Date).toString().match(/([-+][0-9]+)\s/)[1];return e.unshift({name:r,width:190,display:!0,addition:"".concat(s.slice(0,3),":").concat(s.slice(3))}),e},[]);case 36:p.unshift({name:"actions",width:50,display:o,__dest:"action"}),p.push({name:"etc",width:150,display:c,__dest:"etc"});case 38:x.set(s,"cols",p),x.set(s,"isLoading",!1),e.next=47;break;case 42:e.prev=42,e.t0=e.catch(6),_&&_(e.t0),DEV&&console.log(e.t0),x.set(s,"isLoading",!1);case 47:case"end":return e.stop()}},e,null,[[6,42]])}))).apply(this,arguments)}function t(){return(t=j(S.mark(function e(s){var n,a,i,o,c,u,l;return S.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=s.state,a=s.commit,s.rootState.token&&n.active)return e.prev=2,x.set(n,"isLoading",!0),i={reverse:!0,count:1,fields:"timestamp"},e.next=7,x.connector.gw.getDevicesMessages(n.active,{data:JSON.stringify(i)});e.next=23;break;case 7:o=e.sent,k(c=o.data),u=Date.now(),c.result.length&&(u=Math.round(1e3*c.result[0].timestamp)),0,t=u||Date.now(),r=new Date(t).setHours(0,0,0,0),a("setFrom",(l={from:r,to:r+86399999}).from),a("setTo",l.to),x.set(n,"isLoading",!1),e.next=23;break;case 18:e.prev=18,e.t0=e.catch(2),_&&_(e.t0),DEV&&console.log(e.t0),x.set(n,"isLoading",!1);case 23:case"end":return e.stop()}var t,r},e,null,[[2,18]])}))).apply(this,arguments)}function h(e,t){return s.apply(this,arguments)}function s(){return(s=j(S.mark(function e(t,r){var s,n,a,i,o,c;return S.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.state,n=t.commit,a=t.rootState,n("reqStart"),a.token&&s.active)return i=s.isLoading,e.prev=4,i||x.set(s,"isLoading",!0),e.next=8,x.connector.gw.getDevicesMessages(s.active,{data:JSON.stringify(r)});e.next=20;break;case 8:return o=e.sent,k(c=o.data),i||x.set(s,"isLoading",!1),e.abrupt("return",c.result||[]);case 15:e.prev=15,e.t0=e.catch(4),_&&_(e.t0),DEV&&console.log(e.t0),i||x.set(s,"isLoading",!1);case 20:case"end":return e.stop()}},e,null,[[4,15]])}))).apply(this,arguments)}function c(e){return n.apply(this,arguments)}function n(){return(n=j(S.mark(function e(t){var r,s,n,a,i,o,c,u,l,f,p,m,g;return S.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,s=t.commit,n=t.rootState,r.isLoading){e.next=35;break}return x.set(r,"isLoading",!0),a=Math.floor(Date.now()/1e3),i=d(r),o=0,e.next=8,h({state:r,commit:s,rootState:n},i);case 8:if(c=e.sent,o+=c.length,u=Math.floor(Date.now()/1e3),l=i.to>=u&&r.limit&&c.length<r.limit&&!v,f=function(){},l)return e.next=16,y({state:r,commit:s,rootState:n});e.next=28;break;case 16:return f=e.sent,p=Math.floor(Date.now()/1e3),(m=d(r)).from=a,m.to=p,e.next=23,h({state:r,commit:s,rootState:n},m);case 23:g=e.sent,o+=g.length,c.splice.apply(c,[c.length,0].concat(L(g))),e.next=31;break;case 28:if((i.to<u||r.limit&&c.length>=r.limit)&&v)return e.next=31,b({state:r,commit:s,rootState:n});e.next=31;break;case 31:s("limiting",{type:"init",count:o}),s("setHistoryMessages",c),(l||r.realtimeEnabled)&&(f(),s("limiting",{type:"rt_init"})),x.set(r,"isLoading",!1);case 35:case"end":return e.stop()}},e)}))).apply(this,arguments)}function a(){return(a=j(S.mark(function e(t){var r,s,n,a,i,o;return S.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,s=t.commit,n=t.rootState,r.isLoading){e.next=21;break}if(x.set(r,"isLoading",!0),a=Math.floor(M(r,"messages[0].timestamp",r.to)-1),(i=d(r)).to=a,i.reverse=!0,v&&r.messages.length>2*r.limit)return e.next=10,b({state:r,commit:s,rootState:n});e.next=11;break;case 10:s("limiting",{type:"rt_deinit"});case 11:return e.next=13,h({state:r,commit:s,rootState:n},i);case 13:if((o=e.sent).length){e.next=17;break}return x.set(r,"isLoading",!1),e.abrupt("return",0);case 17:return s("limiting",{type:"prev",count:o.length}),s("prependMessages",o),x.set(r,"isLoading",!1),e.abrupt("return",o.length);case 21:case"end":return e.stop()}},e)}))).apply(this,arguments)}function i(){return(i=j(S.mark(function e(t){var r,s,n,a,i,o,c,u,l,f,p,m,g;return S.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,s=t.commit,n=t.rootState,r.isLoading){e.next=34;break}if(r.realtimeEnabled)return e.abrupt("return");e.next=4;break;case 4:return x.set(r,"isLoading",!0),a=Date.now(),i=Math.floor(M(r,"messages[".concat(r.messages.length-1,"].timestamp"),r.from)+1),o=d(r),c=0,o.from=i,e.next=12,h({state:r,commit:s,rootState:n},o);case 12:if(u=e.sent,c+=u.length,l=o.to>Math.floor(Date.now()/1e3)&&r.limit&&u.length<r.limit&&!v,f=function(){},l)return e.next=19,y({state:r,commit:s,rootState:n});e.next=29;break;case 19:return f=e.sent,p=Date.now(),(m=d(r)).from=Math.floor(a/1e3),m.to=Math.floor(p/1e3),e.next=26,h({state:r,commit:s,rootState:n},m);case 26:g=e.sent,c+=g.length,u.splice.apply(u,[u.length,0].concat(L(g)));case 29:return s("limiting",{type:"next",count:c}),s("appendMessages",u),l&&(f(),s("limiting",{type:"rt_init"})),x.set(r,"isLoading",!1),e.abrupt("return",c);case 34:case"end":return e.stop()}},e)}))).apply(this,arguments)}function o(){return(o=j(S.mark(function e(t,r){var s,n,a,i,o;return S.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.state,n=t.commit,a=t.rootState,i=s.limit,o=s.filter,n("clearMessages"),n("setReverse",!0),n("setLimit",r),n("setFilter",""),e.next=8,c({state:s,commit:n,rootState:a});case 8:n("setReverse",!1),n("setLimit",i),n("setFilter",o);case 11:case"end":return e.stop()}},e)}))).apply(this,arguments)}var u=[],v=0;function y(e){return l.apply(this,arguments)}function l(){return(l=j(S.mark(function e(t){var r,s;return S.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,s=t.commit,t.rootState,e.next=3,x.connector.subscribeMessagesDevices(r.active,function(e){u.push(JSON.parse(e))},{rh:2});case 3:return r.realtimeEnabled=!0,e.abrupt("return",function(){var e;e=s,v=setInterval(function(){u.length&&(e("setRTMessages",L(u)),u=[])},500)});case 5:case"end":return e.stop()}},e)}))).apply(this,arguments)}function b(e){return f.apply(this,arguments)}function f(){return(f=j(S.mark(function e(t){var r;return S.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,v&&(clearInterval(v),u=[],v=0),e.next=4,x.connector.unsubscribeMessagesDevices(r.active);case 4:r.realtimeEnabled=!1;case 5:case"end":return e.stop()}},e)}))).apply(this,arguments)}function p(){return(p=j(S.mark(function e(t){var r,s,n,a,i,o;return S.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,s=t.commit,t.rootState.token&&r.active)return e.prev=2,x.set(r,"isLoading",!0),n=r.messages.reduceRight(function(e,t,r){return e||("offline"===t.__connectionStatus&&(e=r),e)},0),a={from:n?Math.floor(r.messages[n-1].timestamp)+1:0,to:Math.floor(r.messages[n+1].timestamp)},e.next=8,x.connector.gw.getDevicesMessages(r.active,{data:JSON.stringify(a)});e.next=20;break;case 8:i=e.sent,k(o=i.data),s("setMissingMessages",{data:o.result,index:n}),x.set(r,"isLoading",!1),e.next=20;break;case 15:e.prev=15,e.t0=e.catch(2),_&&_(e.t0),DEV&&console.log(e.t0),x.set(r,"isLoading",!1);case 20:case"end":return e.stop()}},e,null,[[2,15]])}))).apply(this,arguments)}return{getMessages:h,get:c,getPrevPage:function(e){return a.apply(this,arguments)},getNextPage:function(e){return i.apply(this,arguments)},pollingGet:y,getCols:function(e,t){return r.apply(this,arguments)},getHistory:function(e,t){return o.apply(this,arguments)},initTime:function(e){return t.apply(this,arguments)},unsubscribePooling:b,getMissedMessages:function(e){return p.apply(this,arguments)}}}function w(e){var s=e.Vue,n=e.LocalStorage,u=e.filterHandler,l=e.newMessagesInterseptor,a=0;function f(r){r.length&&r.forEach(function(e,t){r[t]["x-flespi-message-key"]=a++})}function r(e){e.messages.splice(0,e.messages.length),l&&l([]),c(e)}function p(e,t){var r=t.type,s=t.count;if(!e.limit)return!1;var n=e.messages,a=e.pages;switch(r){case"init":e.pages=s?[s]:[];break;case"prev":if(!s)break;if(3===a.length){var i=a[2];e.pages=[s].concat(L(a.slice(0,-1))),n.splice(n.length-i,i)}else e.pages=[s].concat(L(a));break;case"next":if(!s)break;var o=a.length;if(3===o){var c=a[0];e.pages=[].concat(L(a.slice(1,3)),[s]),n.splice(0,c)}else o<3&&a.push(s);break;case"rt_init":a.push(0);break;case"rt_deinit":var u=a.pop();n.splice(n.length-u,u);break;case"rt":var l=a.length,f=a[l-1]||0;if(f+s>e.limit)if(3<l){var p=a[0];e.pages=[].concat(L(a.slice(1,-1)),[f+s,0]),n.splice(0,p)}else e.pages=[].concat(L(a.slice(0,-1)),[f+s,0]);else e.pages[l-1]=f+s}}function t(){return(t=j(S.mark(function e(t){return S.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r(t),t.filter="",t.from=0,t.to=0,t.limit=1e3,t.reverse=!1,e.next=8,s.connector.unsubscribeMessagesDevices(t.active);case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}function i(e,t){var r=n.getItem(e.name);(r=r||{})[e.settings.device_type_id]=t,n.set(e.name,r),s.set(e,"cols",t)}var o=i;function c(e){s.set(e,"selected",[])}return{setOffline:function(e,t){t&&e.messages.push({__connectionStatus:"offline",timestamp:Date.now()/1e3}),e.offline=!0},setReconnected:function(e,t){t&&e.messages.push({__connectionStatus:"reconnected",timestamp:Date.now()/1e3}),e.offline=!1},setMissingMessages:function(e,t){var r,s=t.data,n=t.index;s.forEach(function(e){e["x-flespi-status"]="missed"}),(r=e.messages).splice.apply(r,[n+1,0].concat(L(s)))},setHistoryMessages:function(e,t){e.reverse&&t.reverse(),f(t);var r=e.messages;l&&l(t),r.splice.apply(r,[0,r.length].concat(L(t)))},setRTMessages:function(e,t){if(t&&t.length){e.filter&&u&&(t=u(e.filter,t)),f(t);var r=e.messages;if(e.sortBy){var s=t[0],n=e.sortBy,a=e.messages.length-1,i=null,o=!0;if(0<a)for(var c=a;0!==c||o;c--)!(r[c][n]>s[n]&&0!==(i=c)||!(o=!1));l&&l(t),i?r.splice.apply(r,[i,0].concat(L(t))):r.splice.apply(r,[r.length,0].concat(L(t)))}else l&&l(t),r.splice.apply(r,[r.length,0].concat(L(t)));p(e,{type:"rt",count:t.length})}},prependMessages:function(e,t){if(t&&t.length){t.reverse();var r=e.messages;f(t),l&&l(t),r.splice.apply(r,[0,0].concat(L(t)))}},appendMessages:function(e,t){if(t&&t.length){var r=e.messages;f(t),l&&l(t),r.splice.apply(r,[r.length,0].concat(L(t)))}},clearMessages:r,setLimit:function(e,t){s.set(e,"limit",t)},limiting:p,setFilter:function(e,t){e.filter!==t&&s.set(e,"filter",t)},setFrom:function(e,t){s.set(e,"from",t)},setTo:function(e,t){s.set(e,"to",t)},reqStart:function(){DEV&&console.log("Start Request Devices messages")},setReverse:function(e,t){s.set(e,"reverse",t)},clear:function(e){return t.apply(this,arguments)},setActive:function(e,t){s.set(e,"active",t)},setCols:i,updateCols:o,setDefaultCols:function(r){r.cols.forEach(function(e,t){e.__dest||(r.defaultColsNames.includes(e.name)?s.set(r.cols[t],"display",!0):s.set(r.cols[t],"display",!1))}),o(r,r.cols)},setSelected:function(e,t){s.set(e,"selected",t)},clearSelected:c,setSortBy:function(e,t){s.set(e,"sortBy",t)},clearSortBy:function(e){s.set(e,"sortBy",null)},setSettings:function(e,t){s.set(e,"settings",t)}}}e.default=function(e){var t=e.Vue,r=e.LocalStorage,s=e.name,n=e.errorHandler,a=e.filterHandler,i=e.newMessagesInterseptor;return{namespaced:!0,state:{name:s,isLoading:!1,active:0,messages:[],pages:[],filter:"",settings:{},realtimeEnabled:!1,from:0,to:0,limit:1e3,reverse:!1,cols:[],defaultColsNames:["timestamp","server.timestamp","ident","position.latitude","position.longitude","position.altitude","position.speed"],offline:!1,selected:[],sortBy:null},actions:x({Vue:t,LocalStorage:r,errorHandler:n}),mutations:w({Vue:t,LocalStorage:r,filterHandler:a,newMessagesInterseptor:i})}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=devicesMessages.js.map
