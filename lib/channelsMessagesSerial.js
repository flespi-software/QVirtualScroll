!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.function.name"),require("core-js/modules/es7.object.get-own-property-descriptors"),require("core-js/modules/es6.symbol"),require("core-js/modules/web.dom.iterable"),require("core-js/modules/es6.array.iterator"),require("core-js/modules/es6.object.keys"),require("@babel/runtime-corejs2/regenerator"),require("core-js/modules/es6.regexp.to-string"),require("core-js/modules/es6.object.to-string"),require("core-js/modules/es6.regexp.match"),require("regenerator-runtime/runtime"),require("core-js/library/fn/array/is-array"),require("core-js/library/fn/array/from"),require("core-js/library/fn/is-iterable"),require("core-js/library/fn/promise"),require("core-js/modules/es6.regexp.split"),require("core-js/library/fn/object/define-property"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.function.name","core-js/modules/es7.object.get-own-property-descriptors","core-js/modules/es6.symbol","core-js/modules/web.dom.iterable","core-js/modules/es6.array.iterator","core-js/modules/es6.object.keys","@babel/runtime-corejs2/regenerator","core-js/modules/es6.regexp.to-string","core-js/modules/es6.object.to-string","core-js/modules/es6.regexp.match","regenerator-runtime/runtime","core-js/library/fn/array/is-array","core-js/library/fn/array/from","core-js/library/fn/is-iterable","core-js/library/fn/promise","core-js/modules/es6.regexp.split","core-js/library/fn/object/define-property","lodash/get","lodash/set"],t):t((e=e||self).channelsMessagesSerial={},0,0,0,0,0,0,e._regeneratorRuntime,0,0,0,0,e.isArray$1,e.from,e.isIterable$1,e.promise$1,0,e.defineProperty$2,e._get,e.set)}(this,function(e,t,r,n,s,a,o,k,i,c,u,l,p,f,m,g,d,h,_,v){"use strict";k=k&&k.hasOwnProperty("default")?k.default:k,p=p&&p.hasOwnProperty("default")?p.default:p,f=f&&f.hasOwnProperty("default")?f.default:f,m=m&&m.hasOwnProperty("default")?m.default:m,g=g&&g.hasOwnProperty("default")?g.default:g,h=h&&h.hasOwnProperty("default")?h.default:h,_=_&&_.hasOwnProperty("default")?_.default:_,v=v&&v.hasOwnProperty("default")?v.default:v;var y=p;var b=function(e){if(y(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}},w=f,j=m;var x=function(e){if(j(Object(e))||"[object Arguments]"===Object.prototype.toString.call(e))return w(e)};var S=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var M=function(e){return b(e)||x(e)||S()},O=g;function L(e,t,r,n,s,a,o){try{var i=e[a](o),c=i.value}catch(e){return void r(e)}i.done?t(c):O.resolve(c).then(n,s)}var P=function(i){return function(){var e=this,o=arguments;return new O(function(t,r){var n=i.apply(e,o);function s(e){L(n,t,r,s,a,"next",e)}function a(e){L(n,t,r,s,a,"throw",e)}s(void 0)})}},D=h;var q=function(e,t,r){return t in e?D(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e};function E(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function C(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?E(Object(r),!0).forEach(function(e){q(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):E(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}var N=["timestamp","server.timestamp","ident","position.latitude","position.longitude","position.altitude","position.speed"];function I(e){var y=e.Vue,i=e.LocalStorage,b=e.errorHandler;function d(e){var t={};return e.limit&&(t.count=e.limit),e.filter&&(t.filter="".concat(e.filter)),e.from&&(t.from=Math.floor(e.from/1e3)),e.to&&(t.to=Math.floor(e.to/1e3)),e.reverse&&(t.reverse=e.reverse),t}function w(e){e.errors&&e.errors.forEach(function(e){var t=new Error(e.reason);b&&b(t)})}function j(e){var t={};if(e.lsNamespace){var r=i.getItem(e.name);r&&(t=r,i.remove(e.name));var n=e.lsNamespace.split("."),s=n.shift(),a="".concat(n.join("."),".").concat(e.name),o=i.getItem(s)||{};t=_(o,a,t)}else(t=i.getItem(e.name))&&"null"!==t||(t={});return t}function r(){return(r=P(k.mark(function e(n,s){var a,o,i,c,u,l,p,f,m,g,d,h,v;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.state,o=n.commit,i=n.rootState,o("reqStart"),c=s.etc,!i.token||!a.active){e.next=39;break}if(e.prev=4,y.set(a,"isLoading",!0),u=j(a),l=u&&u[a.active]?u[a.active]:{activeSchema:"_default",schemas:{_default:{name:"_default",cols:N.map(function(e){return{name:e,width:150}})}},enum:N.reduce(function(e,t){return e[t]={name:t},e},{})},p=u&&u["custom-cols-schemas"]?u["custom-cols-schemas"]:{},l.schemas=C({},l.schemas,{},p),Array.isArray(l)&&(t=l,r=void 0,r={activeSchema:"_default",schemas:{_default:{name:"_default",cols:N.map(function(e){return{name:e,width:150}})},_protocol:{name:"_protocol",cols:t.reduce(function(e,t){return t.custom||e.push({name:t.name,width:150}),e},[])}},enum:{}},t.length&&(r.activeSchema="custom preset",r.schemas["custom preset"]={name:"custom preset",cols:t.reduce(function(e,t){return t.display&&e.push({name:t.name,width:t.width}),e},[])},r.enum=t.reduce(function(e,t){return e[t.name]=C({},t),delete e[t.name].display,delete e[t.name].width,e},{})),o("setColsToLS",l=r)),f=!l.enum||void 0===_(l.enum,"timestamp.unit",void 0),"action"===_(l.enum,"action.__dest",void 0)&&delete l.enum.action,f)return e.next=16,y.connector.gw.getChannels(a.active,{fields:"protocol_id"});e.next=30;break;case 16:if(m=e.sent,w(g=m.data),g.result&&g.result.length&&g.result[0].protocol_id)return e.next=22,y.connector.gw.getChannelProtocols(g.result[0].protocol_id,{fields:"message_parameters"});e.next=28;break;case 22:d=e.sent,w(h=d.data),v=h.result[0].message_parameters,l.schemas._protocol={name:"_protocol",cols:[]},v.forEach(function(e){var t=e.name,r={name:t,type:e.type||"",unit:e.unit||"",description:e.info||""},n={name:t,width:150};if("timestamp"===t){var s=(new Date).toString().match(/([-+][0-9]+)\s/)[1];return r.addition="".concat(s.slice(0,3),":").concat(s.slice(3)),r.type="",r.unit="",n.width=190,l.schemas._protocol.cols.unshift(n),void(l.enum.timestamp=r)}"server.timestamp"===t&&(r.type="",r.unit="",n.width=190),l.schemas._protocol.cols.push(n),l.enum[t]=r});case 28:c&&(l.schemas._protocol.cols.push({name:"etc",width:150,__dest:"etc"}),l.schemas._default.cols.push({name:"etc",width:150,__dest:"etc"})),l.enum.etc={name:"etc",__dest:"etc"};case 30:o("setCols",l),y.set(a,"isLoading",!1),e.next=39;break;case 34:e.prev=34,e.t0=e.catch(4),b&&b(e.t0),DEV&&console.log(e.t0),y.set(a,"isLoading",!1);case 39:case"end":return e.stop()}var t,r},e,null,[[4,34]])}))).apply(this,arguments)}function t(){return(t=P(k.mark(function e(n){var s,a,o,i,c,u,l;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=n.state,a=n.commit,n.rootState.token&&s.active)return e.prev=2,y.set(s,"isLoading",!0),o={reverse:!0,count:1},e.next=7,y.connector.gw.getChannelsMessages(s.active,{data:JSON.stringify(o)});e.next=26;break;case 7:if(i=e.sent,w(c=i.data),u=Date.now(),c.result.length&&(u=Math.round(1e3*c.result[0]["server.timestamp"])),0,t=u||Date.now(),r=new Date(t).setHours(0,0,0,0),a("setFrom",(l={from:r,to:r+86399999}).from),a("setTo",l.to),l.to<Date.now())return e.next=18,g({state:s});e.next=18;break;case 18:y.set(s,"isLoading",!1),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(2),b&&b(e.t0),DEV&&console.log(e.t0),y.set(s,"isLoading",!1);case 26:case"end":return e.stop()}var t,r},e,null,[[2,21]])}))).apply(this,arguments)}function h(e,t){return n.apply(this,arguments)}function n(){return(n=P(k.mark(function e(t,r){var n,s,a,o,i,c,u;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.state,s=t.commit,a=t.rootState,s("reqStart"),o=[],a.token&&n.active)return i=n.isLoading,e.prev=5,i||y.set(n,"isLoading",!0),e.next=9,y.connector.gw.getChannelsMessages(n.active,{data:JSON.stringify(r)});e.next=21;break;case 9:c=e.sent,w(u=c.data),i||y.set(n,"isLoading",!1),o=u.result||[],e.next=21;break;case 16:e.prev=16,e.t0=e.catch(5),b&&b(e.t0),DEV&&console.log(e.t0),i||y.set(n,"isLoading",!1);case 21:return e.abrupt("return",o);case 22:case"end":return e.stop()}},e,null,[[5,16]])}))).apply(this,arguments)}function c(e){return s.apply(this,arguments)}function s(){return(s=P(k.mark(function e(t){var r,n,s,a,o,i,c,u,l,p,f,m,g;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,s=t.rootState,r.isLoading){e.next=35;break}return y.set(r,"isLoading",!0),a=Math.floor(Date.now()/1e3),o=d(r),i=0,e.next=8,h({state:r,commit:n,rootState:s},o);case 8:if(c=e.sent,i+=c.length,u=Math.floor(Date.now()/1e3),l=o.to>=u&&r.limit&&c.length<r.limit&&!v,p=function(){},l)return e.next=16,x({state:r,commit:n,rootState:s});e.next=28;break;case 16:return p=e.sent,f=Math.floor(Date.now()/1e3),(m=d(r)).from=a,m.to=f,e.next=23,h({state:r,commit:n,rootState:s},m);case 23:g=e.sent,i+=g.length,c.splice.apply(c,[c.length,0].concat(M(g))),e.next=31;break;case 28:if((o.to<u||r.limit&&c.length>=r.limit)&&v)return e.next=31,S({state:r,commit:n,rootState:s});e.next=31;break;case 31:n("limiting",{type:"init",count:i}),n("setHistoryMessages",c),(l||r.realtimeEnabled)&&(p(),n("limiting",{type:"rt_init"})),y.set(r,"isLoading",!1);case 35:case"end":return e.stop()}},e)}))).apply(this,arguments)}function a(){return(a=P(k.mark(function e(t){var r,n,s,a,o,i;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,s=t.rootState,r.isLoading){e.next=21;break}if(y.set(r,"isLoading",!0),a=Math.floor(_(r,'messages[0]["server.timestamp"]',r.to)-1),(o=d(r)).to=a,o.reverse=!0,v&&r.messages.length>2*r.limit)return e.next=10,S({state:r,commit:n,rootState:s});e.next=11;break;case 10:n("limiting",{type:"rt_deinit"});case 11:return e.next=13,h({state:r,commit:n,rootState:s},o);case 13:if((i=e.sent).length){e.next=17;break}return y.set(r,"isLoading",!1),e.abrupt("return",0);case 17:return n("limiting",{type:"prev",count:i.length}),n("prependMessages",i),y.set(r,"isLoading",!1),e.abrupt("return",i.length);case 21:case"end":return e.stop()}},e)}))).apply(this,arguments)}function o(){return(o=P(k.mark(function e(t){var r,n,s,a,o,i,c,u,l,p,f,m,g;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,s=t.rootState,r.isLoading){e.next=34;break}if(r.realtimeEnabled)return e.abrupt("return");e.next=4;break;case 4:return y.set(r,"isLoading",!0),a=Date.now(),o=Math.floor(_(r,"messages[".concat(r.messages.length-1,"]['server.timestamp']"),r.from)+1),i=d(r),c=0,i.from=o,e.next=12,h({state:r,commit:n,rootState:s},i);case 12:if(u=e.sent,c+=u.length,l=i.to>Math.floor(Date.now()/1e3)&&r.limit&&u.length<r.limit&&!v,p=function(){},l)return e.next=19,x({state:r,commit:n,rootState:s});e.next=29;break;case 19:return p=e.sent,f=Date.now(),(m=d(r)).from=Math.floor(a/1e3),m.to=Math.floor(f/1e3),e.next=26,h({state:r,commit:n,rootState:s},m);case 26:g=e.sent,c+=g.length,u.splice.apply(u,[u.length,0].concat(M(g)));case 29:return n("limiting",{type:"next",count:c}),n("appendMessages",u),l&&(p(),n("limiting",{type:"rt_init"})),y.set(r,"isLoading",!1),e.abrupt("return",c);case 34:case"end":return e.stop()}},e)}))).apply(this,arguments)}function u(){return(u=P(k.mark(function e(t,r){var n,s,a,o;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.state,s=t.commit,a=t.rootState,o=n.limit,s("clearMessages"),s("setReverse",!0),s("setLimit",r),e.next=7,c({state:n,commit:s,rootState:a});case 7:s("setReverse",!1),s("setLimit",o);case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}var l=[],v=0;function x(e){return p.apply(this,arguments)}function p(){return(p=P(k.mark(function e(t){var r,n;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,n=t.commit,t.rootState,e.next=3,y.connector.subscribeMessagesChannels(r.active,"+",function(e){l.push(JSON.parse(e))},{rh:2});case 3:return r.realtimeEnabled=!0,e.abrupt("return",function(){var e;e=n,v=setInterval(function(){l.length&&(e("setRTMessages",M(l)),l=[])},500)});case 5:case"end":return e.stop()}},e)}))).apply(this,arguments)}function S(e){return f.apply(this,arguments)}function f(){return(f=P(k.mark(function e(t){var r;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,v&&(clearInterval(v),l=[],v=0),e.next=4,y.connector.unsubscribeMessagesChannels(r.active,"+");case 4:r.realtimeEnabled=!1;case 5:case"end":return e.stop()}},e)}))).apply(this,arguments)}function m(){return(m=P(k.mark(function e(t){var r,n,s,a,o,i;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,t.rootState.token&&r.active)return e.prev=2,y.set(r,"isLoading",!0),s=r.messages.reduceRight(function(e,t,r){return e||("offline"===t.__connectionStatus&&(e=r),e)},0),a={from:s?Math.floor(r.messages[s-1]["server.timestamp"])+1:0,to:Math.floor(r.messages[s+1]["server.timestamp"])},e.next=8,y.connector.gw.getChannelsMessages(r.active,{data:JSON.stringify(a)});e.next=20;break;case 8:o=e.sent,w(i=o.data),n("setMissingMessages",{data:i.result,index:s}),y.set(r,"isLoading",!1),e.next=20;break;case 15:e.prev=15,e.t0=e.catch(2),b&&b(e.t0),DEV&&console.log(e.t0),y.set(r,"isLoading",!1);case 20:case"end":return e.stop()}},e,null,[[2,15]])}))).apply(this,arguments)}function g(e){return O.apply(this,arguments)}function O(){return(O=P(k.mark(function e(t){var r;return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(r=t.state).hasNewMessages=!1,e.next=4,y.connector.subscribeMessagesChannels(r.active,"+",function(){r.hasNewMessages=!0,S({state:r})},{rh:2});case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}return{getMessages:h,get:c,getPrevPage:function(e){return a.apply(this,arguments)},getNextPage:function(e){return o.apply(this,arguments)},pollingGet:x,getCols:function(e,t){return r.apply(this,arguments)},getHistory:function(e,t){return u.apply(this,arguments)},initTime:function(e){return t.apply(this,arguments)},unsubscribePooling:S,getMissedMessages:function(e){return m.apply(this,arguments)}}}function H(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function V(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?H(Object(r),!0).forEach(function(e){q(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):H(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function R(e){var r=e.Vue,p=e.LocalStorage,u=e.filterHandler,l=e.newMessagesInterseptor,n=0;function f(r){r.length&&r.forEach(function(e,t){r[t]["x-flespi-message-key"]=n++})}function s(e){e.messages.splice(0,e.messages.length),l&&l([]),i(e)}function m(e,t){var r=t.type,n=t.count;if(!e.limit)return!1;var s=e.messages,a=e.pages;switch(r){case"init":e.pages=n?[n]:[];break;case"prev":if(!n)break;if(3===a.length){var o=a[2];e.pages=[n].concat(M(a.slice(0,-1))),s.splice(s.length-o,o)}else e.pages=[n].concat(M(a));break;case"next":if(!n)break;var i=a.length;if(3===i){var c=a[0];e.pages=[].concat(M(a.slice(1,3)),[n]),s.splice(0,c)}else i<3&&a.push(n);break;case"rt_init":a.push(0);break;case"rt_deinit":var u=a.pop();s.splice(s.length-u,u);break;case"rt":var l=a.length,p=a[l-1]||0;if(p+n>e.limit)if(3<l){var f=a[0];e.pages=[].concat(M(a.slice(1,-1)),[p+n,0]),s.splice(0,f)}else e.pages=[].concat(M(a.slice(0,-1)),[p+n,0]);else e.pages[l-1]=p+n}}function t(){return(t=P(k.mark(function e(t){return k.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s(t),t.filter="",t.from=0,t.to=0,t.limit=1e3,t.reverse=!1,e.next=8,r.connector.unsubscribeMessagesChannels(t.active);case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}function a(e,t){var r,n=function(e){var t={};if(e.lsNamespace){var r=e.lsNamespace.split("."),n=r.shift(),s="".concat(r.join("."),".").concat(e.name),a=p.getItem(n);t=_(a,s,t)}else t=p.getItem(e.name)||t;return t}(e)||{},s={customColsSchema:V({},(r=t).schemas,{_default:void 0,_protocol:void 0}),defaultColsSchema:{activeSchema:r.activeSchema,schemas:{_default:r.schemas._default,_protocol:r.schemas._protocol},enum:r.enum}},a=s.customColsSchema,o=s.defaultColsSchema;if(n[e.active]=o,n["custom-cols-schemas"]=V({},n["custom-cols-schemas"],{},a),e.lsNamespace){var i=e.lsNamespace.split("."),c=i.shift(),u="".concat(i.join("."),".").concat(e.name),l=p.getItem(c)||{};v(l,u,n),p.set(c,l)}else p.set(e.name,n)}function o(e,t){a(e,t),r.set(e,"cols",t)}function i(e){r.set(e,"selected",[])}return{setOffline:function(e,t){t&&e.messages.push({__connectionStatus:"offline",timestamp:Date.now()/1e3}),e.offline=!0},setReconnected:function(e,t){t&&e.messages.push({__connectionStatus:"reconnected",timestamp:Date.now()/1e3}),e.offline=!1},setHistoryMessages:function(e,t){e.reverse&&t.reverse(),f(t),l&&l(t),e.messages=t},setRTMessages:function(e,t){if(t&&t.length){e.filter&&u&&(t=u(e.filter,t)),f(t);var r=e.messages;if(e.sortBy){var n=t[0],s=e.sortBy,a=e.messages.length-1,o=null,i=!0;if(0<a)for(var c=a;0!==c||i;c--)!(r[c][s]>n[s]&&0!==(o=c)||!(i=!1));l&&l(t),o?r.splice.apply(r,[o,0].concat(M(t))):r.splice.apply(r,[r.length,0].concat(M(t)))}else l&&l(t),r.splice.apply(r,[r.length,0].concat(M(t)));m(e,{type:"rt",count:t.length})}},setMissingMessages:function(e,t){var r,n=t.data,s=t.index;n.forEach(function(e){e["x-flespi-status"]="missed"}),(r=e.messages).splice.apply(r,[s+1,0].concat(M(n)))},prependMessages:function(e,t){if(t&&t.length){t.reverse();var r=e.messages;f(t),l&&l(t),r.splice.apply(r,[0,0].concat(M(t)))}},appendMessages:function(e,t){if(t&&t.length){var r=e.messages;f(t),l&&l(t),r.splice.apply(r,[r.length,0].concat(M(t)))}},clearMessages:s,setLimit:function(e,t){r.set(e,"limit",t)},limiting:m,setFilter:function(e,t){e.filter!==t&&r.set(e,"filter",t)},setFrom:function(e,t){r.set(e,"from",t)},setTo:function(e,t){r.set(e,"to",t)},reqStart:function(){DEV&&console.log("Start Request Channels messages")},setReverse:function(e,t){r.set(e,"reverse",t)},clear:function(e){return t.apply(this,arguments)},setActive:function(e,t){r.set(e,"active",t)},setCols:o,updateCols:o,setSelected:function(e,t){r.set(e,"selected",t)},clearSelected:i,setSortBy:function(e,t){r.set(e,"sortBy",t)},clearSortBy:function(e){r.set(e,"sortBy",null)},setSettings:function(e,t){r.set(e,"settings",t)}}}e.default=function(e){var t=e.Vue,r=e.LocalStorage,n=e.name,s=e.errorHandler,a=e.filterHandler,o=e.newMessagesInterseptor,i=_(n,"lsNamespace",void 0);return{namespaced:!0,state:{name:n=_(n,"name",n),lsNamespace:i,isLoading:!1,active:0,messages:[],pages:[],filter:"",settings:{},realtimeEnabled:!1,from:0,to:0,limit:1e3,reverse:!1,cols:void 0,offline:!1,selected:[],sortBy:null,hasNewMessages:null},actions:I({Vue:t,LocalStorage:r,errorHandler:s}),mutations:R({Vue:t,LocalStorage:r,filterHandler:a,newMessagesInterseptor:o})}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=channelsMessagesSerial.js.map
