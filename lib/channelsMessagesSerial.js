!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es.array.reverse.js"),require("core-js/modules/es.array.reduce.js"),require("core-js/modules/web.dom-collections.iterator.js"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es.array.reverse.js","core-js/modules/es.array.reduce.js","core-js/modules/web.dom-collections.iterator.js","lodash/get","lodash/set"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).channelsMessagesSerial={},null,null,null,e._get,e.set)}(this,(function(e,t,s,o,n,a){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=i(n),r=i(a);function l(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var m={exports:{}},u={exports:{}};!function(e){e.exports=function(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e},e.exports.default=e.exports,e.exports.__esModule=!0}(u),function(e){var t=u.exports;function s(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,o)}return s}e.exports=function(e){for(var o=1;o<arguments.length;o++){var n=null!=arguments[o]?arguments[o]:{};o%2?s(Object(n),!0).forEach((function(s){t(e,s,n[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e},e.exports.default=e.exports,e.exports.__esModule=!0}(m);var f=l(m.exports);function g(e,t,s){let o={};if(t){const n=t.split("."),a=n.shift(),i=`${n.join(".")}.${s}`,r=e.getItem(a);o=c.default(r,i,o)}else o=e.getItem(s)||o;return o}function d(e,t,s,o,n){const a=g(e,t,s)||{},{customColsSchema:i,defaultColsSchema:c}=function(e){return{customColsSchema:f(f({},e.schemas),{},{_default:void 0,_protocol:void 0,_unsaved:void 0}),defaultColsSchema:{activeSchema:e.activeSchema,schemas:{_default:e.schemas._default,_protocol:e.schemas._protocol,_unsaved:e.schemas._unsaved}}}}(n);if(a[o]=c,a["custom-cols-schemas"]=f({},i),t){const o=t.split("."),n=o.shift(),i=`${o.join(".")}.${s}`,c=e.getItem(n)||{};r.default(c,i,a),e.set(n,c)}else e.set(s,a)}const p=["timestamp","server.timestamp","ident","position.latitude","position.longitude","position.altitude","position.speed"];function h({Vue:e,LocalStorage:t,errorHandler:s}){function o(e){const t={};return e.limit&&(t.count=e.limit),e.filter&&(t.filter=`${e.filter}`),e.from&&(t.from=e.from/1e3),e.to&&(t.to=e.to/1e3),e.reverse&&(t.reverse=e.reverse),t}function n(e){e.errors&&e.errors.forEach((e=>{const t=new Error(e.reason);s&&s(t)}))}async function a(t,s){const o={activeSchema:"_default",schemas:{_default:{name:"_default",cols:s.reduce(((e,t)=>((p.includes(t.name)||t.__dest&&t.display)&&e.push({name:t.name,width:t.width}),e)),[])},_protocol:{name:"_protocol",cols:s.reduce(((e,t)=>(t.custom||e.push({name:t.name,width:150}),e)),[])}},enum:{}};if(s.length){const a=s.reduce(((e,t)=>{const s=p.includes(t.name);return e.isDefault=e.isDefault&&(!t.display&&!s||t.display&&(s||!!t.__dest)),e.isProtocol=e.isProtocol&&!t.custom,t.display&&e.schema.push({name:t.name,width:t.width}),e}),{schema:[],isDefault:!0,isProtocol:!0,enum:{}});if(!a.isDefault||!a.isProtocol){const s=(await e.connector.gw.getChannels(t,{fields:"name"})).data;n(s);let i=c.default(s,"result[0].name",`Channel-${t}`);i=`${i}[${t}]`,o.activeSchema=i,o.schemas[i]={name:i,cols:a.schema}}}return o}function i(){return p.reduce(((e,t)=>(e[t]={name:t},e)),{})}async function r({state:t,commit:o,rootState:a},i){o("reqStart");let c=[];if(a.token&&t.active){const o=t.isLoading;try{!o&&e.set(t,"isLoading",!0);const s=(await e.connector.gw.getChannelsMessages(t.active,{data:JSON.stringify(i)})).data;n(s),!o&&e.set(t,"isLoading",!1),c=s.result||[]}catch(n){s&&s(n),DEV&&console.log(n),!o&&e.set(t,"isLoading",!1)}}return c}async function l({state:t,commit:s,rootState:n}){if(!t.isLoading){e.set(t,"isLoading",!0);const a=Date.now()/1e3,i=o(t);let c=0;const l=await r({state:t,commit:s,rootState:n},i);c+=l.length;const m=Date.now()/1e3,f=i.to>=m&&t.limit&&l.length<t.limit&&!u;let g=()=>{};if(f){g=await h({state:t,commit:s,rootState:n});const e=Date.now()/1e3,i=o(t);i.from=a,i.to=e;const m=await r({state:t,commit:s,rootState:n},i);c+=m.length,l.splice(l.length,0,...m)}else(i.to<m||t.limit&&l.length>=t.limit)&&u&&await y({state:t,commit:s,rootState:n});s("limiting",{type:"init",count:c}),s("setHistoryMessages",l),(f||t.realtimeEnabled)&&(g(),s("limiting",{type:"rt_init"})),e.set(t,"isLoading",!1)}}let m=[],u=0;async function h({state:t,commit:s}){const o=t.filter?`$filter/payload=${encodeURIComponent(t.filter)}`:void 0;return await e.connector.subscribeMessagesChannels(t.active,"+",(e=>{m.push(JSON.parse(e))}),{rh:2,prefix:o}),t.realtimeEnabled=!0,()=>{u=function(e,t){return setInterval((()=>{m.length&&(t("setRTMessages",[...m]),m=[])}),500)}(0,s)}}async function y({state:t}){u&&(clearInterval(u),m=[],u=0);const s=t.filter?`$filter/payload=${encodeURIComponent(t.filter)}`:void 0;await e.connector.unsubscribeMessagesChannels(t.active,"+",void 0,{prefix:s}),t.realtimeEnabled=!1}return{getMessages:r,get:l,getPrevPage:async function({state:t,commit:s,rootState:n}){if(!t.isLoading){e.set(t,"isLoading",!0);const a=c.default(t,'messages[0]["server.timestamp"]',t.to)-1e-6,i=o(t);i.to=a,i.reverse=!0,u&&t.messages.length>2*t.limit&&(await y({state:t,commit:s,rootState:n}),s("limiting",{type:"rt_deinit"}));const l=await r({state:t,commit:s,rootState:n},i);return l.length?(s("limiting",{type:"prev",count:l.length}),s("prependMessages",l),e.set(t,"isLoading",!1),l.length):(e.set(t,"isLoading",!1),0)}},getNextPage:async function({state:t,commit:s,rootState:n}){if(!t.isLoading){if(t.realtimeEnabled)return;e.set(t,"isLoading",!0);const a=Date.now(),i=c.default(t,`messages[${t.messages.length-1}]['server.timestamp']`,t.from)+1e-6,l=o(t);let m=0;l.from=i;const f=await r({state:t,commit:s,rootState:n},l);m+=f.length;const g=l.to+2>Math.floor(Date.now()/1e3)&&t.limit&&f.length<t.limit&&!u;let d=()=>{};if(g){d=await h({state:t,commit:s,rootState:n});const e=Date.now(),i=o(t);i.from=a/1e3,i.to=e/1e3;const c=await r({state:t,commit:s,rootState:n},i);m+=c.length,f.splice(f.length,0,...c)}return s("limiting",{type:"next",count:m}),s("appendMessages",f),g&&(d(),s("limiting",{type:"rt_init"})),e.set(t,"isLoading",!1),m}},pollingGet:h,getCols:async function({state:o,commit:c,rootState:r},l){c("reqStart");const m=l.etc;if(r.token&&o.active)try{e.set(o,"isLoading",!0);let s=g(t,o.lsNamespace,o.name);!async function(e,s){for(const o in s){let n=s[o];Array.isArray(n)?(n=await a(e.active,n),d(t,e.lsNamespace,e.name,o,n),s[o]=n):n.enum&&(delete n.enum,d(t,e.lsNamespace,e.name,o,n),s[o]=n)}}(o,s),s=s&&s[o.active];const r=s||{activeSchema:"_default",schemas:{_default:{name:"_default",cols:p.map((e=>({name:e,width:150})))}},enum:i()},l=s&&s["custom-cols-schemas"]?s["custom-cols-schemas"]:{};r.schemas=f(f({},r.schemas),l),r.enum||(r.enum=i());const u=(await e.connector.gw.getChannels(o.active,{fields:"protocol_id"})).data;if(n(u),u.result&&u.result.length&&u.result[0].protocol_id){const t=(await e.connector.gw.getChannelProtocols(u.result[0].protocol_id,{fields:"message_parameters"})).data;n(t);const s=t.result[0].message_parameters;r.schemas._protocol={name:"_protocol",cols:[]};const o=(new Date).toString().match(/([-+][0-9]+)\s/)[1];s.forEach((e=>{const t=e.name,s={name:t,type:e.type||"",unit:e.unit||"",description:e.info||""},n={name:t,width:150};if(t.match(/timestamp$/)&&(s.addition=`${o.slice(0,3)}:${o.slice(3)}`,s.type="",s.unit="",n.width=190,"timestamp"===t))return r.schemas._protocol.cols.unshift(n),void(r.enum.timestamp=s);r.schemas._protocol.cols.push(n),r.enum[t]=s}))}m&&(r.schemas._protocol.cols.push({name:"etc",width:150,__dest:"etc"}),!s&&r.schemas._default.cols.push({name:"etc",width:150,__dest:"etc"})),r.enum.etc={name:"etc",__dest:"etc"},c("setCols",r),e.set(o,"isLoading",!1)}catch(t){s&&s(t),DEV&&console.log(t),e.set(o,"isLoading",!1)}},getHistory:async function({state:e,commit:t,rootState:s},o){const n=e.limit;t("clearMessages"),t("setReverse",!0),t("setLimit",o),await l({state:e,commit:t,rootState:s}),t("setReverse",!1),t("setLimit",n)},initTime:async function({state:t,commit:o,rootState:a}){if(a.token&&t.active)try{e.set(t,"isLoading",!0);const s={reverse:!0,count:1},a=(await e.connector.gw.getChannelsMessages(t.active,{data:JSON.stringify(s)})).data;n(a);let i=Date.now();a.result.length&&(i=Math.round(1e3*a.result[0]["server.timestamp"]));const c=function(e){const t=e||Date.now(),s=new Date(t).setHours(0,0,0,0);return{from:s,to:s+86399999.999}}(i);o("setFrom",c.from),o("setTo",c.to),c.to<Date.now()&&await async function({state:t}){t.hasNewMessages=!1,await e.connector.subscribeMessagesChannels(t.active,"+",(()=>{t.hasNewMessages=!0,y({state:t})}),{rh:2})}({state:t}),e.set(t,"isLoading",!1)}catch(o){s&&s(o),DEV&&console.log(o),e.set(t,"isLoading",!1)}},unsubscribePooling:y,getMissedMessages:async function({state:t,commit:o,rootState:a}){if(a.token&&t.active)try{e.set(t,"isLoading",!0);const{start:s,end:a,lastMessageIndex:i}=t.offline,c={from:s,to:a};t.filter&&(c.data.filter=t.filter);const r=(await e.connector.gw.getChannelsMessages(t.active,{data:JSON.stringify(c)})).data;n(r),o("setMissingMessages",{data:r.result,index:i}),e.set(t,"isLoading",!1)}catch(o){s&&s(o),DEV&&console.log(o),e.set(t,"isLoading",!1)}}}}e.default=function({Vue:e,LocalStorage:t,name:s,errorHandler:o,newMessagesInterseptor:n}){const a=c.default(s,"lsNamespace",void 0);s=c.default(s,"name",s);const i=h({Vue:e,LocalStorage:t,errorHandler:o}),r=function({Vue:e,LocalStorage:t,newMessagesInterseptor:s}){let o=0;function n(e){e.length&&e.forEach(((t,s)=>{e[s]["x-flespi-message-key"]=o++}))}function a(e){e.messages.splice(0,e.messages.length),s&&s([]),r(e)}function i(e,{type:t,count:s}){if(!e.limit)return!1;const o=e.messages,n=e.pages;switch(t){case"init":e.pages=s?[s]:[];break;case"prev":if(!s)break;if(3===n.length){const t=n[2];e.pages=[s,...n.slice(0,-1)],o.splice(o.length-t,t)}else e.pages=[s,...n];break;case"next":{if(!s)break;const t=n.length;if(3===t){const t=n[0];e.pages=[...n.slice(1,3),s],o.splice(0,t)}else t<3&&n.push(s);break}case"rt_init":n.push(0);break;case"rt_deinit":{const e=n.pop();o.splice(o.length-e,e);break}case"rt":{const t=n.length,a=n[t-1]||0;if(a+s>e.limit)if(t>3){const t=n[0];e.pages=[...n.slice(1,-1),a+s,0],o.splice(0,t)}else e.pages=[...n.slice(0,-1),a+s,0];else e.pages[t-1]=a+s}}}function c(s,o){d(t,s.lsNamespace,s.name,s.active,o),e.set(s,"cols",o)}function r(t){e.set(t,"selected",[])}return{setOffline:function(e){e.offline={start:Date.now()/1e3,lastMessageIndex:e.messages.length-1}},setReconnected:function(e){e.offline.end=Date.now()/1e3},clearOfflineState:function(e){e.offline=!1},setHistoryMessages:function(e,t){e.reverse&&t.reverse(),n(t),s&&s(t),e.messages=t},setRTMessages:function(e,t){if(t&&t.length){n(t);const o=e.messages;if(e.sortBy){const n=t[0],a=e.sortBy,i=e.messages.length-1;let c=null,r=!0;if(i>0)for(let e=i;0!==e||r;e--)o[e][a]>n[a]?(c=e,0===e&&(r=!1)):r=!1;s&&s(t),c?o.splice(c,0,...t):o.splice(o.length,0,...t)}else s&&s(t),o.splice(o.length,0,...t);i(e,{type:"rt",count:t.length})}},setMissingMessages:function(e,{data:t,index:s}){e.messages.splice(s+1,0,...t)},prependMessages:function(e,t){if(t&&t.length){t.reverse();const o=e.messages;n(t),s&&s(t),o.splice(0,0,...t)}},appendMessages:function(e,t){if(t&&t.length){const o=e.messages;n(t),s&&s(t),o.splice(o.length,0,...t)}},clearMessages:a,setLimit:function(t,s){e.set(t,"limit",s)},limiting:i,setFilter:function(t,s){t.filter!==s&&e.set(t,"filter",s)},setFrom:function(t,s){e.set(t,"from",s)},setTo:function(t,s){e.set(t,"to",s)},reqStart:function(){DEV&&console.log("Start Request Channels messages")},setReverse:function(t,s){e.set(t,"reverse",s)},clear:async function(t){a(t),t.filter="",t.from=0,t.to=0,t.limit=1e3,t.reverse=!1,await e.connector.unsubscribeMessagesChannels(t.active)},setActive:function(t,s){e.set(t,"active",s)},setCols:c,updateCols:c,setSelected:function(t,s){e.set(t,"selected",s)},clearSelected:r,setSortBy:function(t,s){e.set(t,"sortBy",s)},clearSortBy:function(t){e.set(t,"sortBy",null)},setSettings:function(t,s){e.set(t,"settings",s)}}}({Vue:e,LocalStorage:t,newMessagesInterseptor:n});return{namespaced:!0,state:{name:s,lsNamespace:a,isLoading:!1,active:0,messages:[],pages:[],filter:"",settings:{},realtimeEnabled:!1,from:0,to:0,limit:1e3,reverse:!1,cols:void 0,offline:!1,selected:[],sortBy:null,hasNewMessages:null},actions:i,mutations:r}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=channelsMessagesSerial.js.map
