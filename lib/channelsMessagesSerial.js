!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.function.name"),require("core-js/modules/es6.regexp.to-string"),require("core-js/modules/es6.object.to-string"),require("core-js/modules/es6.regexp.match"),require("regenerator-runtime/runtime"),require("@babel/runtime/helpers/toConsumableArray"),require("@babel/runtime/helpers/asyncToGenerator")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.function.name","core-js/modules/es6.regexp.to-string","core-js/modules/es6.object.to-string","core-js/modules/es6.regexp.match","regenerator-runtime/runtime","@babel/runtime/helpers/toConsumableArray","@babel/runtime/helpers/asyncToGenerator"],t):t((e=e||self).channelsMessagesSerial={},null,null,null,null,null,e._toConsumableArray,e._asyncToGenerator)}(this,function(e,t,r,n,s,o,h,y){"use strict";h=h&&h.hasOwnProperty("default")?h.default:h,y=y&&y.hasOwnProperty("default")?y.default:y,e.default=function(e){var t=e.Vue,r=e.LocalStorage,n=e.name,s=e.errorHandler,o=e.filterHandler,a=e.newMessagesInterseptor;return{namespaced:!0,state:{name:n,isLoading:!1,active:0,messages:[],filter:"",sysFilter:"",settings:{},mode:null,from:0,to:0,limit:1e3,reverse:!1,cols:[],newMessagesCount:0,offline:!1,selected:[],sortBy:null},actions:function(e){var g=e.Vue,f=e.LocalStorage,p=e.errorHandler;function d(e){e.errors&&e.errors.forEach(function(e){var t=new Error(e.reason);p&&p(t)})}function t(){return(t=y(regeneratorRuntime.mark(function e(t){var r,n,s,o,a,i,c,u,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,s=t.rootState,n("reqStart"),!s.token||!r.active){e.next=32;break}if(e.prev=3,g.set(r,"isLoading",!0),o=[],!((a=f.get.item(r.name))&&a[r.active]&&a[r.active])){e.next=11;break}a[r.active].forEach(function(e){if("timestamp"===e.name){var t=(new Date).toString().match(/([-\+][0-9]+)\s/)[1];e.addition="".concat(t.slice(0,3),":").concat(t.slice(3))}}),o=a[r.active],e.next=23;break;case 11:return e.next=13,g.connector.gw.getChannels(r.active,{fields:"protocol_id"});case 13:if(i=e.sent,d(c=i.data),c.result&&c.result.length&&c.result[0].protocol_id)return e.next=19,g.connector.gw.getProtocols(c.result[0].protocol_id,{fields:"message_parameters"});e.next=23;break;case 19:u=e.sent,d(l=u.data),l.result[0].message_parameters.forEach(function(e){var t={name:e.name,width:160,display:!0,description:e.info};if("timestamp"===t.name){var r=(new Date).toString().match(/([-\+][0-9]+)\s/)[1];t.addition="".concat(r.slice(0,3),":").concat(r.slice(3))}o.push(t)});case 23:n("setCols",o),g.set(r,"isLoading",!1),e.next=32;break;case 27:e.prev=27,e.t0=e.catch(3),p&&p(e.t0),DEV&&console.log(e.t0),g.set(r,"isLoading",!1);case 32:case"end":return e.stop()}},e,null,[[3,27]])}))).apply(this,arguments)}function r(){return(r=y(regeneratorRuntime.mark(function e(s){var o,a,i,c,u,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=s.state,a=s.commit,s.rootState.token&&o.active)return e.prev=2,g.set(o,"isLoading",!0),i={reverse:!0,count:1},e.next=7,g.connector.gw.getChannelsMessages(o.active,{data:JSON.stringify(i)});e.next=21;break;case 7:c=e.sent,d(u=c.data),l=Date.now(),u.result.length&&(l=Math.round(1e3*u.result[0].timestamp)),a("setDate",(t=l,r=t||Date.now(),n=new Date(r).setHours(0,0,0,0),{from:n,to:n+864e5}).from),g.set(o,"isLoading",!1),e.next=21;break;case 16:e.prev=16,e.t0=e.catch(2),p&&p(e.t0),DEV&&console.log(e.t0),g.set(o,"isLoading",!1);case 21:case"end":return e.stop()}var t,r,n},e,null,[[2,16]])}))).apply(this,arguments)}function v(e,t){return n.apply(this,arguments)}function n(){return(n=y(regeneratorRuntime.mark(function e(n,s){var o,a,i,c,u,l,f,m;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=n.state,a=n.commit,i=n.rootState,a("reqStart"),s&&(c=s.name,u=s.payload,a("clearMessages"),a(c,u)),i.token&&o.active)return e.prev=4,g.set(o,"isLoading",!0),l=JSON.parse(JSON.stringify(o.mode)),e.next=9,g.connector.gw.getChannelsMessages(o.active,{data:JSON.stringify((t=o,r=void 0,r={},t.limit&&(r.count=t.limit),t.filter&&t.sysFilter?1===t.mode?r.filter="".concat(t.sysFilter):r.filter="".concat(t.sysFilter,",").concat(t.filter):t.sysFilter&&!t.filter?r.filter="".concat(t.sysFilter):!t.sysFilter&&t.filter&&0===t.mode&&(r.filter="".concat(t.filter)),!t.from||t.reverse&&1!==t.mode||t.reverse||(r.from=Math.floor(t.from/1e3)),t.to&&(1===t.mode&&(t.to=Date.now()),r.to=Math.floor(t.to/1e3)),t.reverse&&(r.reverse=t.reverse),r))});e.next=46;break;case 9:if(f=e.sent,l!==o.mode)return e.abrupt("return",!1);e.next=12;break;case 12:if(d(m=f.data),!s){e.next=37;break}if(!m.result.length){e.next=20;break}a("setMessages",m.result),a("postaction"),e.next=35;break;case 20:a("postaction"),e.t0=s.name,e.next="paginationPrev"===e.t0?24:"paginationNext"===e.t0?30:33;break;case 24:return a("datePrev"),a("paginationPrev"),e.next=28,v({state:o,commit:a,rootState:i});case 28:return a("postaction"),e.abrupt("break",35);case 30:return v({state:o,commit:a,rootState:i},{name:"dateNext"}),a("postaction"),e.abrupt("break",35);case 33:a("setMessages",m.result),a("postaction");case 35:e.next=38;break;case 37:a("setMessages",m.result);case 38:g.set(o,"isLoading",!1),e.next=46;break;case 41:e.prev=41,e.t1=e.catch(4),p&&p(e.t1),DEV&&console.log(e.t1),g.set(o,"isLoading",!1);case 46:case"end":return e.stop()}var t,r},e,null,[[4,41]])}))).apply(this,arguments)}function s(){return(s=y(regeneratorRuntime.mark(function e(t,r){var n,s,o,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.state,s=t.commit,o=t.rootState,a=n.limit,i=n.filter,s("setReverse",!0),s("setLimit",r),s("setFilter",""),e.next=7,v({state:n,commit:s,rootState:o});case 7:s("setReverse",!1),s("setLimit",a),s("setFilter",i);case 10:case"end":return e.stop()}},e)}))).apply(this,arguments)}var o=[],a=0;function i(e,t){return setInterval(function(){o.length&&(1===e.mode&&t("setMessages",h(o)),o=[])},500)}function c(){return(c=y(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,n=t.commit,t.rootState,a=i(r,n),e.next=4,g.connector.subscribeMessagesChannels(r.active,"+",function(e){1===r.mode?o.push(JSON.parse(e)):n("setNewMessagesCount",r.newMessagesCount+1)},{rh:2});case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}function u(){return(u=y(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,a&&clearInterval(a),e.next=4,g.connector.unsubscribeMessagesChannels(r.active,"+");case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}function l(){return(l=y(regeneratorRuntime.mark(function e(t){var r,n,s,o,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,t.rootState.token&&r.active)return e.prev=2,g.set(r,"isLoading",!0),s=r.messages.reduceRight(function(e,t,r){return e||("offline"===t.__connectionStatus&&(e=r),e)},0),o={from:s?Math.floor(r.messages[s-1].timestamp)+1:0,to:Math.floor(r.messages[s+1].timestamp)},e.next=8,g.connector.gw.getChannelsMessages(r.active,{data:JSON.stringify(o)});e.next=20;break;case 8:a=e.sent,d(i=a.data),n("setMissingMessages",{data:i.result,index:s}),g.set(r,"isLoading",!1),e.next=20;break;case 15:e.prev=15,e.t0=e.catch(2),p&&p(e.t0),DEV&&console.log(e.t0),g.set(r,"isLoading",!1);case 20:case"end":return e.stop()}},e,null,[[2,15]])}))).apply(this,arguments)}return{get:v,pollingGet:function(e){return c.apply(this,arguments)},getCols:function(e){return t.apply(this,arguments)},getHistory:function(e,t){return s.apply(this,arguments)},initTime:function(e){return r.apply(this,arguments)},unsubscribePooling:function(e){return u.apply(this,arguments)},getMissedMessages:function(e){return l.apply(this,arguments)}}}({Vue:t,LocalStorage:r,errorHandler:s}),mutations:function(e){var l=e.Vue,n=e.LocalStorage,f=e.filterHandler,m=e.newMessagesInterseptor;function s(e){var t=e||Date.now(),r=new Date(t).setHours(0,0,0,0);return{from:r,to:r+864e5}}function r(e,t){if(t&&t.length){e.reverse&&(t.reverse(),1===e.mode&&(t[t.length-1].delimiter=!0)),1===e.mode&&(l.set(e,"from",Math.floor(1e3*(t[t.length-1].timestamp+1))),e.filter&&f&&(t=f(e.filter,t)));var r=e.messages;if(e.sortBy&&1===e.mode)if(1<t.length)r=r.concat(t);else{var n=t[0],s=e.sortBy,o=e.messages.length-1,a=null,i=!0;if(0<o)for(var c=o;0!==c||i;c--)r[c][s]>n[s]?0===(a=c)&&(i=!1):i=!1;a?r.splice(a,0,n):r.push(n)}else r=r.concat(t);if(m&&m(t),e.limit&&1===e.mode&&r.length>=e.limit+.1*e.limit){var u=r.length-1-(e.limit-1);r=r.slice(u),l.set(e,"selected",e.selected.map(function(e){return e-u}))}l.set(e,"messages",r)}else 1===e.mode&&l.set(e,"from",e.to+1e3),l.set(e,"messages",[])}function o(e){l.set(e,"messages",[]),m&&m([]),g(e)}function a(e,t){l.set(e,"from",t)}function i(e,t){l.set(e,"to",t)}function c(e,t){l.set(e,"reverse",t)}function t(){return(t=y(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o(t),t.filter="",t.mode=null,t.from=0,t.to=0,t.limit=1e3,t.reverse=!1,e.next=9,l.connector.unsubscribeMessagesChannels(t.active);case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}function u(e,t){var r=n.get.item(e.name);r||(r={}),r[e.active]=t,n.set(e.name,r),l.set(e,"cols",t)}function g(e){l.set(e,"selected",[])}return{setOffline:function(e,t){t&&r(e,[{__connectionStatus:"offline",timestamp:Date.now()/1e3}]),e.offline=!0},setReconnected:function(e,t){t&&r(e,[{__connectionStatus:"reconnected",timestamp:Date.now()/1e3}]),e.offline=!1},setMissingMessages:function(e,t){var r,n=t.data,s=t.index;n.forEach(function(e){e.__status="missed"}),(r=e.messages).splice.apply(r,[s+1,0].concat(h(n)))},setMessages:r,clearMessages:o,setLimit:function(e,t){l.set(e,"limit",t)},setFilter:function(e,t){e.filter!==t&&(1===e.mode&&(e.filter&&e.messages.push({"x-flespi-filter-prev":e.filter}),t&&e.messages.push({"x-flespi-filter-next":t})),l.set(e,"filter",t))},setMode:function(e,t){switch(t){case 0:var r=e.from?s(e.from):s();e.from=r.from,e.to=r.to,o(e);break;case 1:var n=Date.now()-4e3;e.from=n-1e3,e.to=n,e.newMessagesCount=0}l.set(e,"mode",t)},setFrom:a,setTo:i,reqStart:function(){DEV&&console.log("Start Request Channels messages")},setReverse:c,dateNext:function(e){var t=s(e.from+864e5);e.from=t.from,e.to=t.to},datePrev:function(e){var t=s(e.from-864e5);e.from=t.from,e.to=t.to},paginationPrev:function(e,t){e.reverse=!0,e.sysFilter+="timestamp>=".concat(s(e.from).from/1e3),t&&(e.from=s(t).from,e.to=t-1e3)},paginationNext:function(e,t){e.sysFilter+="timestamp<=".concat(e.to/1e3),t&&(e.to=s(t).to,e.from=t+1e3)},setDate:function(e,t){var r=s(t);e.from=r.from,e.to=r.to},postaction:function(e){var t=s(e.from);a(e,e.from||t.from),i(e,t.to),e.reverse&&c(e,!1),e.sysFilter=""},clear:function(e){return t.apply(this,arguments)},setActive:function(e,t){e.newMessagesCount=0,l.set(e,"active",t)},setCols:u,updateCols:u,setNewMessagesCount:function(e,t){l.set(e,"newMessagesCount",t)},setSelected:function(e,t){l.set(e,"selected",t)},clearSelected:g,setSortBy:function(e,t){l.set(e,"sortBy",t)},clearSortBy:function(e){l.set(e,"sortBy",null)},setSettings:function(e,t){l.set(e,"settings",t)}}}({Vue:t,LocalStorage:r,filterHandler:o,newMessagesInterseptor:a})}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=channelsMessagesSerial.js.map
