!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.function.name"),require("@babel/runtime-corejs2/regenerator"),require("core-js/modules/es7.array.includes"),require("core-js/modules/es6.string.includes"),require("core-js/modules/es6.regexp.to-string"),require("core-js/modules/es6.object.to-string"),require("core-js/modules/es6.regexp.match"),require("regenerator-runtime/runtime"),require("core-js/library/fn/array/is-array"),require("core-js/library/fn/array/from"),require("core-js/library/fn/is-iterable"),require("core-js/library/fn/promise"),require("core-js/modules/es6.regexp.split"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.function.name","@babel/runtime-corejs2/regenerator","core-js/modules/es7.array.includes","core-js/modules/es6.string.includes","core-js/modules/es6.regexp.to-string","core-js/modules/es6.object.to-string","core-js/modules/es6.regexp.match","regenerator-runtime/runtime","core-js/library/fn/array/is-array","core-js/library/fn/array/from","core-js/library/fn/is-iterable","core-js/library/fn/promise","core-js/modules/es6.regexp.split","lodash/get","lodash/set"],t):t((e=e||self).channelsMessagesSerial={},0,e._regeneratorRuntime,0,0,0,0,0,0,e.isArray$1,e.from,e.isIterable$1,e.promise$1,0,e._get,e.set)}(this,function(e,t,j,n,s,r,a,i,o,c,l,u,f,p,_,g){"use strict";j=j&&j.hasOwnProperty("default")?j.default:j,c=c&&c.hasOwnProperty("default")?c.default:c,l=l&&l.hasOwnProperty("default")?l.default:l,u=u&&u.hasOwnProperty("default")?u.default:u,f=f&&f.hasOwnProperty("default")?f.default:f,_=_&&_.hasOwnProperty("default")?_.default:_,g=g&&g.hasOwnProperty("default")?g.default:g;var m=c;var d=function(e){if(m(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}},h=l,v=u;var y=function(e){if(v(Object(e))||"[object Arguments]"===Object.prototype.toString.call(e))return h(e)};var b=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var L=function(e){return d(e)||y(e)||b()},x=f;function w(e,t,n,s,r,a,i){try{var o=e[a](i),c=o.value}catch(e){return void n(e)}o.done?t(c):x.resolve(c).then(s,r)}var D=function(o){return function(){var e=this,i=arguments;return new x(function(t,n){var s=o.apply(e,i);function r(e){w(s,t,n,r,a,"next",e)}function a(e){w(s,t,n,r,a,"throw",e)}r(void 0)})}};function k(e){var d=e.Vue,o=e.LocalStorage,g=e.errorHandler;function h(e){var t={};return e.limit&&(t.count=e.limit),e.filter&&(t.filter="".concat(e.filter)),e.from&&(t.from=Math.floor(e.from/1e3)),e.to&&(t.to=Math.floor(e.to/1e3)),e.reverse&&(t.reverse=e.reverse),t}function v(e){e.errors&&e.errors.forEach(function(e){var t=new Error(e.reason);g&&g(t)})}function y(e){var t={};if(e.lsNamespace){var n=o.getItem(e.name);n&&(t=n,o.remove(e.name));var s=e.lsNamespace.split("."),r=s.shift(),a="".concat(s.join("."),".").concat(e.name),i=o.getItem(r);t=_(i,a,t)}else t=o.getItem(e.name)||t;return t}function n(){return(n=D(j.mark(function e(t,n){var s,r,a,i,o,c,l,u,f,p,m;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.state,r=t.commit,a=t.rootState,r("reqStart"),i=n.actions,o=n.etc,!a.token||!s.active){e.next=39;break}if(e.prev=5,d.set(s,"isLoading",!0),c=y(s),l=[],!(c&&c[s.active]&&c[s.active].length&&c[s.active][1]&&void 0!==c[s.active][1].unit)){e.next=16;break}c[s.active].forEach(function(e){if("timestamp"===e.name){var t=(new Date).toString().match(/([-+][0-9]+)\s/)[1];e.addition="".concat(t.slice(0,3),":").concat(t.slice(3))}}),(l=c[s.active])[0].__dest||l[l.length-1].__dest||(l.unshift({name:"actions",width:50,display:i,__dest:"action"}),l.push({name:"etc",width:150,display:o,__dest:"etc"})),e.next=30;break;case 16:return e.next=18,d.connector.gw.getChannels(s.active,{fields:"protocol_id"});case 18:if(u=e.sent,v(f=u.data),f.result&&f.result.length&&f.result[0].protocol_id)return e.next=24,d.connector.gw.getProtocols(f.result[0].protocol_id,{fields:"message_parameters"});e.next=28;break;case 24:p=e.sent,v(m=p.data),m.result[0].message_parameters.forEach(function(e){var t={name:e.name,width:160,display:s.defaultColsNames.includes(e.name),description:e.info,type:e.type||"",unit:e.unit||""};if("timestamp"===t.name){var n=(new Date).toString().match(/([-+][0-9]+)\s/)[1];t.addition="".concat(n.slice(0,3),":").concat(n.slice(3)),t.type="",t.unit=""}"server.timestamp"===t.name&&(t.type="",t.unit=""),l.push(t)});case 28:l.unshift({name:"actions",width:50,display:i,__dest:"action"}),l.push({name:"etc",width:150,display:o,__dest:"etc"});case 30:r("setCols",l),d.set(s,"isLoading",!1),e.next=39;break;case 34:e.prev=34,e.t0=e.catch(5),g&&g(e.t0),DEV&&console.log(e.t0),d.set(s,"isLoading",!1);case 39:case"end":return e.stop()}},e,null,[[5,34]])}))).apply(this,arguments)}function t(){return(t=D(j.mark(function e(s){var r,a,i,o,c,l,u;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=s.state,a=s.commit,s.rootState.token&&r.active)return e.prev=2,d.set(r,"isLoading",!0),i={reverse:!0,count:1},e.next=7,d.connector.gw.getChannelsMessages(r.active,{data:JSON.stringify(i)});e.next=26;break;case 7:if(o=e.sent,v(c=o.data),l=Date.now(),c.result.length&&(l=Math.round(1e3*c.result[0]["server.timestamp"])),0,t=l||Date.now(),n=new Date(t).setHours(0,0,0,0),a("setFrom",(u={from:n,to:n+86399999}).from),a("setTo",u.to),u.to<Date.now())return e.next=18,M({state:r});e.next=18;break;case 18:d.set(r,"isLoading",!1),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(2),g&&g(e.t0),DEV&&console.log(e.t0),d.set(r,"isLoading",!1);case 26:case"end":return e.stop()}var t,n},e,null,[[2,21]])}))).apply(this,arguments)}function b(e,t){return s.apply(this,arguments)}function s(){return(s=D(j.mark(function e(t,n){var s,r,a,i,o,c,l;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.state,r=t.commit,a=t.rootState,r("reqStart"),i=[],a.token&&s.active)return o=s.isLoading,e.prev=5,o||d.set(s,"isLoading",!0),e.next=9,d.connector.gw.getChannelsMessages(s.active,{data:JSON.stringify(n)});e.next=21;break;case 9:c=e.sent,v(l=c.data),o||d.set(s,"isLoading",!1),i=l.result||[],e.next=21;break;case 16:e.prev=16,e.t0=e.catch(5),g&&g(e.t0),DEV&&console.log(e.t0),o||d.set(s,"isLoading",!1);case 21:return e.abrupt("return",i);case 22:case"end":return e.stop()}},e,null,[[5,16]])}))).apply(this,arguments)}function c(e){return r.apply(this,arguments)}function r(){return(r=D(j.mark(function e(t){var n,s,r,a,i,o,c,l,u,f,p,m,g;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.state,s=t.commit,r=t.rootState,n.isLoading){e.next=35;break}return d.set(n,"isLoading",!0),a=Math.floor(Date.now()/1e3),i=h(n),o=0,e.next=8,b({state:n,commit:s,rootState:r},i);case 8:if(c=e.sent,o+=c.length,l=Math.floor(Date.now()/1e3),u=i.to>=l&&n.limit&&c.length<n.limit&&!x,f=function(){},u)return e.next=16,w({state:n,commit:s,rootState:r});e.next=28;break;case 16:return f=e.sent,p=Math.floor(Date.now()/1e3),(m=h(n)).from=a,m.to=p,e.next=23,b({state:n,commit:s,rootState:r},m);case 23:g=e.sent,o+=g.length,c.splice.apply(c,[c.length,0].concat(L(g))),e.next=31;break;case 28:if((i.to<l||n.limit&&c.length>=n.limit)&&x)return e.next=31,k({state:n,commit:s,rootState:r});e.next=31;break;case 31:s("limiting",{type:"init",count:o}),s("setHistoryMessages",c),(u||n.realtimeEnabled)&&(f(),s("limiting",{type:"rt_init"})),d.set(n,"isLoading",!1);case 35:case"end":return e.stop()}},e)}))).apply(this,arguments)}function a(){return(a=D(j.mark(function e(t){var n,s,r,a,i,o;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.state,s=t.commit,r=t.rootState,n.isLoading){e.next=21;break}if(d.set(n,"isLoading",!0),a=Math.floor(_(n,'messages[0]["server.timestamp"]',n.to)-1),(i=h(n)).to=a,i.reverse=!0,x&&n.messages.length>2*n.limit)return e.next=10,k({state:n,commit:s,rootState:r});e.next=11;break;case 10:s("limiting",{type:"rt_deinit"});case 11:return e.next=13,b({state:n,commit:s,rootState:r},i);case 13:if((o=e.sent).length){e.next=17;break}return d.set(n,"isLoading",!1),e.abrupt("return",0);case 17:return s("limiting",{type:"prev",count:o.length}),s("prependMessages",o),d.set(n,"isLoading",!1),e.abrupt("return",o.length);case 21:case"end":return e.stop()}},e)}))).apply(this,arguments)}function i(){return(i=D(j.mark(function e(t){var n,s,r,a,i,o,c,l,u,f,p,m,g;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.state,s=t.commit,r=t.rootState,n.isLoading){e.next=34;break}if(n.realtimeEnabled)return e.abrupt("return");e.next=4;break;case 4:return d.set(n,"isLoading",!0),a=Date.now(),i=Math.floor(_(n,"messages[".concat(n.messages.length-1,"]['server.timestamp']"),n.from)+1),o=h(n),c=0,o.from=i,e.next=12,b({state:n,commit:s,rootState:r},o);case 12:if(l=e.sent,c+=l.length,u=o.to>Math.floor(Date.now()/1e3)&&n.limit&&l.length<n.limit&&!x,f=function(){},u)return e.next=19,w({state:n,commit:s,rootState:r});e.next=29;break;case 19:return f=e.sent,p=Date.now(),(m=h(n)).from=Math.floor(a/1e3),m.to=Math.floor(p/1e3),e.next=26,b({state:n,commit:s,rootState:r},m);case 26:g=e.sent,c+=g.length,l.splice.apply(l,[l.length,0].concat(L(g)));case 29:return s("limiting",{type:"next",count:c}),s("appendMessages",l),u&&(f(),s("limiting",{type:"rt_init"})),d.set(n,"isLoading",!1),e.abrupt("return",c);case 34:case"end":return e.stop()}},e)}))).apply(this,arguments)}function l(){return(l=D(j.mark(function e(t,n){var s,r,a,i;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.state,r=t.commit,a=t.rootState,i=s.limit,r("clearMessages"),r("setReverse",!0),r("setLimit",n),e.next=7,c({state:s,commit:r,rootState:a});case 7:r("setReverse",!1),r("setLimit",i);case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}var u=[],x=0;function w(e){return f.apply(this,arguments)}function f(){return(f=D(j.mark(function e(t){var n,s;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.state,s=t.commit,t.rootState,e.next=3,d.connector.subscribeMessagesChannels(n.active,"+",function(e){u.push(JSON.parse(e))},{rh:2});case 3:return n.realtimeEnabled=!0,e.abrupt("return",function(){var e;e=s,x=setInterval(function(){u.length&&(e("setRTMessages",L(u)),u=[])},500)});case 5:case"end":return e.stop()}},e)}))).apply(this,arguments)}function k(e){return p.apply(this,arguments)}function p(){return(p=D(j.mark(function e(t){var n;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.state,x&&(clearInterval(x),u=[],x=0),e.next=4,d.connector.unsubscribeMessagesChannels(n.active,"+");case 4:n.realtimeEnabled=!1;case 5:case"end":return e.stop()}},e)}))).apply(this,arguments)}function m(){return(m=D(j.mark(function e(t){var n,s,r,a,i,o;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.state,s=t.commit,t.rootState.token&&n.active)return e.prev=2,d.set(n,"isLoading",!0),r=n.messages.reduceRight(function(e,t,n){return e||("offline"===t.__connectionStatus&&(e=n),e)},0),a={from:r?Math.floor(n.messages[r-1]["server.timestamp"])+1:0,to:Math.floor(n.messages[r+1]["server.timestamp"])},e.next=8,d.connector.gw.getChannelsMessages(n.active,{data:JSON.stringify(a)});e.next=20;break;case 8:i=e.sent,v(o=i.data),s("setMissingMessages",{data:o.result,index:r}),d.set(n,"isLoading",!1),e.next=20;break;case 15:e.prev=15,e.t0=e.catch(2),g&&g(e.t0),DEV&&console.log(e.t0),d.set(n,"isLoading",!1);case 20:case"end":return e.stop()}},e,null,[[2,15]])}))).apply(this,arguments)}function M(e){return S.apply(this,arguments)}function S(){return(S=D(j.mark(function e(t){var n;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.state).hasNewMessages=!1,e.next=4,d.connector.subscribeMessagesChannels(n.active,"+",function(){n.hasNewMessages=!0,k({state:n})},{rh:2});case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}return{getMessages:b,get:c,getPrevPage:function(e){return a.apply(this,arguments)},getNextPage:function(e){return i.apply(this,arguments)},pollingGet:w,getCols:function(e,t){return n.apply(this,arguments)},getHistory:function(e,t){return l.apply(this,arguments)},initTime:function(e){return t.apply(this,arguments)},unsubscribePooling:k,getMissedMessages:function(e){return m.apply(this,arguments)}}}function M(e){var s=e.Vue,o=e.LocalStorage,l=e.filterHandler,u=e.newMessagesInterseptor,r=0;function f(n){n.length&&n.forEach(function(e,t){n[t]["x-flespi-message-key"]=r++})}function n(e){e.messages.splice(0,e.messages.length),u&&u([]),m(e)}function p(e,t){var n=t.type,s=t.count;if(!e.limit)return!1;var r=e.messages,a=e.pages;switch(n){case"init":e.pages=s?[s]:[];break;case"prev":if(!s)break;if(3===a.length){var i=a[2];e.pages=[s].concat(L(a.slice(0,-1))),r.splice(r.length-i,i)}else e.pages=[s].concat(L(a));break;case"next":if(!s)break;var o=a.length;if(3===o){var c=a[0];e.pages=[].concat(L(a.slice(1,3)),[s]),r.splice(0,c)}else o<3&&a.push(s);break;case"rt_init":a.push(0);break;case"rt_deinit":var l=a.pop();r.splice(r.length-l,l);break;case"rt":var u=a.length,f=a[u-1]||0;if(f+s>e.limit)if(3<u){var p=a[0];e.pages=[].concat(L(a.slice(1,-1)),[f+s,0]),r.splice(0,p)}else e.pages=[].concat(L(a.slice(0,-1)),[f+s,0]);else e.pages[u-1]=f+s}}function t(){return(t=D(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n(t),t.filter="",t.from=0,t.to=0,t.limit=1e3,t.reverse=!1,e.next=8,s.connector.unsubscribeMessagesChannels(t.active);case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}function a(e,t){var n=function(e){var t={};if(e.lsNamespace){var n=e.lsNamespace.split("."),s=n.shift(),r="".concat(n.join("."),".").concat(e.name),a=o.getItem(s);t=_(a,r,t)}else t=o.getItem(e.name)||t;return t}(e);if(n[e.active]=t,e.lsNamespace){var s=e.lsNamespace.split("."),r=s.shift(),a="".concat(s.join("."),".").concat(e.name),i=o.getItem(r);g(i,a,n),o.set(r,i)}else o.set(e.name,n)}function i(e,t){a(e,t),s.set(e,"cols",t)}var c=i;function m(e){s.set(e,"selected",[])}return{setOffline:function(e,t){t&&e.messages.push({__connectionStatus:"offline",timestamp:Date.now()/1e3}),e.offline=!0},setReconnected:function(e,t){t&&e.messages.push({__connectionStatus:"reconnected",timestamp:Date.now()/1e3}),e.offline=!1},setHistoryMessages:function(e,t){e.reverse&&t.reverse(),f(t),u&&u(t),e.messages=t},setRTMessages:function(e,t){if(t&&t.length){e.filter&&l&&(t=l(e.filter,t)),f(t);var n=e.messages;if(e.sortBy){var s=t[0],r=e.sortBy,a=e.messages.length-1,i=null,o=!0;if(0<a)for(var c=a;0!==c||o;c--)!(n[c][r]>s[r]&&0!==(i=c)||!(o=!1));u&&u(t),i?n.splice.apply(n,[i,0].concat(L(t))):n.splice.apply(n,[n.length,0].concat(L(t)))}else u&&u(t),n.splice.apply(n,[n.length,0].concat(L(t)));p(e,{type:"rt",count:t.length})}},setMissingMessages:function(e,t){var n,s=t.data,r=t.index;s.forEach(function(e){e["x-flespi-status"]="missed"}),(n=e.messages).splice.apply(n,[r+1,0].concat(L(s)))},prependMessages:function(e,t){if(t&&t.length){t.reverse();var n=e.messages;f(t),u&&u(t),n.splice.apply(n,[0,0].concat(L(t)))}},appendMessages:function(e,t){if(t&&t.length){var n=e.messages;f(t),u&&u(t),n.splice.apply(n,[n.length,0].concat(L(t)))}},clearMessages:n,setLimit:function(e,t){s.set(e,"limit",t)},limiting:p,setFilter:function(e,t){e.filter!==t&&s.set(e,"filter",t)},setFrom:function(e,t){s.set(e,"from",t)},setTo:function(e,t){s.set(e,"to",t)},reqStart:function(){DEV&&console.log("Start Request Channels messages")},setReverse:function(e,t){s.set(e,"reverse",t)},clear:function(e){return t.apply(this,arguments)},setActive:function(e,t){s.set(e,"active",t)},setCols:i,updateCols:c,setDefaultCols:function(n){n.cols.forEach(function(e,t){e.__dest||(n.defaultColsNames.includes(e.name)?s.set(n.cols[t],"display",!0):s.set(n.cols[t],"display",!1))}),c(n,n.cols)},setSelected:function(e,t){s.set(e,"selected",t)},clearSelected:m,setSortBy:function(e,t){s.set(e,"sortBy",t)},clearSortBy:function(e){s.set(e,"sortBy",null)},setSettings:function(e,t){s.set(e,"settings",t)}}}e.default=function(e){var t=e.Vue,n=e.LocalStorage,s=e.name,r=e.errorHandler,a=e.filterHandler,i=e.newMessagesInterseptor,o=_(s,"lsNamespace",void 0);return{namespaced:!0,state:{name:s=_(s,"name",s),lsNamespace:o,isLoading:!1,active:0,messages:[],pages:[],filter:"",settings:{},realtimeEnabled:!1,from:0,to:0,limit:1e3,reverse:!1,cols:[],defaultColsNames:["timestamp","server.timestamp","ident","position.latitude","position.longitude","position.altitude","position.speed"],offline:!1,selected:[],sortBy:null,hasNewMessages:null},actions:k({Vue:t,LocalStorage:n,errorHandler:r}),mutations:M({Vue:t,LocalStorage:n,filterHandler:a,newMessagesInterseptor:i})}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=channelsMessagesSerial.js.map
