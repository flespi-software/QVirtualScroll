!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es.array.push.js"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es.array.push.js","lodash/get","lodash/set"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).containersMessages={},null,e._get,e._set)}(this,(function(e,t,s,n){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=i(s),a=i(n);function r(e,t,s){let n={};if(t){const i=t.split("."),a=i.shift(),r=`${i.join(".")}.${s}`,c=e.getItem(a);n=o.default(c,r,n)}else n=e.getItem(s)||n;return n}const c=["key","etc"],l="key";function g({Vue:e,LocalStorage:t,errorHandler:s,logger:n}){function i(e){const t={};return e.limit&&(t.max_count=e.limit),e.filter&&(t.filter=`${e.filter}`),e.from&&(t.left_key=e.from/1e3),e.to&&(t.right_key=e.to/1e3),e.reverse&&(t.reverse=e.reverse),t}function a(e,t){t.errors?(e("reqError",t.errors),t.errors.forEach((e=>{const t=new Error(e.reason);s&&s(t)}))):e("reqFullfiled")}function g(){const e=(new Date).toString().match(/([-+][0-9]+)\s/)[1];return c.reduce(((t,s)=>(t[s]={name:s},s.match(/timestamp$/)&&(t[s].addition=`${e.slice(0,3)}:${e.slice(3)}`,t[s].type="",t[s].unit=""),t)),{})}async function f({state:t,commit:n,rootState:i},o){let r=[];if(i.token&&t.active){const i=t.isLoading;try{!i&&e.set(t,"isLoading",!0);const s=await e.connector.storage.getContainersMessages(t.active,{data:JSON.stringify(o)});n("reqStart",{endpoint:"getContainersMessages",active:t.active,data:JSON.stringify(o)});const c=s.data;a(n,c),!i&&e.set(t,"isLoading",!1),r=c.result||[]}catch(n){s&&s(n),DEV&&console.log(n),!i&&e.set(t,"isLoading",!1)}}return r}async function m({state:e,commit:t,rootState:s},n){const o={...i(e),left_key:e.from/1e3,right_key:n,reverse:!0,max_count:e.limit/2},a=await f({state:e,commit:t,rootState:s},o),r={left_key:n+1e-6,right_key:e.to/1e3,max_count:e.limit-a.length},c=await f({state:e,commit:t,rootState:s},r);return[...a.reverse(),...c]}async function u({state:t,commit:s,rootState:n},o){if(!t.isLoading){e.set(t,"isLoading",!0),h&&await y({state:t,commit:s,rootState:n});const a=(Date.now()+999e-6)/1e3;let r=0,c=[];const l=i(t);c=o?await m({state:t,commit:s,rootState:n},o):await f({state:t,commit:s,rootState:n},l),r+=c.length;const g=(Date.now()+999e-6)/1e3,u=l.right_key>=g&&t.limit&&c.length<t.limit&&!h;let d=()=>{};if(u){if(d=await p({state:t,commit:s,rootState:n}),o){const e=(Date.now()+999e-6)/1e3,o=i(t);o.left_key=a,o.right_key=e;const l=await f({state:t,commit:s,rootState:n},o);r+=l.length,c.splice(0,0,...l)}}else(l.right_key<g||t.limit&&c.length>=t.limit)&&h&&await y({state:t,commit:s,rootState:n});s("limiting",{type:"init",count:r}),s("setHistoryMessages",c),(u||t.realtimeEnabled)&&(d(),s("limiting",{type:"rt_init"})),e.set(t,"isLoading",!1)}}let d=[],h=0;async function p({state:t,commit:s,rootState:i}){const o=t.filter?`$filter/payload=${encodeURIComponent(t.filter)}`:void 0;return await e.connector.subscribeMessagesDevices(t.active,(e=>{d.push(JSON.parse(e))}),{rh:2,prefix:o}),t.realtimeEnabled=!0,n.info(`subscribed to messagesDevices ${t.active} ${o||""}`),()=>{h=function(e,t){return setInterval((()=>{d.length&&(t("setRTMessages",[...d]),d=[])}),500)}(0,s)}}async function y({state:t}){h&&(clearInterval(h),d=[],h=0);const s=t.filter?`$filter/payload=${encodeURIComponent(t.filter)}`:void 0;await e.connector.unsubscribeMessagesDevices(t.active,void 0,{prefix:s}),t.realtimeEnabled=!1,n.info(`unsubscribed to messagesDevices ${t.active} ${s||""}`)}return{getMessages:f,get:u,getPrevPage:async function({state:t,commit:s,rootState:n}){if(!t.isLoading){e.set(t,"isLoading",!0);const a=o.default(t,"messages[0]."+l,t.to)-1e-6,r=i(t);r.right_key=a,r.reverse=!0,h&&t.messages.length>2*t.limit&&(await y({state:t,commit:s,rootState:n}),s("limiting",{type:"rt_deinit"}));const c=await f({state:t,commit:s,rootState:n},r);return c.length?(s("limiting",{type:"prev",count:c.length}),s("prependMessages",c),e.set(t,"isLoading",!1),c.length):(e.set(t,"isLoading",!1),0)}},getNextPage:async function({state:t,commit:s,rootState:n}){if(!t.isLoading){if(t.realtimeEnabled)return;e.set(t,"isLoading",!0);const a=Date.now(),r=o.default(t,`messages[${t.messages.length-1}].${l}`,t.from)+1e-6,c=i(t);let g=0;c.left_key=r;const m=await f({state:t,commit:s,rootState:n},c);g+=m.length;const u=c.right_key>Math.floor(Date.now()/1e3)&&t.limit&&m.length<t.limit&&!h;let d=()=>{};if(u){d=await p({state:t,commit:s,rootState:n});const e=Date.now(),o=i(t);o.left_key=a/1e3,o.right_key=e/1e3;const r=await f({state:t,commit:s,rootState:n},o);g+=r.length,m.splice(m.length,0,...r)}return s("limiting",{type:"next",count:g}),s("appendMessages",m),u&&(d(),s("limiting",{type:"rt_init"})),e.set(t,"isLoading",!1),g}},pollingGet:p,getCols:async function({state:e,commit:s}){let n=r(t,e.lsNamespace,e.name);const i=n&&n["custom-cols-schemas"]?n["custom-cols-schemas"]:{};n=n[e.active];const o=n||{activeSchema:"_default",schemas:{_default:{name:"_default",cols:c.map((e=>({name:e,width:150})))}},enum:g()};o.enum||(o.enum=g()),o.schemas={...o.schemas,...i},o.enum.etc={name:"etc",__dest:"etc"},s("setCols",o)},getHistory:async function({state:e,commit:t,rootState:s},n){const i=e.limit;t("clearMessages"),t("setReverse",!0),t("setLimit",n),await u({state:e,commit:t,rootState:s}),t("setReverse",!1),t("setLimit",i)},getMessagesByInitTimestamp:m,initTime:async function({state:t,commit:i,rootState:o}){if(o.token&&t.active)try{e.set(t,"isLoading",!0);const s={reverse:!0,max_count:1,fields:l+""},o=await e.connector.storage.getContainersMessages(t.active,{data:JSON.stringify(s)});i("reqStart",{endpoint:"getContainersMessages-initTime",active:t.active,data:JSON.stringify(s)});const r=o.data;a(i,r);let c=Date.now();r.result.length&&(c=Math.round(1e3*r.result[0][l]));const g=function(e){const t=e||Date.now(),s=new Date(t).setHours(0,0,0,0);return{from:s,to:s+86399999.999}}(c);i("setFrom",g.from),i("setTo",g.to),g.to<Date.now()&&await async function({state:t}){t.hasNewMessages=!1,await e.connector.subscribeMessagesDevices(t.active,(()=>{t.hasNewMessages=!0,y({state:t})}),{rh:2}),n.info(`newMessagesCheck subscribed to messagesDevice ${t.active}`)}({state:t}),e.set(t,"isLoading",!1)}catch(n){s&&s(n),DEV&&console.log(n),e.set(t,"isLoading",!1)}},unsubscribePooling:y,getMissedMessages:async function({state:t,commit:n,rootState:i}){if(i.token&&t.active)try{e.set(t,"isLoading",!0);const{start:s,end:i,lastMessageIndex:o}=t.offline,r={left_key:s,right_key:i};t.filter&&(r.data.filter=t.filter);const c=await e.connector.storage.getContainersMessages(t.active,{data:JSON.stringify(r)});n("reqStart",{endpoint:"getContainersMessages",active:t.active,data:JSON.stringify(r)});const l=c.data;a(n,l),n("setMissingMessages",{data:l.result,index:o}),e.set(t,"isLoading",!1)}catch(n){s&&s(n),DEV&&console.log(n),e.set(t,"isLoading",!1)}}}}function f({Vue:e,LocalStorage:t,newMessagesInterseptor:s,logger:n}){let i=0;function o(e){e.length&&e.forEach(((t,s)=>{Object.defineProperty(e[s],"x-flespi-message-key",{value:i++,enumerable:!1})}))}function c(e){e.messages.splice(0,e.messages.length),s&&s([]),f(e),n.info("clearMessages")}function l(e,{type:t,count:s}){if(!e.limit)return!1;const i=e.messages,o=e.pages;switch(t){case"init":e.pages=s?[s]:[];break;case"prev":if(!s)break;if(3===o.length){const t=o[2];e.pages=[s,...o.slice(0,-1)],i.splice(i.length-t,t)}else e.pages=[s,...o];break;case"next":{if(!s)break;const t=o.length;if(3===t){const t=o[0];e.pages=[...o.slice(1,3),s],i.splice(0,t)}else t<3&&o.push(s);break}case"rt_init":o.push(0);break;case"rt_deinit":{const e=o.pop();i.splice(i.length-e,e);break}case"rt":{const t=o.length,n=o[t-1]||0;if(n+s>e.limit)if(t>3){const t=o[0];e.pages=[...o.slice(1,-1),n+s,0],i.splice(0,t)}else e.pages=[...o.slice(0,-1),n+s,0];else e.pages[t-1]=n+s}}n.info(`limiting: ${t} - count: ${s}`)}function g(s,n){!function(e,t,s,n,i){const o=r(e,t,s)||{},{customColsSchema:c,defaultColsSchema:l}=function(e){return{customColsSchema:{...e.schemas,_default:void 0,_protocol:void 0,_unsaved:void 0},defaultColsSchema:{activeSchema:e.activeSchema,schemas:{_default:e.schemas._default,_protocol:e.schemas._protocol,_unsaved:e.schemas._unsaved}}}}(i);if(o[n]=l,o["custom-cols-schemas"]={...c},t){const n=t.split("."),i=n.shift(),r=`${n.join(".")}.${s}`,c=e.getItem(i)||{};a.default(c,r,o),e.set(i,c)}else e.set(s,o)}(t,s.lsNamespace,s.name,s.active,n),e.set(s,"cols",n)}function f(t){e.set(t,"selected",[])}return{setOffline:function(e){e.offline={start:Date.now()/1e3,lastMessageIndex:e.messages.length-1},n.info("setOffline")},setReconnected:function(e){e.offline.end=Date.now()/1e3,n.info("setReconnected")},clearOfflineState:function(e){e.offline=!1},setMissingMessages:function(e,{data:t,index:s}){e.messages.splice(s+1,0,...t),n.info(`setMissingMessages: ${t.length}`)},setHistoryMessages:function(e,t){e.reverse&&t.reverse(),o(t),s&&s(t),e.messages=t,n.info(`setHistoryMessages: length: ${t.length}, reverse:${e.reverse}`)},setRTMessages:function(e,t){if(t&&t.length){o(t);const i=e.messages;if(e.sortBy){const n=t[0],o=e.sortBy,a=e.messages.length-1;let r=null,c=!0;if(a>0)for(let e=a;0!==e||c;e--)i[e][o]>n[o]?(r=e,0===e&&(c=!1)):c=!1;s&&s(t),r?i.splice(r,0,...t):i.splice(i.length,0,...t)}else s&&s(t),i.splice(i.length,0,...t);l(e,{type:"rt",count:t.length}),n.info(`setRTMessages: length: ${t.length}`)}},prependMessages:function(e,t){if(t&&t.length){t.reverse();const n=e.messages;o(t),s&&s(t),n.splice(0,0,...t)}n.info(`prependMessages: length: ${t.length}`)},appendMessages:function(e,t){if(t&&t.length){const n=e.messages;o(t),s&&s(t),n.splice(n.length,0,...t)}n.info(`appendMessages: length: ${t.length}`)},clearMessages:c,setLimit:function(t,s){e.set(t,"limit",s)},limiting:l,setFilter:function(t,s){t.filter!==s&&e.set(t,"filter",s),n.info(`setFilter: ${s}`)},setFrom:function(t,s){e.set(t,"from",s),n.info(`setFrom: ${s}`)},setTo:function(t,s){e.set(t,"to",s),n.info(`setTo: ${s}`)},reqStart:function(e,t){n.info(`reqStart: ${JSON.stringify(t)}`)},reqFullfiled:function(){n.info("reqFullfiled")},reqError:function(e,t){n.info(`reqError: ${JSON.stringify(t)}`)},setReverse:function(t,s){e.set(t,"reverse",s),n.info(`setReverse: ${s}`)},clear:async function(t){c(t),t.filter="",t.from=0,t.to=0,t.limit=1e3,t.reverse=!1,await e.connector.unsubscribeMessagesDevices(t.active),n.info("clear module"),n.info(`unsubscribeMessagesDevices ${t.active}`)},setActive:function(t,s){e.set(t,"active",s),n.info(`setActive: ${s}`)},setCols:g,updateCols:g,setSelected:function(t,s){e.set(t,"selected",s)},clearSelected:f,setSortBy:function(t,s){e.set(t,"sortBy",s)},clearSortBy:function(t){e.set(t,"sortBy",null)},setSettings:function(t,s){e.set(t,"settings",s),n.info(`setSettings: ${s}`)}}}class m{constructor(e="ModuleLogger"){this.name=`[${e}]`}extendName(e){return new m(`${this.name}[${e}]`)}info(){console.info(...Array.from(arguments).map((e=>`${this.name} ${e}`)))}error(){console.error(...Array.from(arguments).map((e=>`${this.name} ${e}`)))}warn(){console.warn(...Array.from(arguments).map((e=>`${this.name} ${e}`)))}}e.default=function({Vue:e,LocalStorage:t,name:s,errorHandler:n,newMessagesInterseptor:i}){const a=o.default(s,"lsNamespace",void 0);s=o.default(s,"name",s);const r=e.$logger?e.$logger.extendName(s):new m(s);return{namespaced:!0,state:{name:s,lsNamespace:a,isLoading:!1,active:0,messages:[],pages:[],filter:"",settings:{},realtimeEnabled:!1,from:0,to:0,limit:1e3,reverse:!1,cols:void 0,offline:!1,selected:[],sortBy:null,hasNewMessages:null},actions:g({Vue:e,LocalStorage:t,errorHandler:n,logger:r}),mutations:f({Vue:e,LocalStorage:t,newMessagesInterseptor:i,logger:r})}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=containersMessages.js.map
