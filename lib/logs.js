!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es.array.reverse.js"),require("core-js/modules/es.array.reduce.js"),require("core-js/modules/web.dom-collections.iterator.js"),require("core-js/modules/es.string.replace.js"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es.array.reverse.js","core-js/modules/es.array.reduce.js","core-js/modules/web.dom-collections.iterator.js","core-js/modules/es.string.replace.js","lodash/get","lodash/set"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).logs={},null,null,null,null,e.get,e.set)}(this,(function(e,t,s,o,n,i,a){"use strict";function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=r(i),l=r(a);function d(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var m={exports:{}},u={exports:{}};!function(e){e.exports=function(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e},e.exports.default=e.exports,e.exports.__esModule=!0}(u),function(e){var t=u.exports;function s(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,o)}return s}e.exports=function(e){for(var o=1;o<arguments.length;o++){var n=null!=arguments[o]?arguments[o]:{};o%2?s(Object(n),!0).forEach((function(s){t(e,s,n[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e},e.exports.default=e.exports,e.exports.__esModule=!0}(m);var f=d(m.exports);const g=(new Date).toString().match(/([-+][0-9]+)\s/)[1];var p=[{name:"timestamp",width:100,description:"Log event time",addition:`${g.slice(0,3)}:${g.slice(3)}`},{name:"event_code",title:"event",width:400,description:"Log event code and description"},{name:"ident",width:150,description:"Connected device's identification string"},{name:"msgs",width:85,description:"Number of messages received"},{name:"recv",width:85,description:"Number of bytes received"},{name:"send",width:85,description:"Number of bytes sent"},{name:"source",width:150,description:"Connected device's address"},{name:"host",width:150,description:"IP address from which HTTP request was received"},{name:"duration",width:85,description:"Connection duration in seconds"},{name:"transport",width:85,description:"Connected device's transport: tcp, udp, http etc"}];function h(e,t,s){let o={};if(t){const n=t.split("."),i=n.shift(),a=`${n.join(".")}.${s}`,r=e.getItem(i);o=c.default(r,a,o)}else o=e.getItem(s)||o;return o}function w(e,t,s,o,n){const i=h(e,t,s)||{},{customColsSchema:a,defaultColsSchema:r}=function(e){return{customColsSchema:f(f({},e.schemas),{},{_default:void 0,_protocol:void 0,_unsaved:void 0}),defaultColsSchema:{activeSchema:e.activeSchema,schemas:{_default:e.schemas._default,_protocol:e.schemas._protocol,_unsaved:e.schemas._unsaved}}}}(n);if(i[o]=r,i["custom-cols-schemas"]=f({},a),t){const o=t.split("."),n=o.shift(),a=`${o.join(".")}.${s}`,r=e.getItem(n)||{};l.default(r,a,i),e.set(n,r)}else e.set(s,i)}function y({Vue:e,LocalStorage:t,errorHandler:s}){function o(e){const t={filter:[]};return e.limit&&(t.count=e.limit),e.filter&&t.filter.push(`${e.filter}`),e.from&&(t.from=Math.floor(e.from/1e3)),e.to&&(t.to=Math.floor(e.to/1e3)),e.reverse&&(t.reverse=e.reverse),t.filter.length?t.filter=t.filter.join(","):delete t.filter,t}function n(e){const t={};return e.cid&&(t["x-flespi-cid"]=e.cid),t}function i(e,t,s){const o=t||p,n={activeSchema:"_default",schemas:{_default:{name:"_default",cols:o.map((e=>f({},e)))},_protocol:{name:"_protocol",cols:o.map((e=>f({},e)))}},enum:o.reduce(((e,t)=>(e[t.name]=f({},t),delete e[t.name].display,delete e[t.name].width,e)),{})};if(s&&s.length&&JSON.stringify(o)!==JSON.stringify(n.schemas._default.cols)){const t=`Custom[${e}]`;n.activeSchema=t,n.schemas[t]={name:t,cols:s.reduce(((e,t)=>(t.display&&e.push({name:t.name,width:t.width}),e)),[])}}return n}function a(e){e.errors&&e.errors.forEach((e=>{const t=new Error(e.reason);s&&s(t)}))}function r(t,s){const o=t.split("/"),n=o.pop(),i=s?e.connector.http.platform.deleted:o.reduce(((e,t)=>e[t]),e.connector.http);return"*"===n?function(e){return i.logs.get({data:JSON.stringify(e.data)},{headers:e.headers})}:s?function(e){return i.logs.get(encodeURIComponent(`origin=${t}`),{data:JSON.stringify(e.data)},{headers:e.headers})}:function(e){return i.logs.get(n,{data:JSON.stringify(e.data)},{headers:e.headers})}}async function l({state:t,commit:o,rootState:i},c){o("reqStart");let l=[];if(i.token&&t.origin){const o=t.isLoading;try{!o&&e.set(t,"isLoading",!0);const s=(await r(t.origin,t.isItemDeleted)({data:c,headers:n(t)})).data;a(s),!o&&e.set(t,"isLoading",!1),l=s.result||[]}catch(n){s&&s(n),DEV&&console.log(n),!o&&e.set(t,"isLoading",!1)}}return l}async function d({state:t,commit:s,rootState:n}){if(!t.isLoading){e.set(t,"isLoading",!0);const i=Math.floor(Date.now()/1e3),a=o(t);let r=0;const c=await l({state:t,commit:s,rootState:n},a);r+=c.length;const d=Math.floor(Date.now()/1e3),m=a.to>=d&&t.limit&&c.length<t.limit&&!u;let f=()=>{};if(m){f=await g({state:t,commit:s,rootState:n});const e=Math.floor(Date.now()/1e3),a=o(t);a.from=i,a.to=e;const d=await l({state:t,commit:s,rootState:n},a);r+=d.length,c.splice(c.length,0,...d)}else(a.to<d||t.limit&&c.length>=t.limit)&&u&&await y({state:t,commit:s,rootState:n});s("limiting",{type:"init",count:r}),s("setHistoryMessages",c),(m||t.realtimeEnabled)&&(f(),s("limiting",{type:"rt_init"})),e.set(t,"isLoading",!1)}}let m=[],u=0;async function g({state:t,commit:s,rootState:o}){const n=t.origin.split("/")[0].replace(/\*/g,"+"),i=t.origin.replace(`${n}/`,"").replace(/\*/g,"+"),a=t.filter?`$filter/payload=${encodeURIComponent(t.filter)}${t.cid?`&cid=${t.cid}`:""}`:void 0;return await e.connector.subscribeLogs(n,i,"#",(e=>{m.push(JSON.parse(e))}),{rh:2,prefix:a}),t.realtimeEnabled=!0,()=>{u=function(e,t){return setInterval((()=>{m.length&&(t("setRTMessages",[...m]),m=[])}),500)}(0,s)}}async function y({state:t}){const s=t.origin.split("/")[0].replace(/\*/g,"+"),o=t.origin.replace(`${s}/`,"").replace(/\*/g,"+");u&&(clearInterval(u),m=[],u=0);const n=t.filter?`$filter/payload=${encodeURIComponent(t.filter)}${t.cid?`&cid=${t.cid}`:""}`:void 0;await e.connector.unsubscribeLogs(s,o,"#",void 0,{prefix:n}),t.realtimeEnabled=!1}return{getLogs:l,get:d,getPrevPage:async function({state:t,commit:s,rootState:n}){if(!t.isLoading){e.set(t,"isLoading",!0);const i=Math.floor(c.default(t,"messages[0].timestamp",t.to)-1),a=o(t);a.to=i,a.reverse=!0,u&&t.messages.length>2*t.limit&&(await y({state:t,commit:s,rootState:n}),s("limiting",{type:"rt_deinit"}));const r=await l({state:t,commit:s,rootState:n},a);return r.length?(s("limiting",{type:"prev",count:r.length}),s("prependMessages",r),e.set(t,"isLoading",!1),r.length):(e.set(t,"isLoading",!1),0)}},getNextPage:async function({state:t,commit:s,rootState:n}){if(!t.isLoading){if(t.realtimeEnabled)return;e.set(t,"isLoading",!0);const i=Date.now(),a=Math.floor(c.default(t,`messages[${t.messages.length-1}].timestamp`,t.from)+1),r=o(t);let d=0;r.from=a;const m=await l({state:t,commit:s,rootState:n},r);d+=m.length;const f=r.to>Math.floor(Date.now()/1e3)&&t.limit&&m.length<t.limit&&!u;let p=()=>{};if(f){p=await g({state:t,commit:s,rootState:n});const e=Date.now(),a=o(t);a.from=Math.floor(i/1e3),a.to=Math.floor(e/1e3);const r=await l({state:t,commit:s,rootState:n},a);d+=r.length,m.splice(m.length,0,...r)}return s("limiting",{type:"next",count:d}),s("appendMessages",m),f&&(p(),s("limiting",{type:"rt_init"})),e.set(t,"isLoading",!1),d}},pollingGet:g,getHistory:async function({state:e,commit:t,rootState:s},o){const n=e.limit;t("clearMessages"),t("setReverse",!0),t("setLimit",o),await d({state:e,commit:t,rootState:s}),t("setReverse",!1),t("setLimit",n)},initTime:async function({state:t,commit:o,rootState:i}){if(i.token&&t.origin)try{e.set(t,"isLoading",!0);const s={data:{reverse:!0,count:1,fields:"timestamp"},headers:n(t)},i=(await r(t.origin,t.isItemDeleted)(s)).data;a(i);let c=Date.now();i.result.length&&(c=Math.round(1e3*i.result[0].timestamp));const l=function(e){const t=e||Date.now(),s=new Date(t).setHours(0,0,0,0);return{from:s,to:s+86399999}}(c);o("setFrom",l.from),o("setTo",l.to),l.to<Date.now()&&await async function({state:t}){const s=t.origin.split("/")[0].replace(/\*/g,"+"),o=t.origin.replace(`${s}/`,"").replace(/\*/g,"+");let n={};t.cid&&(n={userProperties:{cid:t.cid}});t.hasNewMessages=!1,await e.connector.subscribeLogs(s,o,"#",(()=>{t.hasNewMessages=!0,y({state:t})}),{rh:2,properties:n})}({state:t}),e.set(t,"isLoading",!1)}catch(o){s&&s(o),DEV&&console.log(o),e.set(t,"isLoading",!1)}},getCols:function({state:e,commit:s},o){const n={activeSchema:"_default",schemas:{_default:{name:"_default",cols:(a=o||p).map((e=>({name:e.name,width:e.width})))}},enum:a.reduce(((e,t)=>(e[t.name]=f({},t),delete e[t.name].width,e)),{})};var a;n.schemas._default.cols.push({name:"etc",width:150,__dest:"etc"}),n.enum.etc={name:"etc",__dest:"etc"};const r=h(t,e.lsNamespace,e.name);!function(e,s,o){for(const n in o){let a=o[n];Array.isArray(a)?(a=i(e.origin,s,o[e.origin]),w(t,e.lsNamespace,e.name,n,a),o[n]=a):a.enum&&(delete a.enum,w(t,e.lsNamespace,e.name,n,a),o[n]=a)}}(e,o,r);const c=r&&r["custom-cols-schemas"]?r["custom-cols-schemas"]:{};if(r&&r[e.origin]){const t=r[e.origin];n.activeSchema=t.activeSchema,n.schemas=f(f(f({},n.schemas),t.schemas),c)}s("setCols",n)},unsubscribePooling:y,getMissedMessages:async function({state:t,commit:o,rootState:i}){if(i.token&&t.origin)try{e.set(t,"isLoading",!0);const{start:s,end:i,lastMessageIndex:c}=t.offline,l={data:{from:s,to:i},headers:n(t)},d=(await r(t.origin,t.isItemDeleted)(l)).data;a(d),o("setMissingMessages",{data:d.result,index:c}),e.set(t,"isLoading",!1)}catch(o){s&&s(o),DEV&&console.log(o),e.set(t,"isLoading",!1)}}}}e.default=function({Vue:e,LocalStorage:t,name:s,errorHandler:o,newMessagesInterseptor:n}){const i=c.default(s,"lsNamespace",void 0);s=c.default(s,"name",s);const a=y({Vue:e,LocalStorage:t,errorHandler:o}),r=function({Vue:e,LocalStorage:t,newMessagesInterseptor:s}){let o=0;function n(e){e.length&&e.forEach(((t,s)=>{e[s]["x-flespi-message-key"]=o++}))}function i(e){e.messages.splice(0,e.messages.length),s&&s([]),c(e)}function a(e,{type:t,count:s}){if(!e.limit)return!1;const o=e.messages,n=e.pages;switch(t){case"init":e.pages=s?[s]:[];break;case"prev":if(!s)break;if(3===n.length){const t=n[2];e.pages=[s,...n.slice(0,-1)],o.splice(o.length-t,t)}else e.pages=[s,...n];break;case"next":{if(!s)break;const t=n.length;if(3===t){const t=n[0];e.pages=[...n.slice(1,3),s],o.splice(0,t)}else t<3&&n.push(s);break}case"rt_init":n.push(0);break;case"rt_deinit":{const e=n.pop();o.splice(o.length-e,e);break}case"rt":{const t=n.length,i=n[t-1]||0;if(i+s>e.limit)if(t>3){const t=n[0];e.pages=[...n.slice(1,-1),i+s,0],o.splice(0,t)}else e.pages=[...n.slice(0,-1),i+s,0];else e.pages[t-1]=i+s}}}function r(s,o){w(t,s.lsNamespace,s.name,s.origin,o),e.set(s,"cols",o)}function c(t){e.set(t,"selected",[])}return{setOffline:function(e){e.offline={start:Math.floor(Date.now()/1e3),lastMessageIndex:e.messages.length-1}},setReconnected:function(e){e.offline.end=Math.floor(Date.now()/1e3)},clearOfflineState:function(e){e.offline=!1},setHistoryMessages:function(e,t){e.reverse&&t.reverse(),n(t),s&&s(t),e.messages=t},setRTMessages:function(e,t){if(t&&t.length){n(t);const o=e.messages;s&&s(t),o.splice(o.length,0,...t),a(e,{type:"rt",count:t.length})}},prependMessages:function(e,t){if(t&&t.length){t.reverse();const o=e.messages;n(t),s&&s(t),o.splice(0,0,...t)}},appendMessages:function(e,t){if(t&&t.length){const o=e.messages;n(t),s&&s(t),o.splice(o.length,0,...t)}},clearMessages:i,setLimit:function(t,s){e.set(t,"limit",s)},setFilter:function(t,s){t.filter!==s&&e.set(t,"filter",s)},limiting:a,setFrom:function(t,s){e.set(t,"from",s)},setTo:function(t,s){e.set(t,"to",s)},reqStart:function(){DEV&&console.log("Start Request Logs")},setReverse:function(t,s){e.set(t,"reverse",s)},clear:async function(t){const s=t.origin.split("/")[0],o=t.origin.replace(`${s}/`,"").replace(/\*/g,"+");i(t),t.filter="",t.from=0,t.to=0,t.limit=1e3,t.reverse=!1,await e.connector.unsubscribeLogs(s,o,"#")},setOrigin:function(t,s){e.set(t,"origin",s)},setCols:r,updateCols:r,setMissingMessages:function(e,{data:t,index:s}){e.messages.splice(s+1,0,...t)},setSelected:function(t,s){e.set(t,"selected",s)},clearSelected:c,setItemDeletedStatus:function(t,s){e.set(t,"isItemDeleted",s)},setCid:function(t,s){e.set(t,"cid",s)}}}({Vue:e,LocalStorage:t,newMessagesInterseptor:n});return{namespaced:!0,state:{name:s,lsNamespace:i,isLoading:!1,origin:"",messages:[],pages:[],filter:"",realtimeEnabled:!1,from:0,to:0,cid:null,limit:1e3,reverse:!1,cols:void 0,offline:!1,selected:[],isItemDeleted:!1,hasNewMessages:null},actions:a,mutations:r}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=logs.js.map
