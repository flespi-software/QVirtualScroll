!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es.array.push.js"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es.array.push.js","lodash/get","lodash/set"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).logs={},null,e._get,e._set)}(this,(function(e,t,s,i){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(s),a=n(i);const r=(new Date).toString().match(/([-+][0-9]+)\s/)[1];var c=[{name:"timestamp",width:100,description:"Log event time",addition:`${r.slice(0,3)}:${r.slice(3)}`},{name:"event_code",title:"event",width:400,description:"Log event code and description"},{name:"ident",width:150,description:"Connected device's identification string"},{name:"msgs",width:85,description:"Number of messages received"},{name:"recv",width:85,description:"Number of bytes received"},{name:"send",width:85,description:"Number of bytes sent"},{name:"source",width:150,description:"Connected device's address"},{name:"host",width:150,description:"IP address from which HTTP request was received"},{name:"duration",width:85,description:"Connection duration in seconds"},{name:"transport",width:85,description:"Connected device's transport: tcp, udp, http etc"}];function l(e,t,s){let i={};if(t){const n=t.split("."),a=n.shift(),r=`${n.join(".")}.${s}`,c=e.getItem(a);i=o.default(c,r,i)}else i=e.getItem(s)||i;return i}function g({Vue:e,LocalStorage:t,errorHandler:s,logger:i}){function n(e){const t={filter:[]};return e.limit&&(t.count=e.limit),e.filter&&t.filter.push(`${e.filter}`),e.from&&(t.from=e.from/1e3),e.to&&(t.to=e.to/1e3),e.reverse&&(t.reverse=e.reverse),t.filter.length?t.filter=t.filter.join(","):delete t.filter,t}function a(e){const t={};return e.cid&&(t["x-flespi-cid"]=e.cid),t}function r(e,t){t.errors?(e("reqError",t.errors),t.errors.forEach((e=>{const t=new Error(e.reason);s&&s(t)}))):e("reqFullfiled")}function g(t,s,i){const n=t.split("/"),o=n.pop(),a=s?e.connector.http.platform.deleted:n.reduce(((e,t)=>e[t]),e.connector.http);let r;return r="*"===o?function(e){return i("reqStart",{endpoint:"getLogs",params:e}),a.logs.get({data:JSON.stringify(e.data)},{headers:e.headers})}:s?function(e){return i("reqStart",{endpoint:"getLogs",params:e}),a.logs.get(encodeURIComponent(`origin=${t}`),{data:JSON.stringify(e.data)},{headers:e.headers})}:function(e){return i("reqStart",{endpoint:"getLogs",params:e}),a.logs.get(o,{data:JSON.stringify(e.data)},{headers:e.headers})},r}async function m({state:t,commit:i,rootState:n},o){let c=[];if(n.token&&t.origin){const n=t.isLoading;try{!n&&e.set(t,"isLoading",!0);const s=(await g(t.origin,t.isItemDeleted,i)({data:o,headers:a(t)})).data;r(i,s),!n&&e.set(t,"isLoading",!1),c=s.result||[]}catch(i){s&&s(i),DEV&&console.log(i),!n&&e.set(t,"isLoading",!1)}}return c}async function d({state:e,commit:t,rootState:s},i){const o={...n(e),from:e.from/1e3,to:i,reverse:!0,count:e.limit/2},a=await m({state:e,commit:t,rootState:s},o),r={from:i+1e-6,to:e.to/1e3,count:e.limit-a.length},c=await m({state:e,commit:t,rootState:s},r);return[...a.reverse(),...c]}async function f({state:t,commit:s,rootState:i},o){if(!t.isLoading){e.set(t,"isLoading",!0),p&&await w({state:t,commit:s,rootState:i});const a=(Date.now()+999e-6)/1e3;let r=0,c=[];const l=n(t);c=o?await d({state:t,commit:s,rootState:i},o):await m({state:t,commit:s,rootState:i},l),r+=c.length;const g=(Date.now()+999e-6)/1e3,f=l.to>=g&&t.limit&&c.length<t.limit&&!p;let u=()=>{};if(f){if(u=await h({state:t,commit:s,rootState:i}),o){const e=(Date.now()+999e-6)/1e3,o=n(t);o.from=a,o.to=e;const l=await m({state:t,commit:s,rootState:i},o);r+=l.length,c.splice(0,0,...l)}}else(l.to<g||t.limit&&c.length>=t.limit)&&p&&await w({state:t,commit:s,rootState:i});s("limiting",{type:"init",count:r}),s("setHistoryMessages",c),(f||t.realtimeEnabled)&&(u(),s("limiting",{type:"rt_init"})),e.set(t,"isLoading",!1)}}let u=[],p=0;async function h({state:t,commit:s,rootState:n}){const o=t.origin.split("/")[0].replace(/\*/g,"+"),a=t.origin.replace(`${o}/`,"").replace(/\*/g,"+"),r=t.filter?`$filter/payload=${encodeURIComponent(t.filter)}${t.cid?`&cid=${t.cid}`:""}`:void 0;return await e.connector.subscribeLogs(o,a,"#",(e=>{u.push(JSON.parse(e))}),{rh:2,prefix:r}),t.realtimeEnabled=!0,i.info(`subscribed to Logs ${o} ${a} ${t.active} ${r||""}`),()=>{p=function(e,t){return setInterval((()=>{u.length&&(t("setRTMessages",[...u]),u=[])}),500)}(0,s)}}async function w({state:t}){const s=t.origin.split("/")[0].replace(/\*/g,"+"),n=t.origin.replace(`${s}/`,"").replace(/\*/g,"+");p&&(clearInterval(p),u=[],p=0);const o=t.filter?`$filter/payload=${encodeURIComponent(t.filter)}${t.cid?`&cid=${t.cid}`:""}`:void 0;await e.connector.unsubscribeLogs(s,n,"#",void 0,{prefix:o}),t.realtimeEnabled=!1,i.info(`unsubscribed to Logs ${s} ${n} ${t.active} ${o||""}`)}return{getLogs:m,get:f,getPrevPage:async function({state:t,commit:s,rootState:i}){if(!t.isLoading){e.set(t,"isLoading",!0);const a=o.default(t,"messages[0].timestamp",t.to)-1e-6,r=n(t);r.to=a,r.reverse=!0,p&&t.messages.length>2*t.limit&&(await w({state:t,commit:s,rootState:i}),s("limiting",{type:"rt_deinit"}));const c=await m({state:t,commit:s,rootState:i},r);return c.length?(s("limiting",{type:"prev",count:c.length}),s("prependMessages",c),e.set(t,"isLoading",!1),c.length):(e.set(t,"isLoading",!1),0)}},getNextPage:async function({state:t,commit:s,rootState:i}){if(!t.isLoading){if(t.realtimeEnabled)return;e.set(t,"isLoading",!0);const a=Date.now(),r=o.default(t,`messages[${t.messages.length-1}].timestamp`,t.from)+1e-6,c=n(t);let l=0;c.from=r;const g=await m({state:t,commit:s,rootState:i},c);l+=g.length;const d=c.to>Math.floor(Date.now()/1e3)&&t.limit&&g.length<t.limit&&!p;let f=()=>{};if(d){f=await h({state:t,commit:s,rootState:i});const e=Date.now(),o=n(t);o.from=a/1e3,o.to=e/1e3;const r=await m({state:t,commit:s,rootState:i},o);l+=r.length,g.splice(g.length,0,...r)}return s("limiting",{type:"next",count:l}),s("appendMessages",g),d&&(f(),s("limiting",{type:"rt_init"})),e.set(t,"isLoading",!1),l}},pollingGet:h,getHistory:async function({state:e,commit:t,rootState:s},i){const n=e.limit;t("clearMessages"),t("setReverse",!0),t("setLimit",i),await f({state:e,commit:t,rootState:s}),t("setReverse",!1),t("setLimit",n)},getLogsByInitTimestamp:d,initTime:async function({state:t,commit:n,rootState:o}){if(o.token&&t.origin)try{e.set(t,"isLoading",!0);const s={data:{reverse:!0,count:1,fields:"timestamp"},headers:a(t)},o=(await g(t.origin,t.isItemDeleted,n)(s,n)).data;r(n,o);let c=Date.now();o.result.length&&(c=Math.round(1e3*o.result[0].timestamp));const l=function(e){const t=e||Date.now(),s=new Date(t).setHours(0,0,0,0);return{from:s,to:s+86399999.999}}(c);n("setFrom",l.from),n("setTo",l.to),l.to<Date.now()&&await async function({state:t}){const s=t.origin.split("/")[0].replace(/\*/g,"+"),n=t.origin.replace(`${s}/`,"").replace(/\*/g,"+");let o={};t.cid&&(o={userProperties:{cid:t.cid}});t.hasNewMessages=!1,await e.connector.subscribeLogs(s,n,"#",(()=>{t.hasNewMessages=!0,w({state:t})}),{rh:2,properties:o}),i.info(`newMessagesCheck subscribed to messagesLogs ${s} ${n}`)}({state:t}),e.set(t,"isLoading",!1)}catch(i){s&&s(i),DEV&&console.log(i),e.set(t,"isLoading",!1)}},getCols:function({state:e,commit:s},i){const n={activeSchema:"_default",schemas:{_default:{name:"_default",cols:(o=i||c).map((e=>({name:e.name,width:e.width})))}},enum:o.reduce(((e,t)=>(e[t.name]={...t},delete e[t.name].width,e)),{})};var o;n.schemas._default.cols.push({name:"etc",width:150,__dest:"etc"}),n.enum.etc={name:"etc",__dest:"etc"};const a=l(t,e.lsNamespace,e.name),r=a&&a["custom-cols-schemas"]?a["custom-cols-schemas"]:{};if(a&&a[e.origin]){const t=a[e.origin];n.activeSchema=t.activeSchema,n.schemas={...n.schemas,...t.schemas,...r}}s("setCols",n)},unsubscribePooling:w,getMissedMessages:async function({state:t,commit:i,rootState:n}){if(n.token&&t.origin)try{e.set(t,"isLoading",!0);const{start:s,end:n,lastMessageIndex:o}=t.offline,c={data:{from:s,to:n},headers:a(t)};t.filter&&(c.data.filter=t.filter);const l=(await g(t.origin,t.isItemDeleted,i)(c)).data;r(i,l),i("setMissingMessages",{data:l.result,index:o}),e.set(t,"isLoading",!1)}catch(i){s&&s(i),DEV&&console.log(i),e.set(t,"isLoading",!1)}}}}function m({Vue:e,LocalStorage:t,newMessagesInterseptor:s,logger:i}){let n=0;function o(e){e.length&&e.forEach(((t,s)=>{Object.defineProperty(e[s],"x-flespi-message-key",{value:n++,enumerable:!1})}))}function r(e){e.messages.splice(0,e.messages.length),s&&s([]),m(e),i.info("clearMessages")}function c(e,{type:t,count:s}){if(!e.limit)return!1;const n=e.messages,o=e.pages;switch(t){case"init":e.pages=s?[s]:[];break;case"prev":if(!s)break;if(3===o.length){const t=o[2];e.pages=[s,...o.slice(0,-1)],n.splice(n.length-t,t)}else e.pages=[s,...o];break;case"next":{if(!s)break;const t=o.length;if(3===t){const t=o[0];e.pages=[...o.slice(1,3),s],n.splice(0,t)}else t<3&&o.push(s);break}case"rt_init":o.push(0);break;case"rt_deinit":{const e=o.pop();n.splice(n.length-e,e);break}case"rt":{const t=o.length,i=o[t-1]||0;if(i+s>e.limit)if(t>3){const t=o[0];e.pages=[...o.slice(1,-1),i+s,0],n.splice(0,t)}else e.pages=[...o.slice(0,-1),i+s,0];else e.pages[t-1]=i+s}}i.info(`limiting: ${t} - count: ${s}`)}function g(s,i){!function(e,t,s,i,n){const o=l(e,t,s)||{},{customColsSchema:r,defaultColsSchema:c}=function(e){return{customColsSchema:{...e.schemas,_default:void 0,_protocol:void 0,_unsaved:void 0},defaultColsSchema:{activeSchema:e.activeSchema,schemas:{_default:e.schemas._default,_protocol:e.schemas._protocol,_unsaved:e.schemas._unsaved}}}}(n);if(o[i]=c,o["custom-cols-schemas"]={...r},t){const i=t.split("."),n=i.shift(),r=`${i.join(".")}.${s}`,c=e.getItem(n)||{};a.default(c,r,o),e.set(n,c)}else e.set(s,o)}(t,s.lsNamespace,s.name,s.origin,i),e.set(s,"cols",i)}function m(t){e.set(t,"selected",[])}return{setOffline:function(e){e.offline={start:Date.now()/1e3,lastMessageIndex:e.messages.length-1},i.info("setOffline")},setReconnected:function(e){e.offline.end=Date.now()/1e3,i.info("setReconnected")},clearOfflineState:function(e){e.offline=!1},setHistoryMessages:function(e,t){e.reverse&&t.reverse(),o(t),s&&s(t),e.messages=t,i.info(`setHistoryMessages: length: ${t.length}, reverse:${e.reverse}`)},setRTMessages:function(e,t){if(t&&t.length){o(t);const i=e.messages;s&&s(t),i.splice(i.length,0,...t),c(e,{type:"rt",count:t.length})}i.info(`setRTMessages: length: ${t.length}`)},prependMessages:function(e,t){if(t&&t.length){t.reverse();const i=e.messages;o(t),s&&s(t),i.splice(0,0,...t)}i.info(`prependMessages: length: ${t.length}`)},appendMessages:function(e,t){if(t&&t.length){const i=e.messages;o(t),s&&s(t),i.splice(i.length,0,...t)}i.info(`appendMessages: length: ${t.length}`)},clearMessages:r,setLimit:function(t,s){e.set(t,"limit",s)},setFilter:function(t,s){t.filter!==s&&e.set(t,"filter",s),i.info(`setFilter: ${s}`)},limiting:c,setFrom:function(t,s){e.set(t,"from",s),i.info(`setFrom: ${s}`)},setTo:function(t,s){e.set(t,"to",s),i.info(`setTo: ${s}`)},reqStart:function(e,t){i.info(`reqStart: ${JSON.stringify(t)}`)},reqFullfiled:function(){i.info("reqFullfiled")},reqError:function(e,t){i.info(`reqError: ${JSON.stringify(t)}`)},setReverse:function(t,s){e.set(t,"reverse",s),i.info(`setReverse: ${s}`)},clear:async function(t){const s=t.origin.split("/")[0],n=t.origin.replace(`${s}/`,"").replace(/\*/g,"+");r(t),t.filter="",t.from=0,t.to=0,t.limit=1e3,t.reverse=!1,await e.connector.unsubscribeLogs(s,n,"#"),i.info("clear module"),i.info(`unsubscribeLogs ${s} ${n}`)},setOrigin:function(t,s){e.set(t,"origin",s),i.info(`setOrigin: ${s}`)},setCols:g,updateCols:g,setMissingMessages:function(e,{data:t,index:s}){e.messages.splice(s+1,0,...t),i.info(`setMissingMessages: ${t.length}`)},setSelected:function(t,s){e.set(t,"selected",s)},clearSelected:m,setItemDeletedStatus:function(t,s){e.set(t,"isItemDeleted",s)},setCid:function(t,s){e.set(t,"cid",s),i.info(`setCid: ${s}`)}}}class d{constructor(e="ModuleLogger"){this.name=`[${e}]`}extendName(e){return new d(`${this.name}[${e}]`)}info(){console.info(...Array.from(arguments).map((e=>`${this.name} ${e}`)))}error(){console.error(...Array.from(arguments).map((e=>`${this.name} ${e}`)))}warn(){console.warn(...Array.from(arguments).map((e=>`${this.name} ${e}`)))}}e.default=function({Vue:e,LocalStorage:t,name:s,errorHandler:i,newMessagesInterseptor:n}){const a=o.default(s,"lsNamespace",void 0);s=o.default(s,"name",s);const r=e.$logger?e.$logger.extendName(s):new d(s);return{namespaced:!0,state:{name:s,lsNamespace:a,isLoading:!1,origin:"",messages:[],pages:[],filter:"",realtimeEnabled:!1,from:0,to:0,cid:null,limit:1e3,reverse:!1,cols:void 0,offline:!1,selected:[],isItemDeleted:!1,hasNewMessages:null},actions:g({Vue:e,LocalStorage:t,errorHandler:i,logger:r}),mutations:m({Vue:e,LocalStorage:t,newMessagesInterseptor:n,logger:r})}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=logs.js.map
