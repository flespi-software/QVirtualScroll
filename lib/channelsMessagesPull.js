!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.function.name"),require("@babel/runtime-corejs2/regenerator"),require("core-js/modules/es7.array.includes"),require("core-js/modules/es6.string.includes"),require("core-js/modules/es6.regexp.to-string"),require("core-js/modules/es6.object.to-string"),require("core-js/modules/es6.regexp.match"),require("regenerator-runtime/runtime"),require("core-js/library/fn/array/is-array"),require("core-js/library/fn/array/from"),require("core-js/library/fn/is-iterable"),require("core-js/library/fn/promise")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.function.name","@babel/runtime-corejs2/regenerator","core-js/modules/es7.array.includes","core-js/modules/es6.string.includes","core-js/modules/es6.regexp.to-string","core-js/modules/es6.object.to-string","core-js/modules/es6.regexp.match","regenerator-runtime/runtime","core-js/library/fn/array/is-array","core-js/library/fn/array/from","core-js/library/fn/is-iterable","core-js/library/fn/promise"],t):t((e=e||self).channelsMessagesPull={},0,e._regeneratorRuntime,0,0,0,0,0,0,e.isArray$1,e.from,e.isIterable$1,e.promise$1)}(this,function(e,t,y,r,s,n,a,o,i,c,u,l,f){"use strict";y=y&&y.hasOwnProperty("default")?y.default:y,c=c&&c.hasOwnProperty("default")?c.default:c,u=u&&u.hasOwnProperty("default")?u.default:u,l=l&&l.hasOwnProperty("default")?l.default:l,f=f&&f.hasOwnProperty("default")?f.default:f;var m=c;var d=function(e){if(m(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}},p=u,g=l;var h=function(e){if(g(Object(e))||"[object Arguments]"===Object.prototype.toString.call(e))return p(e)};var v=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var w=function(e){return d(e)||h(e)||v()},b=f;function x(e,t,r,s,n,a,o){try{var i=e[a](o),c=i.value}catch(e){return void r(e)}i.done?t(c):b.resolve(c).then(s,n)}var M=function(i){return function(){var e=this,o=arguments;return new b(function(t,r){var s=i.apply(e,o);function n(e){x(s,t,r,n,a,"next",e)}function a(e){x(s,t,r,n,a,"throw",e)}n(void 0)})}};function _(e){var p=e.Vue,g=e.LocalStorage,h=e.errorHandler;function v(e){e.errors&&e.errors.forEach(function(e){var t=new Error(e.reason);h&&h(t)})}function r(){return(r=M(y.mark(function e(t,r){var s,n,a,o,i,c,u,l,f,m,d;return y.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.state,n=t.commit,a=t.rootState,n("reqStart"),o=r.actions,i=r.etc,!a.token||!s.active){e.next=38;break}if(e.prev=5,p.set(s,"isLoading",!0),c=[],!((u=g.getItem(s.name))&&u[s.active]&&u[s.active])){e.next=15;break}u[s.active].forEach(function(e){if("timestamp"===e.name){var t=(new Date).toString().match(/([-+][0-9]+)\s/)[1];e.addition="".concat(t.slice(0,3),":").concat(t.slice(3))}}),(c=u[s.active])[0].__dest||c[c.length-1].__dest||(c.unshift({name:"actions",width:50,display:o,__dest:"action"}),c.push({name:"etc",width:150,display:i,__dest:"etc"})),e.next=29;break;case 15:return e.next=17,p.connector.gw.getChannels(s.active,{fields:"protocol_id"});case 17:if(l=e.sent,v(f=l.data),f.result&&f.result.length&&f.result[0].protocol_id)return e.next=23,p.connector.gw.getProtocols(f.result[0].protocol_id,{fields:"message_parameters"});e.next=27;break;case 23:m=e.sent,v(d=m.data),d.result[0].message_parameters.forEach(function(e){var t={name:e.name,width:160,display:s.defaultColsNames.includes(e.name),description:e.info};if("timestamp"===t.name){var r=(new Date).toString().match(/([-+][0-9]+)\s/)[1];t.addition="".concat(r.slice(0,3),":").concat(r.slice(3))}c.push(t)});case 27:c.unshift({name:"actions",width:50,display:o,__dest:"action"}),c.push({name:"etc",width:150,display:i,__dest:"etc"});case 29:n("setCols",c),p.set(s,"isLoading",!1),e.next=38;break;case 33:e.prev=33,e.t0=e.catch(5),h&&h(e.t0),DEV&&console.log(e.t0),p.set(s,"isLoading",!1);case 38:case"end":return e.stop()}},e,null,[[5,33]])}))).apply(this,arguments)}function o(e){return t.apply(this,arguments)}function t(){return(t=M(y.mark(function e(s){var n,a,o,i;return y.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=s.state,s.commit,a=s.rootState,o={},a.token&&n.active)return e.prev=3,e.next=6,p.connector.gw.getChannelsMessages(n.active,{data:JSON.stringify((r=void 0,r={},(t=n).limit&&(r.limit_count=t.limit),t.from&&(r.curr_key=t.from),r))});e.next=16;break;case 6:i=e.sent,v(o=i.data),e.next=16;break;case 11:e.prev=11,e.t0=e.catch(3),h&&h(e.t0),DEV&&console.log(e.t0),o={errors:[e.t0]};case 16:return e.abrupt("return",o);case 17:case"end":return e.stop()}var t,r},e,null,[[3,11]])}))).apply(this,arguments)}function s(){return(s=M(y.mark(function e(t){var r,s,n,a;return y.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,s=t.commit,n=t.rootState,s("reqStart"),p.set(r,"isLoading",!0),e.next=5,o({state:r,commit:s,rootState:n});case 5:(a=e.sent).result&&(s("setMessages",a.result),s("setTo",a.next_key)),p.set(r,"isLoading",!1);case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}var i=[],c=0;function u(e,t){return setInterval(function(){i.length&&(1===e.mode&&t("setMessages",w(i)),i=[])},500)}function n(){return(n=M(y.mark(function e(t){var r,s,n,a;return y.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,s=t.commit,n=t.rootState,s("reqStart"),e.next=4,o({state:r,commit:s,rootState:n});case 4:return(a=e.sent).result&&(s("setMessages",a.result),s("setTo",a.next_key)),c=u(r,s),e.next=9,p.connector.subscribeMessagesChannels(r.active,"+",function(e){1===r.mode?i.push(JSON.parse(e)):(s("setNewMessagesCount",r.newMessagesCount+1),s("setRtMessagesBuff",JSON.parse(e)))},{rh:2});case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}function a(){return(a=M(y.mark(function e(t){var r;return y.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,c&&clearInterval(c),e.next=4,p.connector.unsubscribeMessagesChannels(r.active,"+");case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}return{get:function(e){return s.apply(this,arguments)},pollingGet:function(e){return n.apply(this,arguments)},getCols:function(e,t){return r.apply(this,arguments)},unsubscribePooling:function(e){return a.apply(this,arguments)}}}function j(e){var n=e.Vue,s=e.LocalStorage,a=e.filterHandler,o=e.newMessagesInterseptor;function r(e,t){if(t&&t.length){e.reverse&&t.reverse(),1===e.mode&&e.filter&&a&&(t=a(e.filter,t)),o&&o(t);var r=e.messages.concat(t);if(e.limit&&1===e.mode&&r.length>=e.limit+.1*e.limit){var s=r.length-1-(e.limit-1);r=r.slice(s),n.set(e,"selected",e.selected.map(function(e){return e-s}))}n.set(e,"messages",r)}}function i(e){n.set(e,"messages",[]),o&&o([]),l(e)}function t(){return(t=M(y.mark(function e(t){return y.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i(t),t.filter="",t.mode=null,t.from=0,t.to=0,t.limit=1e3,e.next=8,n.connector.unsubscribeMessagesChannels(t.active,"+");case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}function c(e,t){var r=s.getItem(e.name);(r=r||{})[e.active]=t,s.set(e.name,r),n.set(e,"cols",t)}var u=c;function l(e){n.set(e,"selected",[])}function f(e){n.set(e,"rtMessagesBuff",[])}return{setOffline:function(e,t){t&&r(e,[{__connectionStatus:"offline",timestamp:Date.now()/1e3}]),e.offline=!0},setReconnected:function(e,t){t&&r(e,[{__connectionStatus:"reconnected",timestamp:Date.now()/1e3}]),e.offline=!1},setMessages:r,clearMessages:i,setLimit:function(e,t){n.set(e,"limit",t)},setFilter:function(e,t){e.filter!==t&&(1===e.mode&&(e.filter&&e.messages.push({"x-flespi-filter-prev":e.filter}),t&&e.messages.push({"x-flespi-filter-next":t})),n.set(e,"filter",t))},setMode:function(e,t){switch(t){case 0:e.from=0,i(e);break;case 1:var r=Date.now();e.from=Math.ceil((r-4e3-1e3)/1e3),e.to=e.from,i(e),e.newMessagesCount=0,n.set(e,"messages",e.rtMessagesBuff),f(e)}n.set(e,"mode",t)},setFrom:function(e,t){n.set(e,"from",t)},setTo:function(e,t){n.set(e,"to",t)},reqStart:function(){DEV&&console.log("Start Request Channels messages")},clear:function(e){return t.apply(this,arguments)},setActive:function(e,t){e.newMessagesCount=0,n.set(e,"active",t)},setCols:c,updateCols:u,setDefaultCols:function(r){r.cols.forEach(function(e,t){e.__dest||(r.defaultColsNames.includes(e.name)?n.set(r.cols[t],"display",!0):n.set(r.cols[t],"display",!1))}),u(r,r.cols)},setNewMessagesCount:function(e,t){n.set(e,"newMessagesCount",t)},setSelected:function(e,t){n.set(e,"selected",t)},clearSelected:l,setRtMessagesBuff:function(e,t){100<=e.rtMessagesBuff.length&&e.rtMessagesBuff.splice(0,1),e.rtMessagesBuff.push(t)},clearRtMessagesBuff:f}}e.default=function(e){var t=e.Vue,r=e.LocalStorage,s=e.name,n=e.errorHandler,a=e.filterHandler,o=e.newMessagesInterseptor;return{namespaced:!0,state:{name:s,isLoading:!1,active:0,messages:[],filter:"",mode:null,from:0,to:0,limit:1e3,cols:[],defaultColsNames:["timestamp","server.timestamp","ident","position.latitude","position.longitude","position.altitude","position.speed"],newMessagesCount:0,offline:!1,selected:[],rtMessagesBuff:[]},actions:_({Vue:t,LocalStorage:r,errorHandler:n}),mutations:j({Vue:t,LocalStorage:r,filterHandler:a,newMessagesInterseptor:o})}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=channelsMessagesPull.js.map
