!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.function.name"),require("@babel/runtime-corejs2/regenerator"),require("core-js/modules/es6.regexp.to-string"),require("core-js/modules/es6.object.to-string"),require("core-js/modules/es6.regexp.match"),require("core-js/modules/es7.array.includes"),require("core-js/modules/es6.string.includes"),require("regenerator-runtime/runtime"),require("core-js/library/fn/array/is-array"),require("core-js/library/fn/array/from"),require("core-js/library/fn/is-iterable"),require("core-js/library/fn/promise"),require("core-js/modules/es6.regexp.split"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.function.name","@babel/runtime-corejs2/regenerator","core-js/modules/es6.regexp.to-string","core-js/modules/es6.object.to-string","core-js/modules/es6.regexp.match","core-js/modules/es7.array.includes","core-js/modules/es6.string.includes","regenerator-runtime/runtime","core-js/library/fn/array/is-array","core-js/library/fn/array/from","core-js/library/fn/is-iterable","core-js/library/fn/promise","core-js/modules/es6.regexp.split","lodash/get","lodash/set"],t):t((e=e||self).channelsMessagesPull={},0,e._regeneratorRuntime,0,0,0,0,0,0,e.isArray$1,e.from,e.isIterable$1,e.promise$1,0,e.get,e.set)}(this,function(e,t,v,s,r,n,a,o,i,c,u,l,f,m,y,p){"use strict";v=v&&v.hasOwnProperty("default")?v.default:v,c=c&&c.hasOwnProperty("default")?c.default:c,u=u&&u.hasOwnProperty("default")?u.default:u,l=l&&l.hasOwnProperty("default")?l.default:l,f=f&&f.hasOwnProperty("default")?f.default:f,y=y&&y.hasOwnProperty("default")?y.default:y,p=p&&p.hasOwnProperty("default")?p.default:p;var d=c;var g=function(e){if(d(e)){for(var t=0,s=new Array(e.length);t<e.length;t++)s[t]=e[t];return s}},h=u,w=l;var b=function(e){if(w(Object(e))||"[object Arguments]"===Object.prototype.toString.call(e))return h(e)};var x=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var j=function(e){return g(e)||b(e)||x()},M=f;function S(e,t,s,r,n,a,o){try{var i=e[a](o),c=i.value}catch(e){return void s(e)}i.done?t(c):M.resolve(c).then(r,n)}var C=function(i){return function(){var e=this,o=arguments;return new M(function(t,s){var r=i.apply(e,o);function n(e){S(r,t,s,n,a,"next",e)}function a(e){S(r,t,s,n,a,"throw",e)}n(void 0)})}};function _(e){var p=e.Vue,i=e.LocalStorage,d=e.errorHandler;function g(e){e.errors&&e.errors.forEach(function(e){var t=new Error(e.reason);d&&d(t)})}function h(e){var t={};if(e.lsNamespace){var s=i.getItem(e.name);s&&(t=s,i.remove(e.name));var r=e.lsNamespace.split("."),n=r.shift(),a="".concat(r.join("."),".").concat(e.name),o=i.getItem(n);t=y(o,a,t)}else t=i.getItem(e.name)||t;return t}function s(){return(s=C(v.mark(function e(t,s){var r,n,a,o,i,c,u,l,f,m;return v.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,a=t.rootState,n("reqStart"),o=s.etc,!a.token||!r.active){e.next=35;break}if(e.prev=4,p.set(r,"isLoading",!0),i=[],!((c=h(r))&&c[r.active]&&c[r.active])){e.next=13;break}"action"===(i=c[r.active])[0].__dest&&i.shift(),e.next=26;break;case 13:return e.next=15,p.connector.gw.getChannels(r.active,{fields:"protocol_id"});case 15:if(u=e.sent,g(l=u.data),l.result&&l.result.length&&l.result[0].protocol_id)return e.next=21,p.connector.gw.getChannelProtocols(l.result[0].protocol_id,{fields:"message_parameters"});e.next=25;break;case 21:f=e.sent,g(m=f.data),m.result[0].message_parameters.forEach(function(e){var t={name:e.name,width:160,display:r.defaultColsNames.includes(e.name),description:e.info};if("timestamp"===t.name){var s=(new Date).toString().match(/([-+][0-9]+)\s/)[1];t.addition="".concat(s.slice(0,3),":").concat(s.slice(3))}i.push(t)});case 25:i.push({name:"etc",width:150,display:o,__dest:"etc"});case 26:n("setCols",i),p.set(r,"isLoading",!1),e.next=35;break;case 30:e.prev=30,e.t0=e.catch(4),d&&d(e.t0),DEV&&console.log(e.t0),p.set(r,"isLoading",!1);case 35:case"end":return e.stop()}},e,null,[[4,30]])}))).apply(this,arguments)}function o(e){return t.apply(this,arguments)}function t(){return(t=C(v.mark(function e(r){var n,a,o,i;return v.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.state,r.commit,a=r.rootState,o={},a.token&&n.active)return e.prev=3,e.next=6,p.connector.gw.getChannelsMessages(n.active,{data:JSON.stringify((s=void 0,s={},(t=n).limit&&(s.limit_count=t.limit),t.from&&(s.curr_key=t.from),s))});e.next=16;break;case 6:i=e.sent,g(o=i.data),e.next=16;break;case 11:e.prev=11,e.t0=e.catch(3),d&&d(e.t0),DEV&&console.log(e.t0),o={errors:[e.t0]};case 16:return e.abrupt("return",o);case 17:case"end":return e.stop()}var t,s},e,null,[[3,11]])}))).apply(this,arguments)}function r(){return(r=C(v.mark(function e(t){var s,r,n,a;return v.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.state,r=t.commit,n=t.rootState,r("reqStart"),p.set(s,"isLoading",!0),e.next=5,o({state:s,commit:r,rootState:n});case 5:(a=e.sent).result&&(r("setMessages",a.result),r("setTo",a.next_key)),p.set(s,"isLoading",!1);case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}var c=[],u=0;function l(e,t){return setInterval(function(){c.length&&(1===e.mode&&t("setMessages",j(c)),c=[])},500)}function n(){return(n=C(v.mark(function e(t){var s,r,n,a;return v.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.state,r=t.commit,n=t.rootState,r("reqStart"),e.next=4,o({state:s,commit:r,rootState:n});case 4:return(a=e.sent).result&&(r("setMessages",a.result),r("setTo",a.next_key)),u=l(s,r),e.next=9,p.connector.subscribeMessagesChannels(s.active,"+",function(e){1===s.mode?c.push(JSON.parse(e)):(r("setNewMessagesCount",s.newMessagesCount+1),r("setRtMessagesBuff",JSON.parse(e)))},{rh:2});case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}function a(){return(a=C(v.mark(function e(t){var s;return v.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.state,u&&clearInterval(u),e.next=4,p.connector.unsubscribeMessagesChannels(s.active,"+");case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}return{get:function(e){return r.apply(this,arguments)},pollingGet:function(e){return n.apply(this,arguments)},getCols:function(e,t){return s.apply(this,arguments)},unsubscribePooling:function(e){return a.apply(this,arguments)}}}function q(e){var n=e.Vue,i=e.LocalStorage,a=e.filterHandler,o=e.newMessagesInterseptor;function s(e,t){if(t&&t.length){e.reverse&&t.reverse(),1===e.mode&&e.filter&&a&&(t=a(e.filter,t)),o&&o(t);var s=e.messages.concat(t);if(e.limit&&1===e.mode&&s.length>=e.limit+.1*e.limit){var r=s.length-1-(e.limit-1);s=s.slice(r),n.set(e,"selected",e.selected.map(function(e){return e-r}))}n.set(e,"messages",s)}}function r(e){n.set(e,"messages",[]),o&&o([]),f(e)}function t(){return(t=C(v.mark(function e(t){return v.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r(t),t.filter="",t.mode=null,t.from=0,t.to=0,t.limit=1e3,e.next=8,n.connector.unsubscribeMessagesChannels(t.active,"+");case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}function c(e,t){var s=function(e){var t={};if(e.lsNamespace){var s=e.lsNamespace.split("."),r=s.shift(),n="".concat(s.join("."),".").concat(e.name),a=i.getItem(r);t=y(a,n,t)}else t=i.getItem(e.name)||t;return t}(e);if(s[e.active]=t,e.lsNamespace){var r=e.lsNamespace.split("."),n=r.shift(),a="".concat(r.join("."),".").concat(e.name),o=i.getItem(n);p(o,a,s),i.set(n,o)}else i.set(e.name,s)}function u(e,t){c(e,t),n.set(e,"cols",t)}var l=u;function f(e){n.set(e,"selected",[])}function m(e){n.set(e,"rtMessagesBuff",[])}return{setOffline:function(e,t){t&&s(e,[{__connectionStatus:"offline",timestamp:Date.now()/1e3}]),e.offline=!0},setReconnected:function(e,t){t&&s(e,[{__connectionStatus:"reconnected",timestamp:Date.now()/1e3}]),e.offline=!1},setMessages:s,clearMessages:r,setLimit:function(e,t){n.set(e,"limit",t)},setFilter:function(e,t){e.filter!==t&&(1===e.mode&&(e.filter&&e.messages.push({"x-flespi-filter-prev":e.filter}),t&&e.messages.push({"x-flespi-filter-next":t})),n.set(e,"filter",t))},setMode:function(e,t){switch(t){case 0:e.from=0,r(e);break;case 1:var s=Date.now();e.from=Math.ceil((s-4e3-1e3)/1e3),e.to=e.from,r(e),e.newMessagesCount=0,n.set(e,"messages",e.rtMessagesBuff),m(e)}n.set(e,"mode",t)},setFrom:function(e,t){n.set(e,"from",t)},setTo:function(e,t){n.set(e,"to",t)},reqStart:function(){DEV&&console.log("Start Request Channels messages")},clear:function(e){return t.apply(this,arguments)},setActive:function(e,t){e.newMessagesCount=0,n.set(e,"active",t)},setCols:u,updateCols:l,setDefaultCols:function(s){s.cols.forEach(function(e,t){e.__dest||(s.defaultColsNames.includes(e.name)?n.set(s.cols[t],"display",!0):n.set(s.cols[t],"display",!1))}),l(s,s.cols)},setNewMessagesCount:function(e,t){n.set(e,"newMessagesCount",t)},setSelected:function(e,t){n.set(e,"selected",t)},clearSelected:f,setRtMessagesBuff:function(e,t){100<=e.rtMessagesBuff.length&&e.rtMessagesBuff.splice(0,1),e.rtMessagesBuff.push(t)},clearRtMessagesBuff:m}}e.default=function(e){var t=e.Vue,s=e.LocalStorage,r=e.name,n=e.errorHandler,a=e.filterHandler,o=e.newMessagesInterseptor,i=y(r,"lsNamespace",void 0);return{namespaced:!0,state:{name:r=y(r,"name",r),lsNamespace:i,isLoading:!1,active:0,messages:[],filter:"",mode:null,from:0,to:0,limit:1e3,cols:[],defaultColsNames:["timestamp","server.timestamp","ident","position.latitude","position.longitude","position.altitude","position.speed"],newMessagesCount:0,offline:!1,selected:[],rtMessagesBuff:[]},actions:_({Vue:t,LocalStorage:s,errorHandler:n}),mutations:q({Vue:t,LocalStorage:s,filterHandler:a,newMessagesInterseptor:o})}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=channelsMessagesPull.js.map
