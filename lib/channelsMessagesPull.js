!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.function.name"),require("core-js/modules/es6.regexp.to-string"),require("core-js/modules/es6.object.to-string"),require("core-js/modules/es6.regexp.match"),require("regenerator-runtime/runtime"),require("@babel/runtime/helpers/toConsumableArray"),require("@babel/runtime/helpers/asyncToGenerator")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.function.name","core-js/modules/es6.regexp.to-string","core-js/modules/es6.object.to-string","core-js/modules/es6.regexp.match","regenerator-runtime/runtime","@babel/runtime/helpers/toConsumableArray","@babel/runtime/helpers/asyncToGenerator"],t):t((e=e||self).channelsMessagesPull={},null,null,null,null,null,e._toConsumableArray,e._asyncToGenerator)}(this,function(e,t,n,r,s,a,l,d){"use strict";l=l&&l.hasOwnProperty("default")?l.default:l,d=d&&d.hasOwnProperty("default")?d.default:d,e.default=function(e){var t=e.Vue,n=e.LocalStorage,r=e.name,s=e.errorHandler,a=e.filterHandler,o=e.newMessagesInterseptor;return{namespaced:!0,state:{name:r,isLoading:!1,active:0,messages:[],filter:"",mode:null,from:0,to:0,limit:1e3,cols:[],newMessagesCount:0,offline:!1,selected:[],rtMessagesBuff:[]},actions:function(e){var f=e.Vue,m=e.LocalStorage,g=e.errorHandler;function p(e){e.errors&&e.errors.forEach(function(e){var t=new Error(e.reason);g&&g(t)})}function t(){return(t=d(regeneratorRuntime.mark(function e(t){var n,r,s,a,o,i,c,u,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.state,r=t.commit,s=t.rootState,r("reqStart"),!s.token||!n.active){e.next=32;break}if(e.prev=3,f.set(n,"isLoading",!0),a=[],!((o=m.get.item(n.name))&&o[n.active]&&o[n.active])){e.next=11;break}o[n.active].forEach(function(e){if("timestamp"===e.name){var t=(new Date).toString().match(/([-\+][0-9]+)\s/)[1];e.addition="".concat(t.slice(0,3),":").concat(t.slice(3))}}),a=o[n.active],e.next=23;break;case 11:return e.next=13,f.connector.gw.getChannels(n.active,{fields:"protocol_id"});case 13:if(i=e.sent,p(c=i.data),c.result&&c.result.length&&c.result[0].protocol_id)return e.next=19,f.connector.gw.getProtocols(c.result[0].protocol_id,{fields:"message_parameters"});e.next=23;break;case 19:u=e.sent,p(l=u.data),l.result[0].message_parameters.forEach(function(e){var t={name:e.name,width:160,display:!0,description:e.info};if("timestamp"===t.name){var n=(new Date).toString().match(/([-\+][0-9]+)\s/)[1];t.addition="".concat(n.slice(0,3),":").concat(n.slice(3))}a.push(t)});case 23:r("setCols",a),f.set(n,"isLoading",!1),e.next=32;break;case 27:e.prev=27,e.t0=e.catch(3),g&&g(e.t0),DEV&&console.log(e.t0),f.set(n,"isLoading",!1);case 32:case"end":return e.stop()}},e,null,[[3,27]])}))).apply(this,arguments)}function o(e){return n.apply(this,arguments)}function n(){return(n=d(regeneratorRuntime.mark(function e(r){var s,a,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.state,r.commit,a=r.rootState,o={},a.token&&s.active)return e.prev=3,e.next=6,f.connector.gw.getChannelsMessages(s.active,{data:JSON.stringify((t=s,n=void 0,n={},t.limit&&(n.limit_count=t.limit),t.from&&(n.curr_key=t.from),n))});e.next=16;break;case 6:i=e.sent,p(o=i.data),e.next=16;break;case 11:e.prev=11,e.t0=e.catch(3),g&&g(e.t0),DEV&&console.log(e.t0),o={errors:[e.t0]};case 16:return e.abrupt("return",o);case 17:case"end":return e.stop()}var t,n},e,null,[[3,11]])}))).apply(this,arguments)}function r(){return(r=d(regeneratorRuntime.mark(function e(t){var n,r,s,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.state,r=t.commit,s=t.rootState,r("reqStart"),f.set(n,"isLoading",!0),e.next=5,o({state:n,commit:r,rootState:s});case 5:(a=e.sent).result&&(r("setMessages",a.result),r("setTo",a.next_key)),f.set(n,"isLoading",!1);case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}var i=[],c=0;function u(e,t){return setInterval(function(){i.length&&(1===e.mode&&t("setMessages",l(i)),i=[])},500)}function s(){return(s=d(regeneratorRuntime.mark(function e(t){var n,r,s,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.state,r=t.commit,s=t.rootState,r("reqStart"),e.next=4,o({state:n,commit:r,rootState:s});case 4:return(a=e.sent).result&&(r("setMessages",a.result),r("setTo",a.next_key)),c=u(n,r),e.next=9,f.connector.subscribeMessagesChannels(n.active,"+",function(e){1===n.mode?i.push(JSON.parse(e)):(r("setNewMessagesCount",n.newMessagesCount+1),r("setRtMessagesBuff",JSON.parse(e)))},{rh:2});case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}function a(){return(a=d(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.state,c&&clearInterval(c),e.next=4,f.connector.unsubscribeMessagesChannels(n.active,"+");case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}return{get:function(e){return r.apply(this,arguments)},pollingGet:function(e){return s.apply(this,arguments)},getCols:function(e){return t.apply(this,arguments)},unsubscribePooling:function(e){return a.apply(this,arguments)}}}({Vue:t,LocalStorage:n,errorHandler:s}),mutations:function(e){var s=e.Vue,r=e.LocalStorage,a=e.filterHandler,o=e.newMessagesInterseptor;function n(e,t){if(t&&t.length){e.reverse&&t.reverse(),1===e.mode&&e.filter&&a&&(t=a(e.filter,t)),o&&o(t);var n=e.messages.concat(t);if(e.limit&&1===e.mode&&n.length>=e.limit+.1*e.limit){var r=n.length-1-(e.limit-1);n=n.slice(r),s.set(e,"selected",e.selected.map(function(e){return e-r}))}s.set(e,"messages",n)}}function i(e){s.set(e,"messages",[]),o&&o([]),u(e)}function t(){return(t=d(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i(t),t.filter="",t.mode=null,t.from=0,t.to=0,t.limit=1e3,e.next=8,s.connector.unsubscribeMessagesChannels(t.active,"+");case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}function c(e,t){var n=r.get.item(e.name);n||(n={}),n[e.active]=t,r.set(e.name,n),s.set(e,"cols",t)}function u(e){s.set(e,"selected",[])}function l(e){s.set(e,"rtMessagesBuff",[])}return{setOffline:function(e,t){t&&n(e,[{__connectionStatus:"offline",timestamp:Date.now()/1e3}]),e.offline=!0},setReconnected:function(e,t){t&&n(e,[{__connectionStatus:"reconnected",timestamp:Date.now()/1e3}]),e.offline=!1},setMessages:n,clearMessages:i,setLimit:function(e,t){s.set(e,"limit",t)},setFilter:function(e,t){e.filter!==t&&(1===e.mode&&(e.filter&&e.messages.push({"x-flespi-filter-prev":e.filter}),t&&e.messages.push({"x-flespi-filter-next":t})),s.set(e,"filter",t))},setMode:function(e,t){switch(t){case 0:e.from=0,i(e);break;case 1:var n=Date.now();e.from=Math.ceil((n-4e3-1e3)/1e3),e.to=e.from,i(e),e.newMessagesCount=0,s.set(e,"messages",e.rtMessagesBuff),l(e)}s.set(e,"mode",t)},setFrom:function(e,t){s.set(e,"from",t)},setTo:function(e,t){s.set(e,"to",t)},reqStart:function(){DEV&&console.log("Start Request Channels messages")},clear:function(e){return t.apply(this,arguments)},setActive:function(e,t){e.newMessagesCount=0,s.set(e,"active",t)},setCols:c,updateCols:c,setNewMessagesCount:function(e,t){s.set(e,"newMessagesCount",t)},setSelected:function(e,t){s.set(e,"selected",t)},clearSelected:u,setRtMessagesBuff:function(e,t){100<=e.rtMessagesBuff.length&&e.rtMessagesBuff.splice(0,1),e.rtMessagesBuff.push(t)},clearRtMessagesBuff:l}}({Vue:t,LocalStorage:n,filterHandler:a,newMessagesInterseptor:o})}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=channelsMessagesPull.js.map
