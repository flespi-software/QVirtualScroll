!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.function.name"),require("core-js/modules/es7.object.get-own-property-descriptors"),require("core-js/modules/es6.symbol"),require("core-js/modules/web.dom.iterable"),require("core-js/modules/es6.array.iterator"),require("core-js/modules/es6.object.to-string"),require("core-js/modules/es6.object.keys"),require("@babel/runtime-corejs2/regenerator"),require("regenerator-runtime/runtime"),require("core-js/library/fn/promise"),require("core-js/modules/es6.regexp.split"),require("core-js/library/fn/object/define-property"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.function.name","core-js/modules/es7.object.get-own-property-descriptors","core-js/modules/es6.symbol","core-js/modules/web.dom.iterable","core-js/modules/es6.array.iterator","core-js/modules/es6.object.to-string","core-js/modules/es6.object.keys","@babel/runtime-corejs2/regenerator","regenerator-runtime/runtime","core-js/library/fn/promise","core-js/modules/es6.regexp.split","core-js/library/fn/object/define-property","lodash/get","lodash/set"],t):t((e=e||self).intervals={},0,0,0,0,0,0,0,e._regeneratorRuntime,0,e.promise$1,0,e.defineProperty$2,e.get,e.set)}(this,function(e,t,r,n,s,a,o,c,d,i,u,l,f,p,m){"use strict";d=d&&d.hasOwnProperty("default")?d.default:d,u=u&&u.hasOwnProperty("default")?u.default:u,f=f&&f.hasOwnProperty("default")?f.default:f,p=p&&p.hasOwnProperty("default")?p.default:p,m=m&&m.hasOwnProperty("default")?m.default:m;var v=u;function g(e,t,r,n,s,a,o){try{var c=e[a](o),i=c.value}catch(e){return void r(e)}c.done?t(i):v.resolve(i).then(n,s)}var h=function(c){return function(){var e=this,o=arguments;return new v(function(t,r){var n=c.apply(e,o);function s(e){g(n,t,r,s,a,"next",e)}function a(e){g(n,t,r,s,a,"throw",e)}s(void 0)})}},b=f;var y=function(e,t,r){return t in e?b(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e};function w(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function j(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?w(Object(r),!0).forEach(function(e){y(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):w(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}var O=["begin","end","duration","timestamp","id"];function D(e){var l=e.Vue,f=e.LocalStorage,u=e.errorHandler;function m(e){e.errors&&e.errors.forEach(function(e){var t=new Error(e.reason);u&&u(t)})}function t(){return(t=h(d.mark(function e(t){var r,n,s,a,o,c,i;return d.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,t.rootState.token&&r.active&&r.activeDevice)return e.prev=2,l.set(r,"isLoading",!0),s={reverse:!0,count:1,fields:"end,begin"},e.next=7,l.connector.gw.getCalcsDevicesIntervals(r.active,r.activeDevice,"all",{data:JSON.stringify(s)});e.next=26;break;case 7:a=e.sent,m(o=a.data),c=Date.now(),i=Date.now(),o.result.length&&(c=Math.round(1e3*o.result[0].begin),i=Math.round(1e3*o.result[0].end)),(c=new Date(c)).setHours(0,0,0,0),(i=new Date(i)).setHours(23,59,59,999),n("setBegin",c.valueOf()),n("setEnd",i.valueOf()),l.set(r,"isLoading",!1),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(2),u&&u(e.t0),DEV&&console.log(e.t0),l.set(r,"isLoading",!1);case 26:case"end":return e.stop()}},e,null,[[2,21]])}))).apply(this,arguments)}function r(){return(r=h(d.mark(function e(n){var s,a,o,c,i;return d.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=n.state,a=n.commit,o=n.rootState,a("reqStart"),o.token&&s.active&&s.activeDevice)return e.prev=3,l.set(s,"isLoading",!0),e.next=7,l.connector.gw.getCalcsDevicesIntervals(s.active,s.activeDevice,"all",{data:JSON.stringify((r=void 0,r={},(t=s).limit&&(r.count=t.limit),t.filter&&t.sysFilter?r.filter="".concat(t.sysFilter,",").concat(t.filter):t.sysFilter&&!t.filter?r.filter="".concat(t.sysFilter):!t.sysFilter&&t.filter&&(r.filter="".concat(t.filter)),t.begin&&!t.reverse&&(t.reverse||(r.begin=Math.floor(t.begin/1e3))),t.end&&(r.end=Math.floor(t.end/1e3)),t.reverse&&(r.reverse=t.reverse),r))});e.next=19;break;case 7:c=e.sent,m(i=c.data),a("setMessages",i.result),l.set(s,"isLoading",!1),e.next=19;break;case 14:e.prev=14,e.t0=e.catch(3),u&&u(e.t0),DEV&&console.log(e.t0),l.set(s,"isLoading",!1);case 19:case"end":return e.stop()}var t,r},e,null,[[3,14]])}))).apply(this,arguments)}var n=function(e,t){var r=JSON.parse(t.payload);switch(t.topic.split("/").slice(-1)[0]){case"created":var n=e.begin,s=e.end,a=new Date(s),o=1e3*r.begin,c=1e3*r.end,i=new Date,u=a.getDate()===i.getDate()&&a.getMonth()===i.getMonth()&&a.getFullYear()===i.getFullYear();(o<=s&&n<=c||u)&&l.set(e.messages,r.id,r);break;case"updated":case"finished":e.messages[r.id]&&l.set(e.messages,r.id,r);break;case"deleted":e.messages[r.id]&&l.delete(e.messages,r.id)}},s=[],a=0;function o(t){return setInterval(function(){s.length&&(s.forEach(function(e){return n(t,e)}),s=[])},500)}function c(){return(c=h(d.mark(function e(t){var r;return d.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,t.commit,a=o(r),e.next=4,l.connector.subscribeIntervals(r.active,r.activeDevice,"+",function(e,t,r){s.push(r)},{rh:2});case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}function i(){return(i=h(d.mark(function e(t){var r;return d.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,a&&clearInterval(a),e.next=4,l.connector.unsubscribeIntervals(r.active,r.activeDevice,"+");case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}return{get:function(e){return r.apply(this,arguments)},pollingGet:function(e){return c.apply(this,arguments)},initTime:function(e){return t.apply(this,arguments)},unsubscribePooling:function(e){return i.apply(this,arguments)},getCols:function(e,t){var r,n,s=e.state,a=e.commit,o=function(e){var t={};if(e.lsNamespace){var r=f.getItem(e.name);r&&(t=r,f.remove(e.name));var n=e.lsNamespace.split("."),s=n.shift(),a="".concat(n.join("."),".").concat(e.name),o=f.getItem(s)||{};t=p(o,a,t)}else(t=f.getItem(e.name))&&"null"!==t||(t={});return t}(s);if(o&&o[s.active]&&o[s.active].length){var c=o[s.active],i=o&&o["custom-cols-schemas"]?o["custom-cols-schemas"]:{};c.schemas=j({},c.schemas,{},i),Array.isArray(c)&&(r=c,n={activeSchema:"_default",schemas:{_default:{name:"_default",cols:O.map(function(e){return{name:e,width:150}})},_protocol:{name:"_protocol",cols:r.reduce(function(e,t){return t.custom||e.push({name:t.name,width:150}),e},[])}},enum:{}},r.length&&(n.activeSchema="_unsaved",n.schemas._unsaved={name:"Modified",cols:r.reduce(function(e,t){return t.display&&e.push({name:t.name,width:t.width}),e},[])},n.enum=r.reduce(function(e,t){return e[t.name]=j({},t),delete e[t.name].display,delete e[t.name].width,e},{})),a("setColsToLS",c=n)),"action"===p(c.enum,"action.__dest",void 0)&&delete c.enum.action,a("updateCols",c)}else{var u={activeSchema:"_default",schemas:{_default:{name:"_default",cols:O.map(function(e){return{name:e,width:150}})},_protocol:{name:"_protocol",cols:O.map(function(e){return{name:e,width:150}})}},enum:O.reduce(function(e,t){return e[t]={name:t},e},{})};t.forEach(function(e){var t=e.name,r={name:t},n={name:t,width:100,description:"".concat(e.name,"[").concat(e.type,"]")};u.schemas._protocol.cols.push(n),u.enum[t]=r}),u.schemas._protocol.cols.push({name:"etc",width:150,__dest:"etc"}),u.schemas._default.cols.push({name:"etc",width:150,__dest:"etc"}),u.enum.etc={name:"etc",__dest:"etc"},a("setCols",u)}}}}function S(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function _(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?S(Object(r),!0).forEach(function(e){y(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):S(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function P(e){var n=e.Vue,f=e.LocalStorage,s=(e.filterHandler,e.newMessagesInterseptor);function r(e){n.set(e,"messages",[]),s&&s([]),c(e)}function t(){return(t=h(d.mark(function e(t){return d.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r(t),t.filter="",t.begin=0,t.end=0,t.limit=1e3,t.reverse=!1,e.next=8,n.connector.unsubscribeIntervals(t.active);case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}function a(e,t){var r,n=function(e){var t={};if(e.lsNamespace){var r=e.lsNamespace.split("."),n=r.shift(),s="".concat(r.join("."),".").concat(e.name),a=f.getItem(n);t=p(a,s,t)}else t=f.getItem(e.name)||t;return t}(e)||{},s={customColsSchema:_({},(r=t).schemas,{_default:void 0,_protocol:void 0}),defaultColsSchema:{activeSchema:r.activeSchema,schemas:{_default:r.schemas._default,_protocol:r.schemas._protocol},enum:r.enum}},a=s.customColsSchema,o=s.defaultColsSchema;if(n[e.active]=o,n["custom-cols-schemas"]=_({},n["custom-cols-schemas"],{},a),e.lsNamespace){var c=e.lsNamespace.split("."),i=c.shift(),u="".concat(c.join("."),".").concat(e.name),l=f.getItem(i)||{};m(l,u,n),f.set(i,l)}else f.set(e.name,n)}function o(e,t){a(e,t),n.set(e,"cols",t)}function c(e){n.set(e,"selected",[])}return{setMessages:function(e,t){if(t&&t.length){e.reverse&&t.reverse();var r=e.messages;s&&s(t),r=t.reduce(function(e,t){return e[t.id]=t,e},{}),n.set(e,"messages",r)}else n.set(e,"messages",[])},clearMessages:r,setLimit:function(e,t){n.set(e,"limit",t)},setFilter:function(e,t){e.filter!==t&&n.set(e,"filter",t)},setBegin:function(e,t){n.set(e,"begin",t)},setEnd:function(e,t){n.set(e,"end",t)},reqStart:function(){DEV&&console.log("Start Request intervals messages")},setReverse:function(e,t){n.set(e,"reverse",t)},clear:function(e){return t.apply(this,arguments)},setActive:function(e,t){e.newMessagesCount=0,n.set(e,"active",t)},setCols:o,setColsToLS:a,updateCols:o,setSelected:function(e,t){n.set(e,"selected",t)},clearSelected:c,setSortBy:function(e,t){n.set(e,"sortBy",t)},clearSortBy:function(e){n.set(e,"sortBy",null)},setActiveDevice:function(e,t){n.set(e,"activeDevice",t)}}}e.default=function(e){var t=e.Vue,r=e.LocalStorage,n=e.name,s=e.errorHandler,a=e.filterHandler,o=e.newMessagesInterseptor,c=p(n,"lsNamespace",void 0);n=p(n,"name",n);var i=D({Vue:t,LocalStorage:r,errorHandler:s}),u=P({Vue:t,LocalStorage:r,filterHandler:a,newMessagesInterseptor:o});return{namespaced:!0,state:{name:n,lsNamespace:c,isLoading:!1,active:0,activeDevice:0,messages:{},filter:"",sysFilter:"",begin:Date.now()-864e5,end:Date.now(),limit:1e3,reverse:!1,cols:void 0,selected:[],sortBy:null},actions:i,mutations:u}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=intervals.js.map
