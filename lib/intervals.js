!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es.array.reverse.js"),require("core-js/modules/es.array.reduce.js"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es.array.reverse.js","core-js/modules/es.array.reduce.js","lodash/get","lodash/set"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).intervals={},null,null,e.get,e.set)}(this,(function(e,t,s,n,a){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=o(n),r=o(a);function i(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var l={exports:{}},u={exports:{}};!function(e){e.exports=function(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e},e.exports.default=e.exports,e.exports.__esModule=!0}(u),function(e){var t=u.exports;function s(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}e.exports=function(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?s(Object(a),!0).forEach((function(s){t(e,s,a[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e},e.exports.default=e.exports,e.exports.__esModule=!0}(l);var d=i(l.exports);function m(e,t,s){let n={};if(t){const a=t.split("."),o=a.shift(),r=`${a.join(".")}.${s}`,i=e.getItem(o);n=c.default(i,r,n)}else n=e.getItem(s)||n;return n}function f(e,t,s,n,a){const o=m(e,t,s)||{},{customColsSchema:c,defaultColsSchema:i}=function(e){return{customColsSchema:d(d({},e.schemas),{},{_default:void 0,_protocol:void 0,_unsaved:void 0}),defaultColsSchema:{activeSchema:e.activeSchema,schemas:{_default:e.schemas._default,_protocol:e.schemas._protocol,_unsaved:e.schemas._unsaved}}}}(a);if(o[n]=i,o["custom-cols-schemas"]=d({},c),t){const n=t.split("."),a=n.shift(),c=`${n.join(".")}.${s}`,i=e.getItem(a)||{};r.default(i,c,o),e.set(a,i)}else e.set(s,o)}const g=["begin","end","duration","timestamp","id"];function p({Vue:e,LocalStorage:t,errorHandler:s}){async function n(t,s){const n={activeSchema:"_default",schemas:{_default:{name:"_default",cols:s.reduce(((e,t)=>((g.includes(t.name)||t.__dest&&t.display)&&e.push({name:t.name,width:t.width}),e)),[])},_protocol:{name:"_protocol",cols:s.reduce(((e,t)=>(t.custom||e.push({name:t.name,width:150}),e)),[])}},enum:{}};if(s.length){const a=s.reduce(((e,t)=>{const s=g.includes(t.name);return e.isDefault=e.isDefault&&(!t.display&&!s||t.display&&(s||!!t.__dest)),e.isProtocol=e.isProtocol&&!t.custom,t.display&&e.schema.push({name:t.name,width:t.width}),e.enum[t.name]=d({},t),delete e.enum[t.name].display,delete e.enum[t.name].width,e}),{schema:[],enum:{},isDefault:!0,isProtocol:!0});if(!a.isDefault||!a.isProtocol){const s=(await e.connector.gw.getCalcs(t,{fields:"name"})).data;o(s);let r=c.default(s,"result[0].name",`Calc-${t}`);r=`${r}[${t}]`,n.activeSchema=r,n.schemas[r]={name:r,cols:a.schema}}n.enum=a.enum}return n}function a(){const e=(new Date).toString().match(/([-+][0-9]+)\s/)[1];return g.reduce(((t,s)=>(t[s]={name:s},(s.match(/timestamp$/)||"begin"===s||"end"===s)&&(t[s].addition=`${e.slice(0,3)}:${e.slice(3)}`,t[s].type="",t[s].unit=""),t)),{})}function o(e){e.errors&&e.errors.forEach((e=>{const t=new Error(e.reason);s&&s(t)}))}async function r({state:t,commit:n,rootState:a},c){let r=[];if(n("reqStart"),a.token&&t.active&&t.activeDevice)try{e.set(t,"isLoading",!0);const s=(await e.connector.gw.getCalcsDevicesIntervals(t.active,t.activeDevice,"all",{data:JSON.stringify(c)})).data;o(s),r=s.result,e.set(t,"isLoading",!1)}catch(n){s&&s(n),DEV&&console.log(n),e.set(t,"isLoading",!1)}return r}let i=[],l=0;function u(t){return setInterval((()=>{i.length&&(i.forEach((s=>((t,s)=>{const n=JSON.parse(s.payload);switch(s.topic.split("/").slice(-1)[0]){case"created":{const s=t.begin,a=t.end,o=new Date(a),c=1e3*n.begin,r=1e3*n.end,i=new Date,l=o.getDate()===i.getDate()&&o.getMonth()===i.getMonth()&&o.getFullYear()===i.getFullYear();(c<=a&&r>=s||l)&&e.set(t.messages,n.id,n);break}case"updated":case"finished":t.messages[n.id]&&e.set(t.messages,n.id,n);break;case"deleted":t.messages[n.id]&&e.delete(t.messages,n.id)}})(t,s))),i=[])}),500)}return{getMessages:r,get:async function({state:e,commit:t,rootState:s}){t("setMessages",await r({state:e,commit:t,rootState:s},function(e){const t={};return e.limit&&(t.count=e.limit),e.filter&&e.sysFilter?t.filter=`${e.sysFilter},${e.filter}`:e.sysFilter&&!e.filter?t.filter=`${e.sysFilter}`:!e.sysFilter&&e.filter&&(t.filter=`${e.filter}`),e.begin&&!e.reverse&&(e.reverse||(t.begin=Math.floor(e.begin/1e3))),e.end&&(t.end=Math.floor(e.end/1e3)),e.reverse&&(t.reverse=e.reverse),t}(e)))},pollingGet:async function({state:t,commit:s}){l=u(t),await e.connector.subscribeIntervals(t.active,t.activeDevice,"+",((e,t,s)=>{i.push(s)}),{rh:2})},initTime:async function({state:t,commit:n,rootState:a}){if(a.token&&t.active&&t.activeDevice)try{e.set(t,"isLoading",!0);const s={reverse:!0,count:1,fields:"end,begin"},a=(await e.connector.gw.getCalcsDevicesIntervals(t.active,t.activeDevice,"all",{data:JSON.stringify(s)})).data;o(a);let c=Date.now(),r=Date.now();a.result.length&&(c=Math.round(1e3*a.result[0].begin),r=Math.round(1e3*a.result[0].end)),c=new Date(c),c.setHours(0,0,0,0),r=new Date(r),r.setHours(23,59,59,999),n("setBegin",c.valueOf()),n("setEnd",r.valueOf()),e.set(t,"isLoading",!1)}catch(n){s&&s(n),DEV&&console.log(n),e.set(t,"isLoading",!1)}},unsubscribePooling:async function({state:t}){l&&clearInterval(l),await e.connector.unsubscribeIntervals(t.active,t.activeDevice,"+")},getCols:async function({state:e,commit:s},o){let c=m(t,e.lsNamespace,e.name);!async function(e,s){for(const a in s){let o=s[a];Array.isArray(o)?(o=await n(e.active,o),f(t,e.lsNamespace,e.name,a,o),s[a]=o):o.enum&&(delete o.enum,f(t,e.lsNamespace,e.name,a,o),s[a]=o)}}(c),c=c[e.active];const r=c||{activeSchema:"_default",schemas:{_default:{name:"_default",cols:g.map((e=>({name:e,width:150})))},_protocol:{name:"_protocol",cols:g.map((e=>({name:e,width:150})))}},enum:a()},i=c&&c["custom-cols-schemas"]?c["custom-cols-schemas"]:{};r.enum||(r.enum=a()),r.schemas=d(d({},r.schemas),i);const l=(new Date).toString().match(/([-+][0-9]+)\s/)[1];o.forEach((e=>{const t=e.name,s={name:t,description:`${e.name}[${e.type}]`},n={name:t,width:100};(t.match(/timestamp$/)||"begin"===t||"end"===t)&&(s.addition=`${l.slice(0,3)}:${l.slice(3)}`,s.type="",s.unit="",n.width=190),r.schemas._protocol.cols.push(n),r.enum[t]=s})),r.schemas._protocol.cols.push({name:"etc",width:150,__dest:"etc"}),!c&&r.schemas._default.cols.push({name:"etc",width:150,__dest:"etc"}),r.enum.etc={name:"etc",__dest:"etc"},s("setCols",r)}}}e.default=function({Vue:e,LocalStorage:t,name:s,errorHandler:n,newMessagesInterseptor:a}){const o=c.default(s,"lsNamespace",void 0);s=c.default(s,"name",s);const r=p({Vue:e,LocalStorage:t,errorHandler:n}),i=function({Vue:e,LocalStorage:t,newMessagesInterseptor:s}){function n(t){e.set(t,"messages",[]),s&&s([]),o(t)}function a(s,n){f(t,s.lsNamespace,s.name,s.active,n),e.set(s,"cols",n)}function o(t){e.set(t,"selected",[])}return{setMessages:function(t,n){if(n&&n.length){t.reverse&&n.reverse();let a=t.messages;s&&s(n),a=n.reduce(((e,t)=>(e[t.id]=t,e)),{}),e.set(t,"messages",a)}else e.set(t,"messages",[])},clearMessages:n,setLimit:function(t,s){e.set(t,"limit",s)},setFilter:function(t,s){t.filter!==s&&e.set(t,"filter",s)},setBegin:function(t,s){e.set(t,"begin",s)},setEnd:function(t,s){e.set(t,"end",s)},reqStart:function(){DEV&&console.log("Start Request intervals messages")},setReverse:function(t,s){e.set(t,"reverse",s)},clear:async function(t){n(t),t.filter="",t.begin=0,t.end=0,t.limit=1e3,t.reverse=!1,await e.connector.unsubscribeIntervals(t.active)},setActive:function(t,s){t.newMessagesCount=0,e.set(t,"active",s)},setCols:a,updateCols:a,setSelected:function(t,s){e.set(t,"selected",s)},clearSelected:o,setSortBy:function(t,s){e.set(t,"sortBy",s)},clearSortBy:function(t){e.set(t,"sortBy",null)},setActiveDevice:function(t,s){e.set(t,"activeDevice",s)}}}({Vue:e,LocalStorage:t,newMessagesInterseptor:a});return{namespaced:!0,state:{name:s,lsNamespace:o,isLoading:!1,active:0,activeDevice:0,messages:{},filter:"",sysFilter:"",begin:Date.now()-864e5,end:Date.now(),limit:1e3,reverse:!1,cols:void 0,selected:[],sortBy:null},actions:r,mutations:i}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=intervals.js.map
