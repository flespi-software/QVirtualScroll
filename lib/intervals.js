!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es.array.push.js"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es.array.push.js","lodash/get","lodash/set"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).intervals={},null,e._get,e._set)}(this,(function(e,t,s,n){"use strict";function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=a(s),o=a(n);function c(e,t,s){let n={};if(t){const a=t.split("."),o=a.shift(),c=`${a.join(".")}.${s}`,r=e.getItem(o);n=i.default(r,c,n)}else n=e.getItem(s)||n;return n}const r=["begin","end","duration","timestamp","id"];function l({Vue:e,LocalStorage:t,errorHandler:s,logger:n}){function a(){const e=(new Date).toString().match(/([-+][0-9]+)\s/)[1];return r.reduce(((t,s)=>(t[s]={name:s},(s.match(/timestamp$/)||"begin"===s||"end"===s)&&(t[s].addition=`${e.slice(0,3)}:${e.slice(3)}`,t[s].type="",t[s].unit=""),t)),{})}function i(e,t){t.errors?(e("reqError",t.errors),t.errors.forEach((e=>{const t=new Error(e.reason);s&&s(t)}))):e("reqFullfiled")}async function o({state:t,commit:n,rootState:a},o){let c=[];if(n("reqStart"),a.token&&t.active&&t.activeDevice)try{e.set(t,"isLoading",!0);const s=await e.connector.gw.getCalcsDevicesIntervals(t.active,t.activeDevice,"all",{data:JSON.stringify(o)});n("reqStart",{endpoint:"getCalcsDevicesIntervals",active:t.active,device:t.activeDevice,data:JSON.stringify(o)});const a=s.data;i(n,a),c=a.result,e.set(t,"isLoading",!1)}catch(n){s&&s(n),DEV&&console.log(n),e.set(t,"isLoading",!1)}return c}const l=(t,s)=>{const n=JSON.parse(s.payload);switch(s.topic.split("/").slice(-1)[0]){case"created":{const s=t.begin,a=t.end,i=new Date(a),o=1e3*n.begin,c=1e3*n.end,r=new Date,l=i.getDate()===r.getDate()&&i.getMonth()===r.getMonth()&&i.getFullYear()===r.getFullYear();(o<=a&&c>=s||l)&&e.set(t.messages,n.id,n);break}case"updated":case"finished":t.messages[n.id]&&e.set(t.messages,n.id,n);break;case"deleted":t.messages[n.id]&&e.delete(t.messages,n.id)}};let u=[],d=0;return{getMessages:o,get:async function({state:e,commit:t,rootState:s}){const n=await o({state:e,commit:t,rootState:s},function(e){const t={};return e.limit&&(t.count=e.limit),e.filter&&e.sysFilter?t.filter=`${e.sysFilter},${e.filter}`:e.sysFilter&&!e.filter?t.filter=`${e.sysFilter}`:!e.sysFilter&&e.filter&&(t.filter=`${e.filter}`),e.begin&&!e.reverse&&(e.reverse||(t.begin=Math.floor(e.begin/1e3))),e.end&&(t.end=Math.floor(e.end/1e3)),e.reverse&&(t.reverse=e.reverse),t}(e));t("setMessages",n)},pollingGet:async function({state:t,commit:s}){d=function(e){return setInterval((()=>{u.length&&(u.forEach((t=>l(e,t))),u=[])}),500)}(t),await e.connector.subscribeIntervals(t.active,t.activeDevice,"+",((e,t,s)=>{u.push(s)}),{rh:2}),n.info(`subscribed to Intervals ${t.active} - ${t.activeDevice}`)},initTime:async function({state:t,commit:n,rootState:a}){if(a.token&&t.active&&t.activeDevice)try{e.set(t,"isLoading",!0);const s={reverse:!0,count:1,fields:"end,begin"},a=await e.connector.gw.getCalcsDevicesIntervals(t.active,t.activeDevice,"all",{data:JSON.stringify(s)});n("reqStart",{endpoint:"getCalcsDevicesIntervals-initTime",active:t.active,device:t.activeDevice,data:JSON.stringify(s)});const o=a.data;i(n,o);let c=Date.now(),r=Date.now();o.result.length&&(c=Math.round(1e3*o.result[0].begin),r=Math.round(1e3*o.result[0].end)),c=new Date(c),c.setHours(0,0,0,0),r=new Date(r),r.setHours(23,59,59,999),n("setBegin",c.valueOf()),n("setEnd",r.valueOf()+.999),e.set(t,"isLoading",!1)}catch(n){s&&s(n),DEV&&console.log(n),e.set(t,"isLoading",!1)}},unsubscribePooling:async function({state:t}){d&&clearInterval(d),await e.connector.unsubscribeIntervals(t.active,t.activeDevice,"+"),n.info(`unsubscribed to Intervals ${t.active} - ${t.activeDevice}`)},getCols:async function({state:e,commit:s},n){let i=c(t,e.lsNamespace,e.name);i=i[e.active];const o=i||{activeSchema:"_default",schemas:{_default:{name:"_default",cols:r.map((e=>({name:e,width:150})))},_protocol:{name:"_protocol",cols:r.map((e=>({name:e,width:150})))}},enum:a()},l=i&&i["custom-cols-schemas"]?i["custom-cols-schemas"]:{};o.enum||(o.enum=a()),o.schemas={...o.schemas,...l};const u=(new Date).toString().match(/([-+][0-9]+)\s/)[1];n.forEach((e=>{const t=e.name,s={name:t,description:`${e.name}[${e.type}]`},n={name:t,width:100};(t.match(/timestamp$/)||"begin"===t||"end"===t)&&(s.addition=`${u.slice(0,3)}:${u.slice(3)}`,s.type="",s.unit="",n.width=190),o.schemas._protocol.cols.push(n),o.enum[t]=s})),o.schemas._protocol.cols.push({name:"etc",width:150,__dest:"etc"}),!i&&o.schemas._default.cols.push({name:"etc",width:150,__dest:"etc"}),o.enum.etc={name:"etc",__dest:"etc"},s("setCols",o)}}}function u({Vue:e,LocalStorage:t,newMessagesInterseptor:s,logger:n}){function a(t){e.set(t,"messages",[]),s&&s([]),r(t),n.info("clearMessages")}function i(s,n){!function(e,t,s,n,a){const i=c(e,t,s)||{},{customColsSchema:r,defaultColsSchema:l}=function(e){return{customColsSchema:{...e.schemas,_default:void 0,_protocol:void 0,_unsaved:void 0},defaultColsSchema:{activeSchema:e.activeSchema,schemas:{_default:e.schemas._default,_protocol:e.schemas._protocol,_unsaved:e.schemas._unsaved}}}}(a);if(i[n]=l,i["custom-cols-schemas"]={...r},t){const n=t.split("."),a=n.shift(),c=`${n.join(".")}.${s}`,r=e.getItem(a)||{};o.default(r,c,i),e.set(a,r)}else e.set(s,i)}(t,s.lsNamespace,s.name,s.active,n),e.set(s,"cols",n)}function r(t){e.set(t,"selected",[])}return{setMessages:function(t,a){if(a&&a.length){t.reverse&&a.reverse();let n=t.messages;s&&s(a),n=a.reduce(((e,t)=>(e[t.id]=t,e)),{}),e.set(t,"messages",n)}else e.set(t,"messages",[]);n.info(`setMessages: length: ${a.length}`)},clearMessages:a,setLimit:function(t,s){e.set(t,"limit",s)},setFilter:function(t,s){t.filter!==s&&e.set(t,"filter",s),n.info(`setFilter: ${s}`)},setBegin:function(t,s){e.set(t,"begin",s),n.info(`setBegin: ${s}`)},setEnd:function(t,s){e.set(t,"end",s),n.info(`setEnd: ${s}`)},reqStart:function(e,t){n.info(`reqStart: ${JSON.stringify(t)}`)},reqFullfiled:function(){n.info("reqFullfiled")},reqError:function(e,t){n.info(`reqError: ${JSON.stringify(t)}`)},setReverse:function(t,s){e.set(t,"reverse",s),n.info(`setReverse: ${s}`)},clear:async function(t){a(t),t.filter="",t.begin=0,t.end=0,t.limit=1e3,t.reverse=!1,await e.connector.unsubscribeIntervals(t.active),n.info("clear module"),n.info(`unsubscribeIntervals ${t.active}`)},setActive:function(t,s){t.newMessagesCount=0,e.set(t,"active",s),n.info(`setActive: ${s}`)},setCols:i,updateCols:i,setSelected:function(t,s){e.set(t,"selected",s)},clearSelected:r,setSortBy:function(t,s){e.set(t,"sortBy",s)},clearSortBy:function(t){e.set(t,"sortBy",null)},setActiveDevice:function(t,s){e.set(t,"activeDevice",s),n.info(`setActiveDevice: ${s}`)}}}class d{constructor(e="ModuleLogger"){this.name=`[${e}]`}extendName(e){return new d(`${this.name}[${e}]`)}info(){console.info(...Array.from(arguments).map((e=>`${this.name} ${e}`)))}error(){console.error(...Array.from(arguments).map((e=>`${this.name} ${e}`)))}warn(){console.warn(...Array.from(arguments).map((e=>`${this.name} ${e}`)))}}e.default=function({Vue:e,LocalStorage:t,name:s,errorHandler:n,newMessagesInterseptor:a}){const o=i.default(s,"lsNamespace",void 0);s=i.default(s,"name",s);const c=e.$logger?e.$logger.extendName(s):new d(s),r=l({Vue:e,LocalStorage:t,errorHandler:n,logger:c}),f=u({Vue:e,LocalStorage:t,newMessagesInterseptor:a,logger:c});return{namespaced:!0,state:{name:s,lsNamespace:o,isLoading:!1,active:0,activeDevice:0,messages:{},filter:"",sysFilter:"",begin:Date.now()-864e5,end:Date.now(),limit:1e3,reverse:!1,cols:void 0,selected:[],sortBy:null},actions:r,mutations:f}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=intervals.js.map
