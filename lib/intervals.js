!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.function.name.js"),require("core-js/modules/es6.object.keys.js"),require("core-js/modules/es6.symbol.js"),require("core-js/modules/es6.object.get-own-property-descriptor.js"),require("core-js/modules/es7.object.get-own-property-descriptors.js"),require("@babel/runtime-corejs2/core-js/object/define-property"),require("@babel/runtime-corejs2/core-js/promise"),require("@babel/runtime-corejs2/regenerator"),require("core-js/modules/es6.array.filter.js"),require("core-js/modules/es6.regexp.match.js"),require("core-js/modules/es6.object.to-string.js"),require("core-js/modules/es6.regexp.to-string.js"),require("core-js/modules/es6.array.map.js"),require("core-js/modules/es6.array.slice.js"),require("core-js/modules/es6.regexp.split.js"),require("core-js/modules/es7.array.includes.js"),require("core-js/modules/es6.array.iterator.js"),require("core-js/modules/web.dom.iterable.js"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.function.name.js","core-js/modules/es6.object.keys.js","core-js/modules/es6.symbol.js","core-js/modules/es6.object.get-own-property-descriptor.js","core-js/modules/es7.object.get-own-property-descriptors.js","@babel/runtime-corejs2/core-js/object/define-property","@babel/runtime-corejs2/core-js/promise","@babel/runtime-corejs2/regenerator","core-js/modules/es6.array.filter.js","core-js/modules/es6.regexp.match.js","core-js/modules/es6.object.to-string.js","core-js/modules/es6.regexp.to-string.js","core-js/modules/es6.array.map.js","core-js/modules/es6.array.slice.js","core-js/modules/es6.regexp.split.js","core-js/modules/es7.array.includes.js","core-js/modules/es6.array.iterator.js","core-js/modules/web.dom.iterable.js","lodash/get","lodash/set"],t):t((e=e||self).intervals={},0,0,0,0,0,e.defineProperty$1,e.promise,e._regeneratorRuntime,0,0,0,0,0,0,0,0,0,0,e.get,e.set)}(this,function(e,t,r,s,n,o,a,u,h,c,i,l,p,d,m,f,v,j,g,b,y){"use strict";function w(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function O(e,t){return e(t={exports:{}},t.exports),t.exports}a=a&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a,u=u&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u,h=h&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h,b=b&&Object.prototype.hasOwnProperty.call(b,"default")?b.default:b,y=y&&Object.prototype.hasOwnProperty.call(y,"default")?y.default:y;var x=w(O(function(e){e.exports=function(e,t,r){return t in e?a(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e},e.exports.default=e.exports,e.exports.__esModule=!0})),_=w(O(function(e){function i(e,t,r,s,n,o,a){try{var c=e[o](a),i=c.value}catch(e){return void r(e)}c.done?t(i):u.resolve(i).then(s,n)}e.exports=function(c){return function(){var e=this,a=arguments;return new u(function(t,r){var s=c.apply(e,a);function n(e){i(s,t,r,n,o,"next",e)}function o(e){i(s,t,r,n,o,"throw",e)}n(void 0)})}},e.exports.default=e.exports,e.exports.__esModule=!0}));function D(t,e){var r,s=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),s.push.apply(s,r)),s}function S(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?D(Object(r),!0).forEach(function(e){x(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):D(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function P(e,t,r){var s,n={};return n=t?(t=(s=t.split(".")).shift(),s="".concat(s.join("."),".").concat(r),t=e.getItem(t),b(t,s,n)):e.getItem(r)||n}function k(e,t,r,s,n){var o,a=P(e,t,r)||{},n={customColsSchema:S(S({},(o=n).schemas),{},{_default:void 0,_protocol:void 0,_unsaved:void 0}),defaultColsSchema:{activeSchema:o.activeSchema,schemas:{_default:o.schemas._default,_protocol:o.schemas._protocol,_unsaved:o.schemas._unsaved}}},o=n.customColsSchema,n=n.defaultColsSchema;a[s]=n,a["custom-cols-schemas"]=S({},o),t?(o=(n=t.split(".")).shift(),t="".concat(n.join("."),".").concat(r),n=e.getItem(o)||{},y(n,t,a),e.set(o,n)):e.set(r,a)}function q(t,e){var r,s=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),s.push.apply(s,r)),s}function M(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?q(Object(r),!0).forEach(function(e){x(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):q(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}var C=["begin","end","duration","timestamp","id"];function E(e){var u=e.Vue,i=e.LocalStorage,c=e.errorHandler;function o(){return(o=_(h.mark(function e(t,r){var s,n,o;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s={activeSchema:"_default",schemas:{_default:{name:"_default",cols:r.reduce(function(e,t){return(C.includes(t.name)||t.__dest&&t.display)&&e.push({name:t.name,width:t.width}),e},[])},_protocol:{name:"_protocol",cols:r.reduce(function(e,t){return t.custom||e.push({name:t.name,width:150}),e},[])}},enum:{}},!r.length){e.next=14;break}if((n=r.reduce(function(e,t){var r=C.includes(t.name);return e.isDefault=e.isDefault&&(!t.display&&!r||t.display&&(r||!!t.__dest)),e.isProtocol=e.isProtocol&&!t.custom,t.display&&e.schema.push({name:t.name,width:t.width}),e.enum[t.name]=M({},t),delete e.enum[t.name].display,delete e.enum[t.name].width,e},{schema:[],enum:{},isDefault:!0,isProtocol:!0})).isDefault&&n.isProtocol){e.next=13;break}return e.next=6,u.connector.gw.getCalcs(t,{fields:"name"});case 6:o=e.sent,p(o=o.data),o=b(o,"result[0].name","Calc-".concat(t)),o="".concat(o,"[").concat(t,"]"),s.activeSchema=o,s.schemas[o]={name:o,cols:n.schema};case 13:s.enum=n.enum;case 14:return e.abrupt("return",s);case 15:case"end":return e.stop()}},e)}))).apply(this,arguments)}function l(){return(l=_(h.mark(function e(t,r){var s,n;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=h.keys(r);case 1:if((e.t1=e.t0()).done){e.next=15;break}if(s=e.t1.value,n=r[s],Array.isArray(n))return e.next=7,function(){return o.apply(this,arguments)}(t.active,n);e.next=12;break;case 7:n=e.sent,k(i,t.lsNamespace,t.name,s,n),r[s]=n,e.next=13;break;case 12:n.enum&&(delete n.enum,k(i,t.lsNamespace,t.name,s,n),r[s]=n);case 13:e.next=1;break;case 15:return e.abrupt("return",r);case 16:case"end":return e.stop()}},e)}))).apply(this,arguments)}function r(){return(r=_(h.mark(function e(t,r){var s,n,o,a,c;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=t.state,s=t.commit,function(){l.apply(this,arguments)}(n=P(i,a.lsNamespace,a.name)),n=n[a.active],o=n||function(){var r=(new Date).toString().match(/([-+][0-9]+)\s/)[1];return{activeSchema:"_default",schemas:{_default:{name:"_default",cols:C.map(function(e){return{name:e,width:150}})},_protocol:{name:"_protocol",cols:C.map(function(e){return{name:e,width:150}})}},enum:C.reduce(function(e,t){return e[t]={name:t},!t.match(/timestamp$/)&&"begin"!==t&&"end"!==t||(e[t].addition="".concat(r.slice(0,3),":").concat(r.slice(3)),e[t].type="",e[t].unit=""),e},{})}}(),a=n&&n["custom-cols-schemas"]?n["custom-cols-schemas"]:{},o.enum={},o.schemas=M(M({},o.schemas),a),c=(new Date).toString().match(/([-+][0-9]+)\s/)[1],r.forEach(function(e){var t=e.name,r={name:t,description:"".concat(e.name,"[").concat(e.type,"]")},e={name:t,width:100};!t.match(/timestamp$/)&&"begin"!==t&&"end"!==t||(r.addition="".concat(c.slice(0,3),":").concat(c.slice(3)),r.type="",r.unit="",e.width=190),o.schemas._protocol.cols.push(e),o.enum[t]=r}),o.schemas._protocol.cols.push({name:"etc",width:150,__dest:"etc"}),n||o.schemas._default.cols.push({name:"etc",width:150,__dest:"etc"}),o.enum.etc={name:"etc",__dest:"etc"},s("setCols",o);case 14:case"end":return e.stop()}},e)}))).apply(this,arguments)}function p(e){e.errors&&e.errors.forEach(function(e){e=new Error(e.reason);c&&c(e)})}function t(){return(t=_(h.mark(function e(t){var r,s,n,o,a;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,s=t.commit,t.rootState.token&&r.active&&r.activeDevice)return e.prev=2,u.set(r,"isLoading",!0),o={reverse:!0,count:1,fields:"end,begin"},e.next=7,u.connector.gw.getCalcsDevicesIntervals(r.active,r.activeDevice,"all",{data:JSON.stringify(o)});e.next=26;break;case 7:a=e.sent,p(n=a.data),o=Date.now(),a=Date.now(),n.result.length&&(o=Math.round(1e3*n.result[0].begin),a=Math.round(1e3*n.result[0].end)),(o=new Date(o)).setHours(0,0,0,0),(a=new Date(a)).setHours(23,59,59,999),s("setBegin",o.valueOf()),s("setEnd",a.valueOf()),u.set(r,"isLoading",!1),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(2),c&&c(e.t0),DEV&&console.log(e.t0),u.set(r,"isLoading",!1);case 26:case"end":return e.stop()}},e,null,[[2,21]])}))).apply(this,arguments)}function s(){return(s=_(h.mark(function e(s){var n,o,a;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=s.state,o=s.commit,a=s.rootState,o("reqStart"),a.token&&n.active&&n.activeDevice)return e.prev=3,u.set(n,"isLoading",!0),e.next=7,u.connector.gw.getCalcsDevicesIntervals(n.active,n.activeDevice,"all",{data:JSON.stringify((r=void 0,r={},(t=n).limit&&(r.count=t.limit),t.filter&&t.sysFilter?r.filter="".concat(t.sysFilter,",").concat(t.filter):t.sysFilter&&!t.filter?r.filter="".concat(t.sysFilter):!t.sysFilter&&t.filter&&(r.filter="".concat(t.filter)),t.begin&&!t.reverse&&(t.reverse||(r.begin=Math.floor(t.begin/1e3))),t.end&&(r.end=Math.floor(t.end/1e3)),t.reverse&&(r.reverse=t.reverse),r))});e.next=19;break;case 7:a=e.sent,p(a=a.data),o("setMessages",a.result),u.set(n,"isLoading",!1),e.next=19;break;case 14:e.prev=14,e.t0=e.catch(3),c&&c(e.t0),DEV&&console.log(e.t0),u.set(n,"isLoading",!1);case 19:case"end":return e.stop()}var t,r},e,null,[[3,14]])}))).apply(this,arguments)}var n=function(e,t){var r=JSON.parse(t.payload);switch(t.topic.split("/").slice(-1)[0]){case"created":var s=e.begin,n=e.end,o=new Date(n),a=1e3*r.begin,c=1e3*r.end,i=new Date,i=o.getDate()===i.getDate()&&o.getMonth()===i.getMonth()&&o.getFullYear()===i.getFullYear();(a<=n&&s<=c||i)&&u.set(e.messages,r.id,r);break;case"updated":case"finished":e.messages[r.id]&&u.set(e.messages,r.id,r);break;case"deleted":e.messages[r.id]&&u.delete(e.messages,r.id)}},a=[],d=0;function m(){return(m=_(h.mark(function e(t){var r;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,t.commit,d=function(t){return setInterval(function(){a.length&&(a.forEach(function(e){return n(t,e)}),a=[])},500)}(r),e.next=4,u.connector.subscribeIntervals(r.active,r.activeDevice,"+",function(e,t,r){a.push(r)},{rh:2});case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}function f(){return(f=_(h.mark(function e(t){var r;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,d&&clearInterval(d),e.next=4,u.connector.unsubscribeIntervals(r.active,r.activeDevice,"+");case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}return{get:function(e){return s.apply(this,arguments)},pollingGet:function(e){return m.apply(this,arguments)},initTime:function(e){return t.apply(this,arguments)},unsubscribePooling:function(e){return f.apply(this,arguments)},getCols:function(e,t){return r.apply(this,arguments)}}}function I(e){var s=e.Vue,r=e.LocalStorage,n=e.newMessagesInterseptor;function o(e){s.set(e,"messages",[]),n&&n([]),c(e)}function t(){return(t=_(h.mark(function e(t){return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o(t),t.filter="",t.begin=0,t.end=0,t.limit=1e3,t.reverse=!1,e.next=8,s.connector.unsubscribeIntervals(t.active);case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}function a(e,t){k(r,e.lsNamespace,e.name,e.active,t),s.set(e,"cols",t)}function c(e){s.set(e,"selected",[])}return{setMessages:function(e,t){var r;t&&t.length?(e.reverse&&t.reverse(),r=e.messages,n&&n(t),r=t.reduce(function(e,t){return e[t.id]=t,e},{}),s.set(e,"messages",r)):s.set(e,"messages",[])},clearMessages:o,setLimit:function(e,t){s.set(e,"limit",t)},setFilter:function(e,t){e.filter!==t&&s.set(e,"filter",t)},setBegin:function(e,t){s.set(e,"begin",t)},setEnd:function(e,t){s.set(e,"end",t)},reqStart:function(){DEV&&console.log("Start Request intervals messages")},setReverse:function(e,t){s.set(e,"reverse",t)},clear:function(e){return t.apply(this,arguments)},setActive:function(e,t){e.newMessagesCount=0,s.set(e,"active",t)},setCols:a,updateCols:a,setSelected:function(e,t){s.set(e,"selected",t)},clearSelected:c,setSortBy:function(e,t){s.set(e,"sortBy",t)},clearSortBy:function(e){s.set(e,"sortBy",null)},setActiveDevice:function(e,t){s.set(e,"activeDevice",t)}}}e.default=function(e){var t=e.Vue,r=e.LocalStorage,s=e.name,n=e.errorHandler,o=e.newMessagesInterseptor,e=b(s,"lsNamespace",void 0),s=b(s,"name",s),n=E({Vue:t,LocalStorage:r,errorHandler:n}),o=I({Vue:t,LocalStorage:r,newMessagesInterseptor:o});return{namespaced:!0,state:{name:s,lsNamespace:e,isLoading:!1,active:0,activeDevice:0,messages:{},filter:"",sysFilter:"",begin:Date.now()-864e5,end:Date.now(),limit:1e3,reverse:!1,cols:void 0,selected:[],sortBy:null},actions:n,mutations:o}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=intervals.js.map
