!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es.array.reverse.js"),require("core-js/modules/es.array.reduce.js"),require("lodash/get"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es.array.reverse.js","core-js/modules/es.array.reduce.js","lodash/get","lodash/set"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).intervals={},null,null,e.get,e.set)}(this,(function(e,t,s,n,r){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=i(n),a=i(r);function c(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var l={exports:{}},u={exports:{}};!function(e){e.exports=function(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e},e.exports.default=e.exports,e.exports.__esModule=!0}(u),function(e){var t=u.exports;function s(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}e.exports=function(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?s(Object(r),!0).forEach((function(s){t(e,s,r[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e},e.exports.default=e.exports,e.exports.__esModule=!0}(l);var d=c(l.exports);function f(e,t,s){let n={};if(t){const r=t.split("."),i=r.shift(),a=`${r.join(".")}.${s}`,c=e.getItem(i);n=o.default(c,a,n)}else n=e.getItem(s)||n;return n}function m(e,t,s,n,r){const i=f(e,t,s)||{},{customColsSchema:o,defaultColsSchema:c}=function(e){return{customColsSchema:d(d({},e.schemas),{},{_default:void 0,_protocol:void 0,_unsaved:void 0}),defaultColsSchema:{activeSchema:e.activeSchema,schemas:{_default:e.schemas._default,_protocol:e.schemas._protocol,_unsaved:e.schemas._unsaved}}}}(r);if(i[n]=c,i["custom-cols-schemas"]=d({},o),t){const n=t.split("."),r=n.shift(),o=`${n.join(".")}.${s}`,c=e.getItem(r)||{};a.default(c,o,i),e.set(r,c)}else e.set(s,i)}const g=["begin","end","duration","timestamp","id"];function v({Vue:e,LocalStorage:t,errorHandler:s,logger:n}){function r(){const e=(new Date).toString().match(/([-+][0-9]+)\s/)[1];return g.reduce(((t,s)=>(t[s]={name:s},(s.match(/timestamp$/)||"begin"===s||"end"===s)&&(t[s].addition=`${e.slice(0,3)}:${e.slice(3)}`,t[s].type="",t[s].unit=""),t)),{})}function i(e,t){t.errors?(e("reqError",t.errors),t.errors.forEach((e=>{const t=new Error(e.reason);s&&s(t)}))):e("reqFullfiled")}async function o({state:t,commit:n,rootState:r},o){let a=[];if(n("reqStart"),r.token&&t.active&&t.activeDevice)try{e.set(t,"isLoading",!0);const s=await e.connector.gw.getCalcsDevicesIntervals(t.active,t.activeDevice,"all",{data:JSON.stringify(o)});n("reqStart",{endpoint:"getCalcsDevicesIntervals",active:t.active,device:t.activeDevice,data:JSON.stringify(o)});const r=s.data;i(n,r),a=r.result,e.set(t,"isLoading",!1)}catch(n){s&&s(n),DEV&&console.log(n),e.set(t,"isLoading",!1)}return a}let a=[],c=0;function l(t){return setInterval((()=>{a.length&&(a.forEach((s=>((t,s)=>{const n=JSON.parse(s.payload);switch(s.topic.split("/").slice(-1)[0]){case"created":{const s=t.begin,r=t.end,i=new Date(r),o=1e3*n.begin,a=1e3*n.end,c=new Date,l=i.getDate()===c.getDate()&&i.getMonth()===c.getMonth()&&i.getFullYear()===c.getFullYear();(o<=r&&a>=s||l)&&e.set(t.messages,n.id,n);break}case"updated":case"finished":t.messages[n.id]&&e.set(t.messages,n.id,n);break;case"deleted":t.messages[n.id]&&e.delete(t.messages,n.id)}})(t,s))),a=[])}),500)}return{getMessages:o,get:async function({state:e,commit:t,rootState:s}){t("setMessages",await o({state:e,commit:t,rootState:s},function(e){const t={};return e.limit&&(t.count=e.limit),e.filter&&e.sysFilter?t.filter=`${e.sysFilter},${e.filter}`:e.sysFilter&&!e.filter?t.filter=`${e.sysFilter}`:!e.sysFilter&&e.filter&&(t.filter=`${e.filter}`),e.begin&&!e.reverse&&(e.reverse||(t.begin=Math.floor(e.begin/1e3))),e.end&&(t.end=Math.floor(e.end/1e3)),e.reverse&&(t.reverse=e.reverse),t}(e)))},pollingGet:async function({state:t,commit:s}){c=l(t),await e.connector.subscribeIntervals(t.active,t.activeDevice,"+",((e,t,s)=>{a.push(s)}),{rh:2}),n.info(`subscribed to Intervals ${t.active} - ${t.activeDevice}`)},initTime:async function({state:t,commit:n,rootState:r}){if(r.token&&t.active&&t.activeDevice)try{e.set(t,"isLoading",!0);const s={reverse:!0,count:1,fields:"end,begin"},r=await e.connector.gw.getCalcsDevicesIntervals(t.active,t.activeDevice,"all",{data:JSON.stringify(s)});n("reqStart",{endpoint:"getCalcsDevicesIntervals-initTime",active:t.active,device:t.activeDevice,data:JSON.stringify(s)});const o=r.data;i(n,o);let a=Date.now(),c=Date.now();o.result.length&&(a=Math.round(1e3*o.result[0].begin),c=Math.round(1e3*o.result[0].end)),a=new Date(a),a.setHours(0,0,0,0),c=new Date(c),c.setHours(23,59,59,999),n("setBegin",a.valueOf()),n("setEnd",c.valueOf()+.999),e.set(t,"isLoading",!1)}catch(n){s&&s(n),DEV&&console.log(n),e.set(t,"isLoading",!1)}},unsubscribePooling:async function({state:t}){c&&clearInterval(c),await e.connector.unsubscribeIntervals(t.active,t.activeDevice,"+"),n.info(`unsubscribed to Intervals ${t.active} - ${t.activeDevice}`)},getCols:async function({state:e,commit:s},n){let i=f(t,e.lsNamespace,e.name);i=i[e.active];const o=i||{activeSchema:"_default",schemas:{_default:{name:"_default",cols:g.map((e=>({name:e,width:150})))},_protocol:{name:"_protocol",cols:g.map((e=>({name:e,width:150})))}},enum:r()},a=i&&i["custom-cols-schemas"]?i["custom-cols-schemas"]:{};o.enum||(o.enum=r()),o.schemas=d(d({},o.schemas),a);const c=(new Date).toString().match(/([-+][0-9]+)\s/)[1];n.forEach((e=>{const t=e.name,s={name:t,description:`${e.name}[${e.type}]`},n={name:t,width:100};(t.match(/timestamp$/)||"begin"===t||"end"===t)&&(s.addition=`${c.slice(0,3)}:${c.slice(3)}`,s.type="",s.unit="",n.width=190),o.schemas._protocol.cols.push(n),o.enum[t]=s})),o.schemas._protocol.cols.push({name:"etc",width:150,__dest:"etc"}),!i&&o.schemas._default.cols.push({name:"etc",width:150,__dest:"etc"}),o.enum.etc={name:"etc",__dest:"etc"},s("setCols",o)}}}e.default=function({Vue:e,LocalStorage:t,name:s,errorHandler:n,newMessagesInterseptor:r}){const i=o.default(s,"lsNamespace",void 0);s=o.default(s,"name",s);const a=e.$logger.extendName(s),c=v({Vue:e,LocalStorage:t,errorHandler:n,logger:a}),l=function({Vue:e,LocalStorage:t,newMessagesInterseptor:s,logger:n}){function r(t){e.set(t,"messages",[]),s&&s([]),o(t),n.info("clearMessages")}function i(s,n){m(t,s.lsNamespace,s.name,s.active,n),e.set(s,"cols",n)}function o(t){e.set(t,"selected",[])}return{setMessages:function(t,r){if(r&&r.length){t.reverse&&r.reverse();let n=t.messages;s&&s(r),n=r.reduce(((e,t)=>(e[t.id]=t,e)),{}),e.set(t,"messages",n)}else e.set(t,"messages",[]);n.info(`setMessages: length: ${r.length}`)},clearMessages:r,setLimit:function(t,s){e.set(t,"limit",s)},setFilter:function(t,s){t.filter!==s&&e.set(t,"filter",s),n.info(`setFilter: ${s}`)},setBegin:function(t,s){e.set(t,"begin",s),n.info(`setBegin: ${s}`)},setEnd:function(t,s){e.set(t,"end",s),n.info(`setEnd: ${s}`)},reqStart:function(e,t){n.info(`reqStart: ${JSON.stringify(t)}`)},reqFullfiled:function(){n.info("reqFullfiled")},reqError:function(e,t){n.info(`reqError: ${JSON.stringify(t)}`)},setReverse:function(t,s){e.set(t,"reverse",s),n.info(`setReverse: ${s}`)},clear:async function(t){r(t),t.filter="",t.begin=0,t.end=0,t.limit=1e3,t.reverse=!1,await e.connector.unsubscribeIntervals(t.active),n.info("clear module"),n.info(`unsubscribeIntervals ${t.active}`)},setActive:function(t,s){t.newMessagesCount=0,e.set(t,"active",s),n.info(`setActive: ${s}`)},setCols:i,updateCols:i,setSelected:function(t,s){e.set(t,"selected",s)},clearSelected:o,setSortBy:function(t,s){e.set(t,"sortBy",s)},clearSortBy:function(t){e.set(t,"sortBy",null)},setActiveDevice:function(t,s){e.set(t,"activeDevice",s),n.info(`setActiveDevice: ${s}`)}}}({Vue:e,LocalStorage:t,newMessagesInterseptor:r,logger:a});return{namespaced:!0,state:{name:s,lsNamespace:i,isLoading:!1,active:0,activeDevice:0,messages:{},filter:"",sysFilter:"",begin:Date.now()-864e5,end:Date.now(),limit:1e3,reverse:!1,cols:void 0,selected:[],sortBy:null},actions:c,mutations:l}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=intervals.js.map
