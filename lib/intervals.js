!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.function.name"),require("@babel/runtime-corejs2/regenerator"),require("regenerator-runtime/runtime"),require("core-js/library/fn/promise"),require("core-js/modules/es6.regexp.split"),require("lodash/get"),require("core-js/modules/es7.array.includes"),require("core-js/library/fn/array/is-array"),require("core-js/library/fn/array/from"),require("core-js/library/fn/is-iterable"),require("lodash/set")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.function.name","@babel/runtime-corejs2/regenerator","regenerator-runtime/runtime","core-js/library/fn/promise","core-js/modules/es6.regexp.split","lodash/get","core-js/modules/es7.array.includes","core-js/library/fn/array/is-array","core-js/library/fn/array/from","core-js/library/fn/is-iterable","lodash/set"],t):t((e=e||self).intervals={},0,e._regeneratorRuntime,0,e.promise$1,0,e.get,0,e.isArray$1,e.from,e.isIterable$1,e.set)}(this,function(e,t,p,r,n,s,v,a,i,o,c,l){"use strict";p=p&&p.hasOwnProperty("default")?p.default:p,n=n&&n.hasOwnProperty("default")?n.default:n,v=v&&v.hasOwnProperty("default")?v.default:v,i=i&&i.hasOwnProperty("default")?i.default:i,o=o&&o.hasOwnProperty("default")?o.default:o,c=c&&c.hasOwnProperty("default")?c.default:c,l=l&&l.hasOwnProperty("default")?l.default:l;var u=n;function f(e,t,r,n,s,a,i){try{var o=e[a](i),c=o.value}catch(e){return void r(e)}o.done?t(c):u.resolve(c).then(n,s)}var m=function(o){return function(){var e=this,i=arguments;return new u(function(t,r){var n=o.apply(e,i);function s(e){f(n,t,r,s,a,"next",e)}function a(e){f(n,t,r,s,a,"throw",e)}s(void 0)})}};function d(e){var u=e.Vue,o=e.LocalStorage,l=e.errorHandler;function f(e){e.errors&&e.errors.forEach(function(e){var t=new Error(e.reason);l&&l(t)})}function t(){return(t=m(p.mark(function e(t){var r,n,s,a,i,o,c;return p.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.state,n=t.commit,t.rootState.token&&r.active&&r.activeDevice)return e.prev=2,u.set(r,"isLoading",!0),s={reverse:!0,count:1,fields:"end,begin"},e.next=7,u.connector.gw.getCalcsDevicesIntervals(r.active,r.activeDevice,"all",{data:JSON.stringify(s)});e.next=26;break;case 7:a=e.sent,f(i=a.data),o=Date.now(),c=Date.now(),i.result.length&&(o=Math.round(1e3*i.result[0].begin),c=Math.round(1e3*i.result[0].end)),(o=new Date(o)).setHours(0,0,0,0),(c=new Date(c)).setHours(23,59,59,999),n("setBegin",o.valueOf()),n("setEnd",c.valueOf()),u.set(r,"isLoading",!1),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(2),l&&l(e.t0),DEV&&console.log(e.t0),u.set(r,"isLoading",!1);case 26:case"end":return e.stop()}},e,null,[[2,21]])}))).apply(this,arguments)}function r(){return(r=m(p.mark(function e(n){var s,a,i,o,c;return p.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=n.state,a=n.commit,i=n.rootState,a("reqStart"),i.token&&s.active&&s.activeDevice)return e.prev=3,u.set(s,"isLoading",!0),e.next=7,u.connector.gw.getCalcsDevicesIntervals(s.active,s.activeDevice,"all",{data:JSON.stringify((r=void 0,r={},(t=s).limit&&(r.count=t.limit),t.filter&&t.sysFilter?r.filter="".concat(t.sysFilter,",").concat(t.filter):t.sysFilter&&!t.filter?r.filter="".concat(t.sysFilter):!t.sysFilter&&t.filter&&(r.filter="".concat(t.filter)),t.begin&&!t.reverse&&(t.reverse||(r.begin=Math.floor(t.begin/1e3))),t.end&&(r.end=Math.floor(t.end/1e3)),t.reverse&&(r.reverse=t.reverse),r))});e.next=19;break;case 7:o=e.sent,f(c=o.data),a("setMessages",c.result),u.set(s,"isLoading",!1),e.next=19;break;case 14:e.prev=14,e.t0=e.catch(3),l&&l(e.t0),DEV&&console.log(e.t0),u.set(s,"isLoading",!1);case 19:case"end":return e.stop()}var t,r},e,null,[[3,14]])}))).apply(this,arguments)}var n=function(e,t){var r=JSON.parse(t.payload);switch(t.topic.split("/").slice(-1)[0]){case"created":var n=e.begin,s=e.end,a=new Date(s),i=1e3*r.begin,o=1e3*r.end,c=new Date,l=a.getDate()===c.getDate()&&a.getMonth()===c.getMonth()&&a.getFullYear()===c.getFullYear();(i<=s&&n<=o||l)&&u.set(e.messages,r.id,r);break;case"updated":case"finished":e.messages[r.id]&&u.set(e.messages,r.id,r);break;case"deleted":e.messages[r.id]&&u.delete(e.messages,r.id)}},s=[],a=0;function i(t){return setInterval(function(){s.length&&(s.forEach(function(e){return n(t,e)}),s=[])},500)}function c(){return(c=m(p.mark(function e(t){var r;return p.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,t.commit,a=i(r),e.next=4,u.connector.subscribeIntervals(r.active,r.activeDevice,"+",function(e,t,r){s.push(r)},{rh:2});case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}function d(){return(d=m(p.mark(function e(t){var r;return p.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.state,a&&clearInterval(a),e.next=4,u.connector.unsubscribeIntervals(r.active,r.activeDevice,"+");case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}return{get:function(e){return r.apply(this,arguments)},pollingGet:function(e){return c.apply(this,arguments)},initTime:function(e){return t.apply(this,arguments)},unsubscribePooling:function(e){return d.apply(this,arguments)},getCols:function(e,t){var r=e.state,n=e.commit,s=[],a=function(e){var t={};if(e.lsNamespace){var r=o.getItem(e.name);r&&(t=r,o.remove(e.name));var n=e.lsNamespace.split("."),s=n.shift(),a="".concat(n.join("."),".").concat(e.name),i=o.getItem(s);t=v(i,a,t)}else t=o.getItem(e.name)||t;return t}(r);a&&a[r.active]&&a[r.active].length?((s=(s=a[r.active]).filter(function(e){return!e.__dest}))[0].__dest||s[s.length-1].__dest||(s.unshift({name:"actions",width:100,display:!0,__dest:"action"}),s.push({name:"etc",width:150,display:!0,__dest:"etc"})),n("updateCols",s)):(t.unshift({name:"actions",width:100,display:!0,__dest:"action"}),t.push({name:"etc",width:150,display:!0,__dest:"etc"}),n("setCols",t))}}}var g=i;var h=function(e){if(g(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}},y=o,b=c;var w=function(e){if(b(Object(e))||"[object Arguments]"===Object.prototype.toString.call(e))return y(e)};var D=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var j=function(e){return h(e)||w(e)||D()},x=["begin","end","duration","timestamp","id"];function I(e){var a=e.Vue,o=e.LocalStorage,n=(e.filterHandler,e.newMessagesInterseptor);function r(e){a.set(e,"messages",[]),n&&n([]),c(e)}function t(){return(t=m(p.mark(function e(t){return p.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r(t),t.filter="",t.begin=0,t.end=0,t.limit=1e3,t.reverse=!1,e.next=8,a.connector.unsubscribeIntervals(t.active);case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}function i(e,t){var r=function(e){var t={};if(e.lsNamespace){var r=e.lsNamespace.split("."),n=r.shift(),s="".concat(r.join("."),".").concat(e.name),a=o.getItem(n);t=v(a,s,t)}else t=o.getItem(e.name)||t;return t}(e);if(r[e.active]=t,e.lsNamespace){var n=e.lsNamespace.split("."),s=n.shift(),a="".concat(n.join("."),".").concat(e.name),i=o.getItem(s);l(i,a,r),o.set(s,i)}else o.set(e.name,r)}function s(e,t){i(e,t),a.set(e,"cols",t)}function c(e){a.set(e,"selected",[])}return{setMessages:function(e,t){if(t&&t.length){e.reverse&&t.reverse();var r=e.messages;n&&n(t),r=t.reduce(function(e,t){return e[t.id]=t,e},{}),a.set(e,"messages",r)}else a.set(e,"messages",[])},clearMessages:r,setLimit:function(e,t){a.set(e,"limit",t)},setFilter:function(e,t){e.filter!==t&&a.set(e,"filter",t)},setBegin:function(e,t){a.set(e,"begin",t)},setEnd:function(e,t){a.set(e,"end",t)},reqStart:function(){DEV&&console.log("Start Request intervals messages")},setReverse:function(e,t){a.set(e,"reverse",t)},clear:function(e){return t.apply(this,arguments)},setActive:function(e,t){e.newMessagesCount=0,a.set(e,"active",t)},setCols:function(e,t){var r=[{name:"begin",title:"begin",width:170,display:!0,description:"Begin of interval"},{name:"end",width:170,display:!0,description:"End of interval"},{name:"duration",width:85,display:!0,description:"Duration of interval"},{name:"timestamp",width:170,display:!0,description:"Interval timestamp"},{name:"id",width:50,display:!0,description:"ID of interval"}],n=t.shift(),s=t.pop();t.forEach(function(e){a.set(e,"width",100),a.set(e,"display",!0),a.set(e,"description","".concat(e.name,"[").concat(e.type,"]")),r.push(e)}),i(e,r=[n].concat(j(r),[s])),a.set(e,"cols",r)},updateCols:s,setDefaultCols:function(r){r.cols.forEach(function(e,t){e.__dest||(x.includes(e.name)?a.set(r.cols[t],"display",!0):a.set(r.cols[t],"display",!1))}),s(r,r.cols)},setSelected:function(e,t){a.set(e,"selected",t)},clearSelected:c,setSortBy:function(e,t){a.set(e,"sortBy",t)},clearSortBy:function(e){a.set(e,"sortBy",null)},setActiveDevice:function(e,t){a.set(e,"activeDevice",t)}}}e.default=function(e){var t=e.Vue,r=e.LocalStorage,n=e.name,s=e.errorHandler,a=e.filterHandler,i=e.newMessagesInterseptor,o=v(n,"lsNamespace",void 0);n=v(n,"name",n);var c=d({Vue:t,LocalStorage:r,errorHandler:s}),l=I({Vue:t,LocalStorage:r,filterHandler:a,newMessagesInterseptor:i});return{namespaced:!0,state:{name:n,lsNamespace:o,isLoading:!1,active:0,activeDevice:0,messages:{},filter:"",sysFilter:"",begin:Date.now()-864e5,end:Date.now(),limit:1e3,reverse:!1,cols:[],selected:[],sortBy:null},actions:c,mutations:l}},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=intervals.js.map
